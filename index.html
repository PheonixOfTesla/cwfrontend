<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ClockWork - AI fitness coaching for elite athletes and beginners alike.">
    <meta name="theme-color" content="#f97316">
    <title>ClockWork - AI Fitness Coaching</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ClockWork">
    <link rel="icon" type="image/png" href="/forge.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clockwork: { orange: '#f97316', dark: '#0a0a0a', darker: '#050505' }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); transform: translateZ(0); will-change: transform; }
        .glass-dark { background: rgba(0,0,0,0.4); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); transform: translateZ(0); }
        .glow { box-shadow: 0 0 30px rgba(249, 115, 22, 0.3); }
        .glow-text { text-shadow: 0 0 20px rgba(249, 115, 22, 0.5); }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(249, 115, 22, 0.3); } 50% { box-shadow: 0 0 40px rgba(249, 115, 22, 0.6); } }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; will-change: box-shadow; }
        .progress-ring { transform: rotate(-90deg); }
        .chat-bubble { max-width: 85%; }
        .ring-progress { transition: stroke-dashoffset 0.5s ease-in-out; }
        .calendar-day { transition: all 0.2s ease; }
        .calendar-day:hover { background: rgba(249, 115, 22, 0.2); }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); }
        @keyframes breathe { 0%, 100% { transform: scale(1) translateZ(0); opacity: 0.8; } 50% { transform: scale(1.05) translateZ(0); opacity: 1; } }
        .animate-breathe { animation: breathe 4s ease-in-out infinite; will-change: transform, opacity; }
        .metric-ring { filter: drop-shadow(0 0 10px rgba(249, 115, 22, 0.4)); }
        .expandable { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .expandable.open { max-height: 500px; }

        /* LIGHTNING ANIMATIONS */
        @keyframes lightning-strike {
            0%, 100% { opacity: 0; }
            5% { opacity: 1; }
            10% { opacity: 0.3; }
            15% { opacity: 1; }
            20% { opacity: 0; }
        }
        @keyframes lightning-glow {
            0%, 100% { filter: drop-shadow(0 0 5px #f97316) drop-shadow(0 0 10px #f97316); }
            50% { filter: drop-shadow(0 0 20px #f97316) drop-shadow(0 0 40px #f97316) drop-shadow(0 0 60px #fff); }
        }
        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; text-shadow: 0 0 10px #f97316, 0 0 20px #f97316, 0 0 30px #f97316; }
            20%, 24%, 55% { opacity: 0.5; text-shadow: none; }
        }
        @keyframes electric-pulse {
            0%, 100% { transform: scale(1) translateZ(0); filter: brightness(1); }
            50% { transform: scale(1.02) translateZ(0); filter: brightness(1.3); }
        }
        .lightning-icon {
            animation: lightning-glow 2s ease-in-out infinite, electric-pulse 1.5s ease-in-out infinite;
            will-change: transform, filter;
        }
        .lightning-text {
            animation: flicker 3s linear infinite;
        }
        .lightning-strike {
            position: absolute;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, #f97316, #fff, #f97316, transparent);
            animation: lightning-strike 4s infinite;
            opacity: 0;
        }
        .lightning-container {
            position: relative;
            overflow: hidden;
        }
        .lightning-container::before,
        .lightning-container::after {
            content: '';
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, #f97316, #fff, #f97316, transparent);
            animation: lightning-strike 4s infinite;
            opacity: 0;
        }
        .lightning-container::before { left: 20%; animation-delay: 0.5s; }
        .lightning-container::after { right: 20%; animation-delay: 2s; }

        /* CLOCKWORK LOGO */
        .clockwork-logo {
            font-family: 'SF Pro Display', -apple-system, sans-serif;
            font-weight: 700;
            letter-spacing: 2px;
        }
        .clockwork-logo .clock-letter {
            display: inline-block;
            position: relative;
        }
        @keyframes tick {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(6deg); }
        }
        .clock-hand {
            animation: tick 1s steps(1) infinite;
            transform-origin: bottom center;
        }

        /* SLOW REALISTIC FORGE HAMMER ANIMATION */
        @keyframes forge-hammer-slow {
            0%, 100% {
                transform: rotate(-15deg) translateY(-2px);
                opacity: 1;
            }
            50% {
                transform: rotate(25deg) translateY(8px);
                opacity: 0.9;
            }
        }
        .forge-hammering-slow {
            animation: forge-hammer-slow 1.8s cubic-bezier(0.34, 1.56, 0.64, 1) infinite;
            display: inline-block;
            transform-origin: 30% 20%;
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(249, 115, 22, 0.3));
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_URL = 'https://cwbackend-production-314e.up.railway.app/api';

        const API_TIMEOUT = 30000; // 30 second timeout
        const AI_TIMEOUT = 120000; // 2 minute timeout for AI generation

        const api = {
            async fetch(endpoint, options = {}, customTimeout = null) {
                const controller = new AbortController();
                const timeout = customTimeout || API_TIMEOUT;
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_URL}${endpoint}`, {
                        ...options,
                        signal: controller.signal,
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token && { 'Authorization': `Bearer ${token}` }),
                            ...options.headers
                        }
                    });
                    clearTimeout(timeoutId);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Request failed');
                    return data;
                } catch (err) {
                    clearTimeout(timeoutId);
                    if (err.name === 'AbortError') {
                        throw new Error('Request timed out. Please check your connection and try again.');
                    }
                    throw err;
                }
            },
            get: (endpoint, customTimeout) => api.fetch(endpoint, {}, customTimeout),
            post: (endpoint, body, customTimeout) => api.fetch(endpoint, { method: 'POST', body: JSON.stringify(body) }, customTimeout),
            put: (endpoint, body, customTimeout) => api.fetch(endpoint, { method: 'PUT', body: JSON.stringify(body) }, customTimeout),
            delete: (endpoint) => api.fetch(endpoint, { method: 'DELETE' })
        };

        // Chat storage helper
        const chatStorage = {
            get: () => {
                try {
                    return JSON.parse(localStorage.getItem('forge_chat') || '[]');
                } catch { return []; }
            },
            set: (messages) => localStorage.setItem('forge_chat', JSON.stringify(messages)),
            clear: () => localStorage.removeItem('forge_chat')
        };

        // Onboarding storage helper
        const onboardingStorage = {
            get: () => {
                try {
                    return JSON.parse(localStorage.getItem('clockwork_onboarding') || 'null');
                } catch { return null; }
            },
            set: (data) => localStorage.setItem('clockwork_onboarding', JSON.stringify(data)),
            clear: () => localStorage.removeItem('clockwork_onboarding')
        };

        // ============================================
        // SOCKET.IO MANAGER
        // ============================================
        let socketInstance = null;

        const getSocket = () => {
            if (!socketInstance) {
                const token = localStorage.getItem('token');
                if (!token) return null;

                socketInstance = io(API_URL, {
                    auth: { token },
                    transports: ['websocket', 'polling']
                });

                socketInstance.on('connect', () => {
                    console.log('[Socket] Connected:', socketInstance.id);
                });

                socketInstance.on('disconnect', () => {
                    console.log('[Socket] Disconnected');
                });

                socketInstance.on('connect_error', (err) => {
                    console.error('[Socket] Connection error:', err.message);
                });
            }
            return socketInstance;
        };

        const disconnectSocket = () => {
            if (socketInstance) {
                socketInstance.disconnect();
                socketInstance = null;
            }
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('loading');

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);

                // Handle wearable OAuth callbacks BEFORE checkAuth
                if (params.get('wearable_connected')) {
                    setTimeout(() => alert(`✓ ${params.get('wearable_connected')} connected successfully!`), 500);
                    window.history.replaceState({}, '', window.location.pathname);
                }
                if (params.get('wearable_error')) {
                    setTimeout(() => alert(`⚠️ Connection failed: ${params.get('wearable_error')}`), 500);
                    window.history.replaceState({}, '', window.location.pathname);
                }

                // Check auth status
                checkAuth();
            }, []);

            const checkAuth = async () => {
                const token = localStorage.getItem('token');
                if (!token) {
                    // Always show landing page for non-authenticated users
                    setLoading(false);
                    setView('landing');
                    return;
                }
                try {
                    const data = await api.get('/users/profile');
                    const userData = data.user || data.data || data;
                    setUser(userData);
                    // Coaches skip onboarding - go straight to app
                    if (userData.userType === 'coach') {
                        setView('app');
                    } else {
                        // Clients and individuals need onboarding for fitness goals
                        setView(userData.onboarding?.completed ? 'app' : 'onboarding');
                    }
                } catch (err) {
                    localStorage.removeItem('token');
                    setView('auth');
                }
                setLoading(false);
            };

            const handleLogin = (userData) => {
                setUser(userData);
                // Coaches skip onboarding - go straight to app
                if (userData.userType === 'coach') {
                    setView('app');
                } else {
                    // Clients and individuals need onboarding for fitness goals
                    setView(userData.onboarding?.completed ? 'app' : 'onboarding');
                }
            };

            const handleOnboardingComplete = (updatedUser) => { setUser(updatedUser); setView('app'); };
            const handleLogout = () => { localStorage.removeItem('token'); chatStorage.clear(); setUser(null); setView('landing'); };

            if (loading) return <LoadingScreen />;
            if (view === 'landing') return <LandingPage onGetStarted={() => setView('auth')} />;
            if (view === 'auth') return <AuthScreen onLogin={handleLogin} />;
            if (view === 'onboarding') return <OnboardingFlow user={user} onComplete={handleOnboardingComplete} />;
            return <MainApp user={user} setUser={setUser} onLogout={handleLogout} />;
        };

        // ClockWork Logo Component with ticking clock
        const ClockWorkLogo = ({ size = 'md', showLightning = true }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            const seconds = time.getSeconds();
            const minutes = time.getMinutes();
            const sizeClasses = { sm: 'text-xl', md: 'text-2xl', lg: 'text-4xl', xl: 'text-5xl' };
            const clockSize = { sm: 20, md: 28, lg: 40, xl: 56 };
            const sz = clockSize[size] || 28;

            return (
                <div className="flex items-center gap-2">
                    {showLightning && <i className="fas fa-bolt text-orange-500 lightning-icon" style={{ fontSize: sz * 0.8 }}></i>}
                    <span className={`clockwork-logo ${sizeClasses[size]} text-white lightning-text`}>
                        cl<span className="relative inline-block">
                            <svg width={sz * 0.7} height={sz * 0.7} viewBox="0 0 24 24" className="inline-block align-middle">
                                <circle cx="12" cy="12" r="10" stroke="#f97316" strokeWidth="2" fill="none" />
                                <line x1="12" y1="12" x2="12" y2="6" stroke="#f97316" strokeWidth="2" strokeLinecap="round" style={{ transform: `rotate(${minutes * 6}deg)`, transformOrigin: '12px 12px' }} />
                                <line x1="12" y1="12" x2="12" y2="4" stroke="#fff" strokeWidth="1.5" strokeLinecap="round" className="clock-hand" style={{ transform: `rotate(${seconds * 6}deg)`, transformOrigin: '12px 12px' }} />
                                <circle cx="12" cy="12" r="1.5" fill="#f97316" />
                            </svg>
                        </span>ckw<span className="relative inline-block">
                            <svg width={sz * 0.7} height={sz * 0.7} viewBox="0 0 24 24" className="inline-block align-middle">
                                <circle cx="12" cy="12" r="10" stroke="#f97316" strokeWidth="2" fill="none" />
                                <line x1="12" y1="12" x2="12" y2="6" stroke="#f97316" strokeWidth="2" strokeLinecap="round" style={{ transform: `rotate(${minutes * 6}deg)`, transformOrigin: '12px 12px' }} />
                                <line x1="12" y1="12" x2="12" y2="4" stroke="#fff" strokeWidth="1.5" strokeLinecap="round" className="clock-hand" style={{ transform: `rotate(${seconds * 6}deg)`, transformOrigin: '12px 12px' }} />
                                <circle cx="12" cy="12" r="1.5" fill="#f97316" />
                            </svg>
                        </span>rk
                    </span>
                </div>
            );
        };

        // Landing Page Component
        const LandingPage = ({ onGetStarted }) => {
            const videoRef = useRef(null);
            const audioRef = useRef(null);
            const [audioPlaying, setAudioPlaying] = useState(false);

            useEffect(() => {
                // Auto-play video
                if (videoRef.current) {
                    videoRef.current.play().catch(e => console.log('Video autoplay prevented'));
                }
                // Try to auto-play audio (will fail on most browsers, but worth trying)
                if (audioRef.current) {
                    audioRef.current.play()
                        .then(() => setAudioPlaying(true))
                        .catch(e => console.log('Audio autoplay prevented - user can click button'));
                }
            }, []);

            const toggleAudio = () => {
                if (audioRef.current) {
                    if (audioPlaying) {
                        audioRef.current.pause();
                        setAudioPlaying(false);
                    } else {
                        audioRef.current.play().catch(e => console.log('Audio play failed'));
                        setAudioPlaying(true);
                    }
                }
            };

            const handleGetStarted = () => {
                // Try to start audio on user interaction if not already playing
                if (audioRef.current && !audioPlaying) {
                    audioRef.current.play()
                        .then(() => setAudioPlaying(true))
                        .catch(e => console.log('Audio play failed'));
                }
                onGetStarted();
            };

            const features = [
                {
                    icon: 'fa-bolt',
                    title: 'FORGE AI Coach',
                    description: 'Your personal AI fitness coach that learns from you and adapts to your needs 24/7'
                },
                {
                    icon: 'fa-calendar-alt',
                    title: 'Smart Programming',
                    description: 'Custom workout programs that adapt to your recovery, goals, and competition schedule'
                },
                {
                    icon: 'fa-chart-line',
                    title: 'Recovery Tracking',
                    description: 'Integrate with Google Fitbit for AI-powered recovery insights'
                },
                {
                    icon: 'fa-utensils',
                    title: 'Nutrition Planning',
                    description: 'AI-generated meal plans that align with your training goals and dietary preferences'
                },
                {
                    icon: 'fa-dumbbell',
                    title: 'Exercise Library',
                    description: '633 exercise demonstrations with video tutorials and proper form cues'
                },
                {
                    icon: 'fa-trophy',
                    title: 'Competition Prep',
                    description: 'Specialized programming for powerlifters, bodybuilders, and competitive athletes'
                }
            ];

            return (
                <div className="relative min-h-screen overflow-hidden bg-black">
                    {/* Video Background */}
                    <video
                        ref={videoRef}
                        className="absolute inset-0 w-full h-full object-cover"
                        autoPlay
                        loop
                        muted
                        playsInline
                        preload="auto"
                        webkit-playsinline="true"
                        x-webkit-airplay="allow"
                        style={{ willChange: 'transform' }}
                    >
                        <source src="/workout-video.mp4" type="video/mp4" />
                        <source src="/workout-video.mp4" type="video/quicktime" />
                    </video>

                    {/* Dark Overlay */}
                    <div className="absolute inset-0 bg-black/70"></div>

                    {/* Background Music */}
                    <audio ref={audioRef} loop preload="auto">
                        <source src="/house-music.mp3" type="audio/mpeg" />
                    </audio>

                    {/* Content */}
                    <div className="relative z-10 min-h-screen flex flex-col">
                        {/* Header */}
                        <nav className="p-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <i className="fas fa-bolt text-4xl text-orange-500 lightning-icon"></i>
                                    <span className="text-3xl font-bold text-white lightning-text">
                                        cl<i className="fas fa-clock text-orange-500" style={{fontSize: '0.8em'}}></i>ckw<i className="fas fa-clock text-orange-500" style={{fontSize: '0.8em'}}></i>rk
                                    </span>
                                </div>
                                <button
                                    onClick={toggleAudio}
                                    className="glass p-3 rounded-full hover:bg-white/20 transition-all"
                                    title={audioPlaying ? "Mute Music" : "Play Music"}
                                >
                                    <i className={`fas ${audioPlaying ? 'fa-volume-up' : 'fa-volume-mute'} text-white text-xl`}></i>
                                </button>
                            </div>
                        </nav>

                        {/* Hero Section */}
                        <div className="flex-1 flex items-center justify-center px-6">
                            <div className="max-w-6xl w-full text-center">
                                <h1 className="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight">
                                    Elite Coaching for
                                    <span className="text-orange-500 lightning-text"> Everyone</span>
                                </h1>
                                <p className="text-xl md:text-2xl text-gray-300 mb-12 max-w-3xl mx-auto">
                                    AI-powered fitness coaching that adapts to your goals, recovery, and lifestyle.
                                    From beginners to competitive athletes.
                                </p>
                                <button
                                    onClick={handleGetStarted}
                                    className="bg-orange-500 hover:bg-orange-600 text-white px-12 py-4 rounded-xl text-xl font-bold transition-all transform hover:scale-105 animate-pulse-glow"
                                >
                                    Get Started <i className="fas fa-arrow-right ml-2"></i>
                                </button>
                                <p className="text-gray-400 mt-4">24-hour free trial • $9.99/mo after</p>
                            </div>
                        </div>

                        {/* Features Grid */}
                        <div className="pb-20 px-6">
                            <div className="max-w-6xl mx-auto">
                                <h2 className="text-3xl md:text-4xl font-bold text-white mb-12 text-center">
                                    Everything You Need to <span className="text-orange-500">Dominate</span>
                                </h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {features.map((feature, idx) => (
                                        <div key={idx} className="glass p-6 rounded-xl hover:glow transition-all">
                                            <i className={`fas ${feature.icon} text-4xl text-orange-500 mb-4`}></i>
                                            <h3 className="text-xl font-bold text-white mb-2">{feature.title}</h3>
                                            <p className="text-gray-400">{feature.description}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Footer CTA */}
                        <div className="pb-12 px-6 text-center">
                            <button
                                onClick={handleGetStarted}
                                className="bg-white text-black px-10 py-3 rounded-xl font-bold hover:bg-orange-500 hover:text-white transition-all"
                            >
                                Start Your Free Trial
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="min-h-screen flex items-center justify-center lightning-container">
                <div className="text-center">
                    <div className="mb-6">
                        <i className="fas fa-bolt text-7xl text-orange-500 lightning-icon"></i>
                    </div>
                    <ClockWorkLogo size="lg" showLightning={false} />
                    <p className="text-gray-400 mt-3">Elite coaching for everyone</p>
                </div>
            </div>
        );

        const AuthScreen = ({ onLogin }) => {
            const [isSignup, setIsSignup] = useState(false);
            const [signupStep, setSignupStep] = useState(1); // Multi-step signup for coaches
            const [formData, setFormData] = useState({
                name: '', email: '', password: '', confirmPassword: '', phone: '',
                userType: 'individual', coachId: '',
                // Coach-specific fields
                specialty: '', bio: '', experienceYears: '', certifications: []
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [coaches, setCoaches] = useState([]);
            // Certification input
            const [newCert, setNewCert] = useState({ name: '', organization: '', year: '' });
            // Verification state
            const [verificationMode, setVerificationMode] = useState(false);
            const [pendingToken, setPendingToken] = useState('');
            const [verificationCode, setVerificationCode] = useState('');
            const [resending, setResending] = useState(false);
            // Forgot password state
            const [forgotPasswordMode, setForgotPasswordMode] = useState(false);
            const [resetCodeMode, setResetCodeMode] = useState(false);
            const [resetCode, setResetCode] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [resetMethod, setResetMethod] = useState('email'); // 'email' or 'sms'
            const [phoneForReset, setPhoneForReset] = useState('');

            // Fetch available coaches when component mounts
            useEffect(() => {
                const fetchCoaches = async () => {
                    try {
                        const data = await api.get('/coach/list');
                        setCoaches(data.coaches || []);
                    } catch (err) {
                        console.error('Error fetching coaches:', err);
                    }
                };
                fetchCoaches();
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                // Multi-step signup for coaches
                if (isSignup && formData.userType === 'coach') {
                    if (signupStep === 1) {
                        // Validate step 1: Basic info
                        if (formData.password !== formData.confirmPassword) {
                            setError('Passwords do not match');
                            setLoading(false);
                            return;
                        }
                        if (!formData.name || !formData.email || !formData.password) {
                            setError('Please fill in all required fields');
                            setLoading(false);
                            return;
                        }
                        setSignupStep(2);
                        setLoading(false);
                        return;
                    } else if (signupStep === 2) {
                        // Validate step 2: Professional info
                        if (!formData.specialty) {
                            setError('Please enter your specialty');
                            setLoading(false);
                            return;
                        }
                        setSignupStep(3);
                        setLoading(false);
                        return;
                    }
                    // Step 3: Certifications (optional, can skip to register)
                    // Fall through to actual registration
                }

                // Single-step signup validation for clients/individuals
                if (isSignup && formData.password !== formData.confirmPassword) {
                    setError('Passwords do not match');
                    setLoading(false);
                    return;
                }
                // Validate coach selection for clients
                if (isSignup && formData.userType === 'client' && !formData.coachId) {
                    setError('Please select a coach');
                    setLoading(false);
                    return;
                }

                try {
                    const endpoint = isSignup ? '/auth/register' : '/auth/login';
                    const payload = { ...formData, email: formData.email.toLowerCase().trim() };
                    delete payload.confirmPassword; // Don't send confirm password to server

                    if (!isSignup) {
                        delete payload.phone;
                        delete payload.userType;
                        delete payload.coachId;
                        delete payload.specialty;
                        delete payload.bio;
                        delete payload.experienceYears;
                        delete payload.certifications;
                    }

                    // Clean up empty fields
                    if (!payload.phone) delete payload.phone;
                    if (!payload.coachId) delete payload.coachId;
                    if (!payload.specialty) delete payload.specialty;
                    if (!payload.bio) delete payload.bio;
                    if (!payload.experienceYears) delete payload.experienceYears;
                    if (!payload.certifications || payload.certifications.length === 0) delete payload.certifications;

                    const data = await api.post(endpoint, payload);

                    // Check if verification is required
                    if (data.requiresVerification) {
                        setPendingToken(data.pendingToken);
                        setVerificationMode(true);
                        setLoading(false);
                        return;
                    }

                    localStorage.setItem('token', data.token);
                    onLogin(data.user);
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            const handleVerify = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const data = await api.post('/auth/verify-login', { pendingToken, code: verificationCode });
                    localStorage.setItem('token', data.token);
                    onLogin(data.user);
                } catch (err) { setError(err.message); setLoading(false); }
            };

            const handleResend = async () => {
                setResending(true);
                setError('');
                try {
                    const data = await api.post('/auth/resend-verification', { email: formData.email.toLowerCase().trim() });
                    if (data.pendingToken) setPendingToken(data.pendingToken);
                    alert('New code sent to your email!');
                } catch (err) { setError(err.message); }
                setResending(false);
            };

            // Forgot Password - Request Reset Code via SMS
            const handleForgotPassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await api.post('/auth/reset-password-sms', { phone: phoneForReset.replace(/\D/g, '') });
                    setResetCodeMode(true);
                    setSuccess('Reset code sent to your phone!');
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            // Reset Password with SMS Code
            const handleResetPassword = async (e) => {
                e.preventDefault();
                if (newPassword.length < 6) { setError('Password must be at least 6 characters'); return; }
                setLoading(true);
                setError('');
                try {
                    await api.post('/auth/reset-password-sms/verify', { phone: phoneForReset.replace(/\D/g, ''), code: resetCode, newPassword });
                    setSuccess('Password reset successful! You can now login.');
                    setForgotPasswordMode(false);
                    setResetCodeMode(false);
                    setResetCode('');
                    setNewPassword('');
                    setPhoneForReset('');
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            const goBackToLogin = () => {
                setVerificationMode(false);
                setForgotPasswordMode(false);
                setResetCodeMode(false);
                setPendingToken('');
                setVerificationCode('');
                setResetCode('');
                setNewPassword('');
                setPhoneForReset('');
                setResetMethod('email');
                setError('');
                setSuccess('');
            };

            // Coach signup helpers
            const addCertification = () => {
                if (!newCert.name || !newCert.organization) return;
                setFormData(prev => ({
                    ...prev,
                    certifications: [...prev.certifications, { ...newCert }]
                }));
                setNewCert({ name: '', organization: '', year: '' });
            };

            const removeCertification = (index) => {
                setFormData(prev => ({
                    ...prev,
                    certifications: prev.certifications.filter((_, i) => i !== index)
                }));
            };

            const goBackStep = () => {
                if (signupStep > 1) {
                    setSignupStep(prev => prev - 1);
                    setError('');
                }
            };

            // Verification Code Screen
            if (verificationMode) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 lightning-container">
                        <div className="glass rounded-3xl p-8 w-full max-w-md">
                            <div className="text-center mb-8 flex flex-col items-center">
                                <div className="w-16 h-16 bg-orange-500/20 rounded-full flex items-center justify-center mb-4">
                                    <i className="fas fa-envelope text-orange-500 text-2xl"></i>
                                </div>
                                <h2 className="text-xl font-bold text-white">Check Your Email</h2>
                                <p className="text-gray-400 text-sm mt-2">We sent a 6-digit code to<br/><span className="text-orange-400">{formData.email}</span></p>
                            </div>
                            {error && <div className="bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-xl mb-4">{error}</div>}
                            <form onSubmit={handleVerify} className="space-y-4">
                                <input type="text" placeholder="Enter 6-digit code" value={verificationCode} onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-4 text-white text-center text-2xl tracking-widest placeholder-gray-500 focus:border-orange-500 focus:outline-none" maxLength={6} autoComplete="one-time-code" required />
                                <button type="submit" disabled={loading || verificationCode.length !== 6} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 glow">
                                    {loading ? 'Verifying...' : 'Verify & Sign In'}
                                </button>
                            </form>
                            <div className="mt-6 text-center space-y-3">
                                <button onClick={handleResend} disabled={resending} className="text-orange-400 hover:text-orange-300 transition-colors disabled:opacity-50">
                                    {resending ? 'Sending...' : "Didn't receive code? Resend"}
                                </button>
                                <br/>
                                <button onClick={goBackToLogin} className="text-gray-400 hover:text-white transition-colors text-sm">
                                    <i className="fas fa-arrow-left mr-2"></i>Back to login
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Forgot Password Screen (Phone Only)
            if (forgotPasswordMode) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 lightning-container">
                        <div className="glass rounded-3xl p-8 w-full max-w-md">
                            <div className="text-center mb-8 flex flex-col items-center">
                                <div className="w-16 h-16 bg-orange-500/20 rounded-full flex items-center justify-center mb-4">
                                    <i className="fas fa-mobile-alt text-orange-500 text-2xl"></i>
                                </div>
                                <h2 className="text-xl font-bold text-white">{resetCodeMode ? 'Reset Password' : 'Forgot Password'}</h2>
                                <p className="text-gray-400 text-sm mt-2">{resetCodeMode ? 'Enter the code sent to your phone' : 'Enter your phone number to receive a reset code'}</p>
                            </div>
                            {error && <div className="bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-xl mb-4">{error}</div>}
                            {success && <div className="bg-green-500/20 border border-green-500/50 text-green-400 px-4 py-3 rounded-xl mb-4">{success}</div>}

                            {!resetCodeMode ? (
                                <form onSubmit={handleForgotPassword} className="space-y-4">
                                    <input type="tel" placeholder="Phone Number" value={phoneForReset} onChange={(e) => setPhoneForReset(e.target.value.replace(/[^\d+\-() ]/g, ''))} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" required />
                                    <button type="submit" disabled={loading} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 glow">
                                        {loading ? 'Sending...' : 'Send Reset Code'}
                                    </button>
                                </form>
                            ) : (
                                <form onSubmit={handleResetPassword} className="space-y-4">
                                    <input type="text" placeholder="Enter 6-digit code" value={resetCode} onChange={(e) => setResetCode(e.target.value.replace(/\D/g, '').slice(0, 6))} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-4 text-white text-center text-2xl tracking-widest placeholder-gray-500 focus:border-orange-500 focus:outline-none" maxLength={6} autoComplete="one-time-code" required />
                                    <input type="password" placeholder="New Password (min 6 chars)" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" minLength={6} required />
                                    <button type="submit" disabled={loading || resetCode.length !== 6} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 glow">
                                        {loading ? 'Resetting...' : 'Reset Password'}
                                    </button>
                                </form>
                            )}

                            <div className="mt-6 text-center">
                                <button onClick={goBackToLogin} className="text-gray-400 hover:text-white transition-colors text-sm">
                                    <i className="fas fa-arrow-left mr-2"></i>Back to login
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center p-4 lightning-container">
                    <div className="glass rounded-3xl p-8 w-full max-w-md">
                        <div className="text-center mb-8 flex flex-col items-center">
                            <ClockWorkLogo size="lg" />
                            <p className="text-gray-400 text-sm mt-3">Elite coaching for everyone</p>
                        </div>
                        {error && <div className="bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-xl mb-4">{error}</div>}
                        {success && <div className="bg-green-500/20 border border-green-500/50 text-green-400 px-4 py-3 rounded-xl mb-4">{success}</div>}

                        {/* Progress indicator for multi-step coach signup */}
                        {isSignup && formData.userType === 'coach' && signupStep > 1 && (
                            <div className="mb-6">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-gray-400 text-sm">Step {signupStep} of 3</span>
                                    <span className="text-gray-400 text-sm">{Math.round((signupStep / 3) * 100)}%</span>
                                </div>
                                <div className="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div className="h-full bg-orange-500 transition-all duration-300" style={{ width: `${(signupStep / 3) * 100}%` }} />
                                </div>
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* STEP 1: Basic Info + User Type (All Users) */}
                            {(!isSignup || signupStep === 1) && (
                                <>
                                    {isSignup && <input type="text" placeholder="Your Name" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" required />}
                                    <input type="email" placeholder="Email" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" required />
                                    {isSignup && <input type="tel" placeholder="Phone Number (optional)" value={formData.phone} onChange={(e) => setFormData({...formData, phone: e.target.value.replace(/[^\d+\-() ]/g, '')})} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />}

                                    {isSignup && (
                                        <div className="w-full bg-white/10 border border-white/20 rounded-xl p-4">
                                            <label className="text-white text-sm font-medium mb-3 block">I am a:</label>
                                            <div className="space-y-2">
                                                {/* Coach - Coming Soon */}
                                                <div className="relative opacity-50 pointer-events-none">
                                                    <div className="absolute inset-0 flex items-center justify-center z-10 bg-black/40 rounded-lg backdrop-blur-sm">
                                                        <div className="text-center">
                                                            <p className="text-white font-bold text-sm">Coming Soon</p>
                                                            <p className="text-gray-300 text-xs">Q1 2026</p>
                                                        </div>
                                                    </div>
                                                    <label className="flex items-center cursor-pointer group">
                                                        <input type="radio" name="userType" value="coach" checked={formData.userType === 'coach'} onChange={(e) => setFormData({...formData, userType: e.target.value, coachId: ''})} className="w-4 h-4 text-orange-500 focus:ring-orange-500" disabled />
                                                        <span className="ml-3 text-white group-hover:text-orange-400 transition-colors line-through opacity-50">Coach - I want to train clients</span>
                                                    </label>
                                                </div>

                                                {/* Client - Coming Soon */}
                                                <div className="relative opacity-50 pointer-events-none">
                                                    <div className="absolute inset-0 flex items-center justify-center z-10 bg-black/40 rounded-lg backdrop-blur-sm">
                                                        <div className="text-center">
                                                            <p className="text-white font-bold text-sm">Coming Soon</p>
                                                            <p className="text-gray-300 text-xs">Q1 2026</p>
                                                        </div>
                                                    </div>
                                                    <label className="flex items-center cursor-pointer group">
                                                        <input type="radio" name="userType" value="client" checked={formData.userType === 'client'} onChange={(e) => setFormData({...formData, userType: e.target.value})} className="w-4 h-4 text-orange-500 focus:ring-orange-500" disabled />
                                                        <span className="ml-3 text-white group-hover:text-orange-400 transition-colors line-through opacity-50">Client - I want to train with a coach</span>
                                                    </label>
                                                </div>

                                                {/* Individual - Available Now */}
                                                <label className="flex items-center cursor-pointer group">
                                                    <input type="radio" name="userType" value="individual" checked={formData.userType === 'individual'} onChange={(e) => setFormData({...formData, userType: e.target.value, coachId: ''})} className="w-4 h-4 text-orange-500 focus:ring-orange-500" />
                                                    <span className="ml-3 text-white group-hover:text-orange-400 transition-colors">Individual - I want to train solo with AI</span>
                                                </label>
                                            </div>
                                        </div>
                                    )}

                                    {isSignup && formData.userType === 'client' && (
                                <div className="w-full">
                                    <label className="text-white text-sm font-medium mb-2 block">Select Your Coach</label>
                                    {coaches.length === 0 ? (
                                        <p className="text-gray-400 text-sm bg-white/10 border border-white/20 rounded-xl p-4">No coaches available at this time</p>
                                    ) : (
                                        <div className="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                            {coaches.map(coach => (
                                                <div
                                                    key={coach._id}
                                                    onClick={() => setFormData({...formData, coachId: coach._id})}
                                                    className={`p-4 rounded-xl cursor-pointer transition-all ${formData.coachId === coach._id ? 'bg-orange-500/20 border-2 border-orange-500' : 'bg-white/10 border border-white/20 hover:bg-white/15'}`}
                                                >
                                                    <div className="flex items-start gap-3">
                                                        <div className="flex-shrink-0">
                                                            {coach.profilePicture ? (
                                                                <img src={coach.profilePicture} alt={coach.name} className="w-12 h-12 rounded-full object-cover" />
                                                            ) : (
                                                                <div className="w-12 h-12 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-lg">
                                                                    {coach.name.charAt(0).toUpperCase()}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2">
                                                                <h4 className="text-white font-semibold">{coach.name}</h4>
                                                                {formData.coachId === coach._id && (
                                                                    <i className="fas fa-check-circle text-orange-500"></i>
                                                                )}
                                                            </div>
                                                            {coach.specialty && (
                                                                <p className="text-orange-400 text-sm">{coach.specialty}</p>
                                                            )}
                                                            {coach.experienceYears > 0 && (
                                                                <p className="text-gray-400 text-xs">{coach.experienceYears} years experience</p>
                                                            )}
                                                            {coach.bio && (
                                                                <p className="text-gray-300 text-sm mt-1 line-clamp-2">{coach.bio}</p>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                                    <input type="password" placeholder="Password" value={formData.password} onChange={(e) => setFormData({...formData, password: e.target.value})} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" required minLength={6} />
                                    {isSignup && <input type="password" placeholder="Confirm Password" value={formData.confirmPassword} onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" required minLength={6} />}
                                </>
                            )}

                            {/* STEP 2: Professional Info (Coaches Only) */}
                            {isSignup && formData.userType === 'coach' && signupStep === 2 && (
                                <>
                                    <div className="text-center mb-4">
                                        <h3 className="text-white font-semibold text-lg">Professional Information</h3>
                                        <p className="text-gray-400 text-sm mt-1">Tell clients about your expertise</p>
                                    </div>

                                    <div>
                                        <label className="text-gray-400 text-sm">Specialty *</label>
                                        <input
                                            type="text"
                                            placeholder="e.g., Strength Training, Yoga, CrossFit"
                                            value={formData.specialty}
                                            onChange={(e) => setFormData({...formData, specialty: e.target.value})}
                                            className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="text-gray-400 text-sm">Years of Experience</label>
                                        <input
                                            type="number"
                                            placeholder="Years coaching"
                                            value={formData.experienceYears}
                                            onChange={(e) => setFormData({...formData, experienceYears: e.target.value})}
                                            className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                            min="0"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-gray-400 text-sm">Bio / About You</label>
                                        <textarea
                                            placeholder="Tell potential clients about yourself, your approach, and what makes you unique..."
                                            value={formData.bio}
                                            onChange={(e) => setFormData({...formData, bio: e.target.value})}
                                            rows={4}
                                            maxLength={500}
                                            className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none resize-none"
                                        />
                                        <p className="text-gray-500 text-xs mt-1">{formData.bio.length}/500 characters</p>
                                    </div>
                                </>
                            )}

                            {/* STEP 3: Certifications (Coaches Only - Optional) */}
                            {isSignup && formData.userType === 'coach' && signupStep === 3 && (
                                <>
                                    <div className="text-center mb-4">
                                        <h3 className="text-white font-semibold text-lg">Certifications</h3>
                                        <p className="text-gray-400 text-sm mt-1">Add your credentials (optional)</p>
                                    </div>

                                    {/* Certification List */}
                                    {formData.certifications.length > 0 && (
                                        <div className="space-y-2 mb-4">
                                            {formData.certifications.map((cert, index) => (
                                                <div key={index} className="flex items-center justify-between bg-white/10 rounded-xl p-3">
                                                    <div className="flex-1">
                                                        <div className="text-white font-medium">{cert.name}</div>
                                                        <div className="text-gray-400 text-sm">{cert.organization} {cert.year && `• ${cert.year}`}</div>
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={() => removeCertification(index)}
                                                        className="text-red-400 hover:text-red-300 ml-2"
                                                    >
                                                        <i className="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* Add Certification Form */}
                                    <div className="space-y-3 bg-white/5 rounded-xl p-4">
                                        <input
                                            type="text"
                                            placeholder="Certification Name"
                                            value={newCert.name}
                                            onChange={(e) => setNewCert({...newCert, name: e.target.value})}
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                        />
                                        <input
                                            type="text"
                                            placeholder="Issuing Organization"
                                            value={newCert.organization}
                                            onChange={(e) => setNewCert({...newCert, organization: e.target.value})}
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                        />
                                        <input
                                            type="number"
                                            placeholder="Year (optional)"
                                            value={newCert.year}
                                            onChange={(e) => setNewCert({...newCert, year: e.target.value})}
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                            min="1900"
                                            max="2030"
                                        />
                                        <button
                                            type="button"
                                            onClick={addCertification}
                                            disabled={!newCert.name || !newCert.organization}
                                            className="w-full bg-white/10 hover:bg-white/20 text-white py-2 rounded-xl transition-all disabled:opacity-50"
                                        >
                                            <i className="fas fa-plus mr-2"></i>Add Certification
                                        </button>
                                    </div>
                                </>
                            )}

                            {/* Submit Button with conditional text */}
                            <div className="flex gap-3">
                                {signupStep > 1 && isSignup && (
                                    <button
                                        type="button"
                                        onClick={goBackStep}
                                        className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10 transition-all"
                                    >
                                        Back
                                    </button>
                                )}
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className={`${signupStep > 1 && isSignup ? 'flex-1' : 'w-full'} bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 glow`}
                                >
                                    {loading ? 'Loading...' :
                                        isSignup ?
                                            (formData.userType === 'coach' ?
                                                (signupStep === 1 ? 'Next: Professional Info' :
                                                 signupStep === 2 ? 'Next: Certifications' :
                                                 'Create Coach Account')
                                                : 'Create Account')
                                            : 'Sign In'
                                    }
                                </button>
                            </div>
                        </form>
                        <div className="mt-6 text-center space-y-2">
                            <button onClick={() => { setIsSignup(!isSignup); setSignupStep(1); setError(''); }} className="text-gray-400 hover:text-orange-500 transition-colors block w-full">
                                {isSignup ? 'Already have an account? Sign In' : "Don't have an account? Sign Up"}
                            </button>
                            {!isSignup && (
                                <button onClick={() => { setForgotPasswordMode(true); setError(''); setSuccess(''); }} className="text-gray-500 hover:text-orange-400 transition-colors text-sm">
                                    Forgot password?
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const OnboardingFlow = ({ user, onComplete }) => {
            // Load saved onboarding state from localStorage
            const savedOnboarding = onboardingStorage.get();
            const [step, setStep] = useState(savedOnboarding?.step || 1);
            const [data, setData] = useState(savedOnboarding?.data || {
                firstName: user?.name?.split(' ')[0] || '', age: '', gender: '', weight: '', weightUnit: 'lb',
                goal: '', experience: '', daysPerWeek: 4, sessionDuration: '45-60', equipment: [], injuries: [],
                squat: '', bench: '', deadlift: '', ohp: '', competitionLevel: '',
                userType: user?.userType || 'individual', coachId: user?.coachId || ''
            });
            const [generating, setGenerating] = useState(false);

            // Persist onboarding state to localStorage
            useEffect(() => {
                onboardingStorage.set({ step, data });
            }, [step, data]);

            const totalSteps = 16;
            const progress = (step / totalSteps) * 100;
            const updateData = (key, value) => setData(prev => ({ ...prev, [key]: value }));
            const toggleArrayItem = (key, item) => {
                setData(prev => {
                    const arr = prev[key] || [];
                    return { ...prev, [key]: arr.includes(item) ? arr.filter(i => i !== item) : [...arr, item] };
                });
            };
            const nextStep = () => setStep(s => Math.min(s + 1, totalSteps));
            const prevStep = () => setStep(s => Math.max(s - 1, 1));

            // Check if user has existing profile data (has done onboarding before)
            const hasExistingData = user?.trainingPreferences?.daysPerWeek || user?.primaryGoal?.type || user?.physicalProfile?.currentWeight;

            // Map frontend equipment values to valid backend enum values
            const mapEquipment = (equipmentArray) => {
                const mapping = {
                    'full-gym': ['barbell', 'squat-rack', 'bench-press', 'dumbbells', 'cable-machine', 'leg-press', 'lat-pulldown', 'pull-up-bar'],
                    'bodyweight-only': ['pull-up-bar', 'dip-station']
                };
                const result = [];
                equipmentArray.forEach(eq => {
                    if (mapping[eq]) {
                        result.push(...mapping[eq]);
                    } else if (!['full-gym', 'bodyweight-only'].includes(eq)) {
                        result.push(eq);
                    }
                });
                return [...new Set(result)];
            };

            // Skip onboarding for returning users
            const skipOnboarding = async () => {
                setGenerating(true);
                try {
                    await api.put('/users/profile', { onboarding: { completed: true, currentStep: 10, completedAt: new Date().toISOString() } });
                    onboardingStorage.clear();
                    const userData = await api.get('/users/profile');
                    onComplete(userData.user || userData.data || userData);
                } catch (err) {
                    console.error('Skip onboarding error:', err);
                    const userData = await api.get('/users/profile');
                    onComplete(userData.user || userData.data || userData);
                }
            };

            const completeOnboarding = async () => {
                setGenerating(true);
                try {
                    // Update user name if changed during onboarding
                    if (data.firstName && data.firstName !== user?.name?.split(' ')[0]) {
                        await api.put('/users/profile', { name: data.firstName });
                    }
                    // Step 1: Profile
                    await api.post('/onboarding/step/1', { data: { gender: data.gender || 'prefer-not-to-say', currentWeight: parseFloat(data.weight) || 0, unitPreference: data.weightUnit === 'kg' ? 'metric' : 'imperial' } });
                    // Step 2: Experience
                    await api.post('/onboarding/step/2', { data: { level: data.experience, primaryDiscipline: data.goal === 'competition-prep' ? 'powerlifting' : 'general-fitness' } });
                    // Step 3: Goal
                    await api.post('/onboarding/step/3', { data: { type: data.goal } });

                    // GOD TIER: Competition Prep (Step 4)
                    if (data.competitionLevel === 'competitive' && data.meetDate) {
                        await api.post('/onboarding/step/4', { data: {
                            isCompeting: true,
                            sport: 'powerlifting',
                            federation: data.federation,
                            meetDate: data.meetDate,
                            targetWeightClass: data.targetWeightClass,
                            weighInType: data.weighInType || '24-hour'
                        }});
                    }

                    // GOD TIER: Body Composition (Step 5)
                    if (data.targetWeight || data.bodyCompGoal) {
                        await api.post('/onboarding/step/5', { data: {
                            currentWeight: parseFloat(data.weight) || 0,
                            targetWeight: parseFloat(data.targetWeight) || 0,
                            goal: data.bodyCompGoal || 'maintain'
                        }});
                    }

                    // Step 6: Schedule
                    await api.post('/onboarding/step/6', { data: { daysPerWeek: data.daysPerWeek, sessionDuration: parseInt(data.sessionDuration?.split('-')[0]) || 60 } });
                    // Step 7: Equipment
                    await api.post('/onboarding/step/7', { data: { trainingLocation: data.equipment?.includes('full-gym') ? 'commercial-gym' : 'home-gym', availableEquipment: mapEquipment(data.equipment || []) } });

                    // GOD TIER: Exercise Preferences (Step 8)
                    await api.post('/onboarding/step/8', { data: {
                        favoriteExercises: data.favoriteExercises?.split(',').map(s => s.trim()).filter(Boolean) || [],
                        hatedExercises: data.hatedExercises?.split(',').map(s => s.trim()).filter(Boolean) || [],
                        cardioPreference: data.cardioPreference || 'mixed',
                        preferredSplit: data.preferredSplit || 'ai-decides'
                    }});

                    // GOD TIER: Dietary Preferences (Step 9)
                    await api.post('/onboarding/step/9', { data: {
                        dietType: data.dietType || 'flexible',
                        allergies: data.allergies?.split(',').map(s => s.trim()).filter(Boolean) || [],
                        cookingSkill: data.cookingSkill || 'basic',
                        mealsPerDay: data.mealsPerDay || 4
                    }});

                    // GOD TIER: Lifestyle (Step 10)
                    await api.post('/onboarding/step/10', { data: {
                        jobType: data.jobType || 'sedentary',
                        stressLevel: data.stressLevel || 'moderate',
                        sleepHours: parseFloat(data.sleepHours) || 7,
                        sleepQuality: data.sleepQuality || 'fair',
                        hobbies: data.hobbies?.split(',').map(s => s.trim()).filter(Boolean) || []
                    }});

                    // Step 11: Injuries/Limitations
                    if (data.injuries?.length > 0 && !data.injuries.includes('none')) {
                        await api.post('/onboarding/step/11', { data: { injuries: data.injuries.map(injury => ({ bodyPart: injury, severity: 'moderate' })) } });
                    }

                    // Mark onboarding as completed
                    await api.put('/users/profile', { onboarding: { completed: true, currentStep: 15, completedAt: new Date().toISOString() } });
                    await api.post('/onboarding/complete', {});
                    onboardingStorage.clear();
                    const userData = await api.get('/users/profile');
                    onComplete(userData.user || userData.data || userData);
                } catch (err) {
                    console.error('Onboarding error:', err);
                    onboardingStorage.clear();
                    const userData = await api.get('/users/profile');
                    onComplete(userData.user || userData.data || userData);
                }
            };

            if (generating) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="text-center">
                            <div className="w-24 h-24 mx-auto mb-6 relative">
                                <svg className="w-full h-full animate-spin" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(249,115,22,0.2)" strokeWidth="8"/>
                                    <circle cx="50" cy="50" r="45" fill="none" stroke="#f97316" strokeWidth="8" strokeDasharray="283" strokeDashoffset="200" strokeLinecap="round"/>
                                </svg>
                                <div className="absolute inset-0 flex items-center justify-center"><i className="fas fa-dumbbell text-3xl text-orange-500"></i></div>
                            </div>
                            <h2 className="text-2xl font-bold text-white mb-2">Generating Your Program</h2>
                            <p className="text-gray-400">Building a plan tailored to your level</p>
                        </div>
                    </div>
                );
            }

            const renderStep = () => {
                switch(step) {
                    case 1: return <StepWelcome onNext={nextStep} onSkip={skipOnboarding} hasExistingData={hasExistingData} />;
                    case 2: return <StepUserType data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} user={user} />;
                    case 3: return <StepBasicInfo data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 4: return <StepCompetitionLevel data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 5: return <StepGoal data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 6: return <StepExperience data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    // GOD TIER: Competition prep (only for competitive athletes)
                    case 7: return data.competitionLevel === 'competitive'
                        ? <StepCompetitionPrep data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />
                        : (() => { nextStep(); return null; })();
                    // GOD TIER: Body composition goals
                    case 8: return <StepBodyComposition data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 9: return <StepFrequency data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 10: return <StepDuration data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 11: return <StepEquipment data={data} toggleArrayItem={toggleArrayItem} onNext={nextStep} onBack={prevStep} />;
                    // GOD TIER: Exercise preferences
                    case 12: return <StepExercisePreferences data={data} updateData={updateData} toggleArrayItem={toggleArrayItem} onNext={nextStep} onBack={prevStep} />;
                    // GOD TIER: Dietary preferences
                    case 13: return <StepDietaryPreferences data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    // GOD TIER: Lifestyle factors
                    case 14: return <StepLifestyle data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 15: return <StepInjuries data={data} updateData={updateData} onNext={nextStep} onBack={prevStep} />;
                    case 16: return <StepCurrentLifts data={data} updateData={updateData} onComplete={completeOnboarding} onBack={prevStep} />;
                    default: return null;
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {step > 1 && <div className="fixed top-0 left-0 right-0 h-1 bg-white/10 z-50"><div className="h-full bg-orange-500 transition-all duration-500" style={{ width: `${progress}%` }} /></div>}
                    <div className="flex-1 flex items-center justify-center p-4">{renderStep()}</div>
                </div>
            );
        };

        const StepWelcome = ({ onNext, onSkip, hasExistingData }) => (
            <div className="text-center max-w-md lightning-container">
                <div className="mb-6">
                    <i className="fas fa-bolt text-8xl text-orange-500 lightning-icon"></i>
                </div>
                <h1 className="text-2xl font-bold text-white mb-2">Welcome to</h1>
                <div className="flex justify-center mb-4">
                    <ClockWorkLogo size="xl" showLightning={false} />
                </div>
                <p className="text-gray-400 text-lg mb-8">Elite-level coaching that adapts to YOU</p>
                <button onClick={onNext} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 px-12 rounded-xl text-lg transition-all glow">Get Started</button>
                {hasExistingData && (
                    <button onClick={onSkip} className="block w-full mt-4 text-gray-400 hover:text-orange-500 transition-colors text-sm">
                        Already set up? Skip to App →
                    </button>
                )}
            </div>
        );

        const StepUserType = ({ data, updateData, onNext, onBack, user }) => {
            const [coaches, setCoaches] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (!data.userType) {
                    updateData('userType', user?.userType || 'individual');
                }
                loadCoaches();
            }, []);

            const loadCoaches = async () => {
                setLoading(true);
                try {
                    const res = await api.get('/coach/list');
                    setCoaches(res.coaches || []);
                } catch (err) {
                    console.error('Failed to load coaches:', err);
                }
                setLoading(false);
            };

            const handleNext = async () => {
                // Update user's userType in database
                try {
                    const payload = { userType: data.userType };
                    // Only include coachId if it's not empty and user type is client
                    if (data.userType === 'client' && data.coachId) {
                        payload.coachId = data.coachId;
                    }
                    await api.put('/users/profile', payload);
                    onNext();
                } catch (err) {
                    console.error('Failed to update user type:', err);
                    alert('Failed to save. Please try again.');
                }
            };

            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">I am a:</h2>
                    <p className="text-gray-400 mb-6">Choose how you want to use ClockWork</p>

                    <div className="space-y-3 mb-6">
                        <button
                            onClick={() => updateData('userType', 'coach')}
                            className={`w-full flex items-center gap-4 p-4 rounded-xl border transition-all ${
                                data.userType === 'coach'
                                    ? 'border-orange-500 bg-orange-500/20'
                                    : 'border-white/20 bg-white/5 hover:bg-white/10'
                            }`}
                        >
                            <i className="fas fa-chalkboard-teacher text-2xl text-orange-500"></i>
                            <div className="text-left flex-1">
                                <div className="text-white font-medium">Coach</div>
                                <div className="text-gray-400 text-sm">I want to train clients</div>
                            </div>
                            {data.userType === 'coach' && <i className="fas fa-check text-orange-500"></i>}
                        </button>

                        <button
                            onClick={() => updateData('userType', 'client')}
                            className={`w-full flex items-center gap-4 p-4 rounded-xl border transition-all ${
                                data.userType === 'client'
                                    ? 'border-orange-500 bg-orange-500/20'
                                    : 'border-white/20 bg-white/5 hover:bg-white/10'
                            }`}
                        >
                            <i className="fas fa-user-friends text-2xl text-orange-500"></i>
                            <div className="text-left flex-1">
                                <div className="text-white font-medium">Client</div>
                                <div className="text-gray-400 text-sm">I want to train with a coach</div>
                            </div>
                            {data.userType === 'client' && <i className="fas fa-check text-orange-500"></i>}
                        </button>

                        <button
                            onClick={() => { updateData('userType', 'individual'); updateData('coachId', ''); }}
                            className={`w-full flex items-center gap-4 p-4 rounded-xl border transition-all ${
                                data.userType === 'individual'
                                    ? 'border-orange-500 bg-orange-500/20'
                                    : 'border-white/20 bg-white/5 hover:bg-white/10'
                            }`}
                        >
                            <i className="fas fa-user text-2xl text-orange-500"></i>
                            <div className="text-left flex-1">
                                <div className="text-white font-medium">Individual</div>
                                <div className="text-gray-400 text-sm">I want to train solo with AI</div>
                            </div>
                            {data.userType === 'individual' && <i className="fas fa-check text-orange-500"></i>}
                        </button>
                    </div>

                    {data.userType === 'client' && (
                        <div className="mb-6">
                            <label className="text-white text-sm font-medium mb-2 block">Select Your Coach</label>
                            {loading ? (
                                <div className="text-center py-8 text-gray-400">Loading coaches...</div>
                            ) : coaches.length === 0 ? (
                                <p className="text-gray-400 text-sm bg-white/10 border border-white/20 rounded-xl p-4">No coaches available</p>
                            ) : (
                                <div className="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                    {coaches.map(coach => (
                                        <div
                                            key={coach._id}
                                            onClick={() => updateData('coachId', coach._id)}
                                            className={`p-4 rounded-xl cursor-pointer transition-all ${
                                                data.coachId === coach._id
                                                    ? 'bg-orange-500/20 border-2 border-orange-500'
                                                    : 'bg-white/10 border border-white/20 hover:bg-white/15'
                                            }`}
                                        >
                                            <div className="flex items-start gap-3">
                                                {coach.coachProfile?.profilePicture ? (
                                                    <img src={coach.coachProfile.profilePicture} alt={coach.name} className="w-12 h-12 rounded-full object-cover" />
                                                ) : (
                                                    <div className="w-12 h-12 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold">
                                                        {coach.name.charAt(0).toUpperCase()}
                                                    </div>
                                                )}
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2">
                                                        <h4 className="text-white font-semibold">{coach.name}</h4>
                                                        {data.coachId === coach._id && <i className="fas fa-check-circle text-orange-500"></i>}
                                                    </div>
                                                    {coach.coachProfile?.specialty && (
                                                        <p className="text-orange-400 text-sm">{coach.coachProfile.specialty}</p>
                                                    )}
                                                    {coach.coachProfile?.bio && (
                                                        <p className="text-gray-300 text-sm mt-1">{coach.coachProfile.bio}</p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    <div className="flex gap-3">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button
                            onClick={handleNext}
                            disabled={data.userType === 'client' && !data.coachId}
                            className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow disabled:opacity-50"
                        >
                            Continue
                        </button>
                    </div>
                </div>
            );
        };

        const StepBasicInfo = ({ data, updateData, onNext, onBack }) => (
            <div className="w-full max-w-md">
                <h2 className="text-2xl font-bold text-white mb-2">Tell us about yourself</h2>
                <p className="text-gray-400 mb-6">This helps personalize your experience</p>
                <div className="space-y-4">
                    <div><label className="text-gray-400 text-sm">First Name</label><input type="text" value={data.firstName} onChange={(e) => updateData('firstName', e.target.value)} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" placeholder="Your name" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="text-gray-400 text-sm">Age</label><input type="number" value={data.age} onChange={(e) => updateData('age', e.target.value)} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" placeholder="Age" /></div>
                        <div><label className="text-gray-400 text-sm">Gender</label><select value={data.gender} onChange={(e) => updateData('gender', e.target.value)} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none"><option value="">Select</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
                    </div>
                    <div><label className="text-gray-400 text-sm">Current Weight</label><div className="flex gap-2 mt-1"><input type="number" value={data.weight} onChange={(e) => updateData('weight', e.target.value)} className="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" placeholder="Weight" /><select value={data.weightUnit} onChange={(e) => updateData('weightUnit', e.target.value)} className="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none"><option value="lb">lb</option><option value="kg">kg</option></select></div></div>
                </div>
                <div className="flex gap-3 mt-8">
                    <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                    <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                </div>
            </div>
        );

        const StepCompetitionLevel = ({ data, updateData, onNext, onBack }) => {
            const levels = [
                { id: 'beginner', label: 'Just Starting Out', desc: 'New to structured training', icon: 'fa-seedling' },
                { id: 'recreational', label: 'Recreational', desc: 'Train for health & enjoyment', icon: 'fa-heart' },
                { id: 'competitive', label: 'Competitive Amateur', desc: 'Compete at local/regional level', icon: 'fa-medal' },
                { id: 'elite', label: 'Elite / Pro', desc: 'National/International competitor', icon: 'fa-crown' }
            ];
            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">What's your level?</h2>
                    <p className="text-gray-400 mb-6">We cater to everyone from beginners to elite athletes</p>
                    <div className="space-y-3">
                        {levels.map(level => (
                            <button key={level.id} onClick={() => updateData('competitionLevel', level.id)} className={`w-full flex items-center gap-4 p-4 rounded-xl border transition-all ${data.competitionLevel === level.id ? 'border-orange-500 bg-orange-500/20' : 'border-white/20 bg-white/5 hover:bg-white/10'}`}>
                                <i className={`fas ${level.icon} text-2xl text-orange-500`}></i>
                                <div className="text-left"><div className="text-white font-medium">{level.label}</div><div className="text-gray-400 text-sm">{level.desc}</div></div>
                                {data.competitionLevel === level.id && <i className="fas fa-check ml-auto text-orange-500"></i>}
                            </button>
                        ))}
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} disabled={!data.competitionLevel} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow disabled:opacity-50">Continue</button>
                    </div>
                </div>
            );
        };

        const StepGoal = ({ data, updateData, onNext, onBack }) => {
            const goals = [
                { id: 'build-muscle', label: 'Build Muscle', icon: 'fa-dumbbell', desc: 'Hypertrophy focus' },
                { id: 'build-strength', label: 'Get Stronger', icon: 'fa-weight-hanging', desc: 'Strength focus' },
                { id: 'lose-fat', label: 'Lose Fat', icon: 'fa-fire', desc: 'Deficit + training' },
                { id: 'general-health', label: 'Improve Fitness', icon: 'fa-heart-pulse', desc: 'General health' },
                { id: 'sport-performance', label: 'Train for Sport', icon: 'fa-futbol', desc: 'Sport-specific' },
                { id: 'competition-prep', label: 'Competition Prep', icon: 'fa-trophy', desc: 'Powerlifting/BB' }
            ];
            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">What's your main goal?</h2>
                    <p className="text-gray-400 mb-6">This shapes your entire program</p>
                    <div className="space-y-3">
                        {goals.map(goal => (
                            <button key={goal.id} onClick={() => updateData('goal', goal.id)} className={`w-full flex items-center gap-4 p-4 rounded-xl border transition-all ${data.goal === goal.id ? 'border-orange-500 bg-orange-500/20' : 'border-white/20 bg-white/5 hover:bg-white/10'}`}>
                                <i className={`fas ${goal.icon} text-2xl text-orange-500`}></i>
                                <div className="text-left"><div className="text-white font-medium">{goal.label}</div><div className="text-gray-400 text-sm">{goal.desc}</div></div>
                                {data.goal === goal.id && <i className="fas fa-check ml-auto text-orange-500"></i>}
                            </button>
                        ))}
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} disabled={!data.goal} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow disabled:opacity-50">Continue</button>
                    </div>
                </div>
            );
        };

        const StepExperience = ({ data, updateData, onNext, onBack }) => {
            const levels = [
                { id: 'complete-beginner', label: 'New to Training', desc: '0-6 months', icon: 'fa-seedling' },
                { id: 'beginner', label: 'Some Experience', desc: '6 months - 2 years', icon: 'fa-leaf' },
                { id: 'intermediate', label: 'Experienced', desc: '2-5 years', icon: 'fa-tree' },
                { id: 'advanced', label: 'Advanced', desc: '5+ years', icon: 'fa-mountain' }
            ];
            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">Training experience?</h2>
                    <p className="text-gray-400 mb-6">This determines program complexity</p>
                    <div className="space-y-3">
                        {levels.map(level => (
                            <button key={level.id} onClick={() => updateData('experience', level.id)} className={`w-full flex items-center gap-4 p-4 rounded-xl border transition-all ${data.experience === level.id ? 'border-orange-500 bg-orange-500/20' : 'border-white/20 bg-white/5 hover:bg-white/10'}`}>
                                <i className={`fas ${level.icon} text-2xl text-orange-500`}></i>
                                <div className="text-left"><div className="text-white font-medium">{level.label}</div><div className="text-gray-400 text-sm">{level.desc}</div></div>
                                {data.experience === level.id && <i className="fas fa-check ml-auto text-orange-500"></i>}
                            </button>
                        ))}
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} disabled={!data.experience} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow disabled:opacity-50">Continue</button>
                    </div>
                </div>
            );
        };

        const StepFrequency = ({ data, updateData, onNext, onBack }) => {
            const frequencies = [{ days: 2, split: 'Full Body' }, { days: 3, split: 'Full Body / Upper-Lower' }, { days: 4, split: 'Upper/Lower' }, { days: 5, split: 'Push/Pull/Legs' }, { days: 6, split: 'PPL x2' }];
            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">Training days per week?</h2>
                    <p className="text-gray-400 mb-6">We'll optimize your split</p>
                    <div className="space-y-3">
                        {frequencies.map(freq => (
                            <button key={freq.days} onClick={() => updateData('daysPerWeek', freq.days)} className={`w-full flex items-center justify-between p-4 rounded-xl border transition-all ${data.daysPerWeek === freq.days ? 'border-orange-500 bg-orange-500/20' : 'border-white/20 bg-white/5 hover:bg-white/10'}`}>
                                <div className="flex items-center gap-4"><span className="text-2xl font-bold text-orange-500">{freq.days}</span><span className="text-white">days per week</span></div>
                                <span className="text-gray-400 text-sm">{freq.split}</span>
                            </button>
                        ))}
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                </div>
            );
        };

        const StepDuration = ({ data, updateData, onNext, onBack }) => {
            const durations = [{ id: '30-45', label: '30-45 min', desc: 'Short' }, { id: '45-60', label: '45-60 min', desc: 'Standard' }, { id: '60-90', label: '60-90 min', desc: 'Extended' }, { id: '90+', label: '90+ min', desc: 'Long' }];
            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">Session duration?</h2>
                    <p className="text-gray-400 mb-6">We'll size your workouts</p>
                    <div className="space-y-3">
                        {durations.map(dur => (
                            <button key={dur.id} onClick={() => updateData('sessionDuration', dur.id)} className={`w-full flex items-center justify-between p-4 rounded-xl border transition-all ${data.sessionDuration === dur.id ? 'border-orange-500 bg-orange-500/20' : 'border-white/20 bg-white/5 hover:bg-white/10'}`}>
                                <span className="text-white font-medium">{dur.label}</span><span className="text-gray-400 text-sm">{dur.desc}</span>
                            </button>
                        ))}
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                </div>
            );
        };

        const StepEquipment = ({ data, toggleArrayItem, onNext, onBack }) => {
            const equipment = [
                { id: 'full-gym', label: 'Full Gym', icon: 'fa-building' },
                { id: 'barbell', label: 'Barbell + Rack', icon: 'fa-dumbbell' },
                { id: 'dumbbells', label: 'Dumbbells', icon: 'fa-weight-hanging' },
                { id: 'kettlebells', label: 'Kettlebells', icon: 'fa-bowling-ball' },
                { id: 'pull-up-bar', label: 'Pull-up Bar', icon: 'fa-grip-lines' },
                { id: 'cable-machine', label: 'Cables', icon: 'fa-link' },
                { id: 'resistance-bands', label: 'Bands', icon: 'fa-ribbon' },
                { id: 'bodyweight-only', label: 'Bodyweight', icon: 'fa-person' }
            ];
            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">Equipment access?</h2>
                    <p className="text-gray-400 mb-6">Select all that apply</p>
                    <div className="grid grid-cols-2 gap-3">
                        {equipment.map(eq => (
                            <button key={eq.id} onClick={() => toggleArrayItem('equipment', eq.id)} className={`flex flex-col items-center gap-2 p-4 rounded-xl border transition-all ${data.equipment.includes(eq.id) ? 'border-orange-500 bg-orange-500/20' : 'border-white/20 bg-white/5 hover:bg-white/10'}`}>
                                <i className={`fas ${eq.icon} text-2xl text-orange-500`}></i>
                                <span className="text-white text-sm text-center">{eq.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} disabled={data.equipment.length === 0} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow disabled:opacity-50">Continue</button>
                    </div>
                </div>
            );
        };

        const StepInjuries = ({ data, updateData, onNext, onBack }) => {
            const injuries = [{ id: 'low-back', label: 'Low Back' }, { id: 'shoulder', label: 'Shoulder' }, { id: 'knee', label: 'Knee' }, { id: 'hip', label: 'Hip' }, { id: 'elbow-wrist', label: 'Elbow/Wrist' }, { id: 'none', label: 'None' }];
            return (
                <div className="w-full max-w-md">
                    <h2 className="text-2xl font-bold text-white mb-2">Any injuries?</h2>
                    <p className="text-gray-400 mb-6">We'll avoid aggravating movements</p>
                    <div className="space-y-3">
                        {injuries.map(injury => (
                            <button key={injury.id} onClick={() => injury.id === 'none' ? updateData('injuries', ['none']) : updateData('injuries', data.injuries.includes(injury.id) ? data.injuries.filter(i => i !== injury.id && i !== 'none') : [...data.injuries.filter(i => i !== 'none'), injury.id])} className={`w-full flex items-center justify-between p-4 rounded-xl border transition-all ${data.injuries.includes(injury.id) ? 'border-orange-500 bg-orange-500/20' : 'border-white/20 bg-white/5 hover:bg-white/10'}`}>
                                <span className="text-white">{injury.label}</span>
                                {data.injuries.includes(injury.id) && <i className="fas fa-check text-orange-500"></i>}
                            </button>
                        ))}
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                </div>
            );
        };

        const StepCurrentLifts = ({ data, updateData, onComplete, onBack }) => (
            <div className="w-full max-w-md">
                <h2 className="text-2xl font-bold text-white mb-2">Current maxes?</h2>
                <p className="text-gray-400 mb-6">Enter your best lifts (optional but helps calibration)</p>
                <div className="space-y-4">
                    {[{ key: 'squat', label: 'Squat' }, { key: 'bench', label: 'Bench' }, { key: 'deadlift', label: 'Deadlift' }, { key: 'ohp', label: 'OHP' }].map(lift => (
                        <div key={lift.key}><label className="text-gray-400 text-sm">{lift.label} (1RM)</label><input type="number" value={data[lift.key]} onChange={(e) => updateData(lift.key, e.target.value)} placeholder={data.weightUnit} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" /></div>
                    ))}
                </div>
                <div className="flex gap-3 mt-8">
                    <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                    <button onClick={onComplete} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Generate Program</button>
                </div>
                <button onClick={onComplete} className="w-full mt-4 text-gray-400 hover:text-white transition-colors">Skip</button>
            </div>
        );

        // ═══════════════════════════════════════════════════════════
        // GOD TIER ONBOARDING - NEW PERSONALIZATION SCREENS
        // ═══════════════════════════════════════════════════════════

        const StepCompetitionPrep = ({ data, updateData, onNext, onBack }) => {
            const federations = ['USAPL', 'USPA', 'IPF', 'WRPF', 'RPS', 'SPF', 'Other'];
            const weightClasses = data.gender === 'male'
                ? ['59kg', '66kg', '74kg', '83kg', '93kg', '105kg', '120kg', '120kg+']
                : ['47kg', '52kg', '57kg', '63kg', '69kg', '76kg', '84kg', '84kg+'];

            return (
                <div className="w-full max-w-md">
                    <div className="flex items-center gap-3 mb-4">
                        <i className="fas fa-trophy text-3xl text-orange-500"></i>
                        <div>
                            <h2 className="text-2xl font-bold text-white">Competition Prep</h2>
                            <p className="text-gray-400">Tell us about your upcoming meet</p>
                        </div>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label className="text-gray-400 text-sm">Meet Date</label>
                            <input type="date" value={data.meetDate || ''} onChange={(e) => updateData('meetDate', e.target.value)} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm">Federation</label>
                            <select value={data.federation || ''} onChange={(e) => updateData('federation', e.target.value)} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none">
                                <option value="">Select federation</option>
                                {federations.map(f => <option key={f} value={f}>{f}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm">Target Weight Class</label>
                            <select value={data.targetWeightClass || ''} onChange={(e) => updateData('targetWeightClass', e.target.value)} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none">
                                <option value="">Select weight class</option>
                                {weightClasses.map(w => <option key={w} value={w}>{w}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm">Weigh-in Type</label>
                            <div className="grid grid-cols-3 gap-2 mt-1">
                                {['2-hour', '24-hour', 'same-day'].map(type => (
                                    <button key={type} onClick={() => updateData('weighInType', type)} className={`p-3 rounded-xl text-sm transition-all ${data.weighInType === type ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        {type}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                    <button onClick={onNext} className="w-full mt-4 text-gray-400 hover:text-white transition-colors text-sm">Skip for now</button>
                </div>
            );
        };

        const StepBodyComposition = ({ data, updateData, onNext, onBack }) => {
            const goals = [
                { id: 'aggressive-cut', label: 'Aggressive Cut', desc: '1.5-2 lbs/week', icon: 'fa-fire' },
                { id: 'moderate-cut', label: 'Moderate Cut', desc: '1 lb/week', icon: 'fa-arrow-down' },
                { id: 'slow-cut', label: 'Slow Cut', desc: '0.5 lbs/week', icon: 'fa-minus' },
                { id: 'maintain', label: 'Maintain', desc: 'Stay same weight', icon: 'fa-balance-scale' },
                { id: 'lean-bulk', label: 'Lean Bulk', desc: '0.5-1 lb/week', icon: 'fa-arrow-up' },
                { id: 'bulk', label: 'Bulk', desc: '1-2 lbs/week', icon: 'fa-plus' }
            ];
            const weightDiff = data.weight && data.targetWeight ? (parseFloat(data.weight) - parseFloat(data.targetWeight)).toFixed(1) : null;

            return (
                <div className="w-full max-w-md">
                    <div className="flex items-center gap-3 mb-4">
                        <i className="fas fa-weight text-3xl text-orange-500"></i>
                        <div>
                            <h2 className="text-2xl font-bold text-white">Body Composition</h2>
                            <p className="text-gray-400">Your physique goals</p>
                        </div>
                    </div>
                    <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-gray-400 text-sm">Current Weight</label>
                                <input type="number" value={data.weight || ''} onChange={(e) => updateData('weight', e.target.value)} placeholder="195" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                            </div>
                            <div>
                                <label className="text-gray-400 text-sm">Target Weight</label>
                                <input type="number" value={data.targetWeight || ''} onChange={(e) => updateData('targetWeight', e.target.value)} placeholder="183" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                            </div>
                        </div>
                        {weightDiff && weightDiff !== '0.0' && (
                            <div className={`text-center py-2 rounded-xl ${parseFloat(weightDiff) > 0 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>
                                {parseFloat(weightDiff) > 0 ? `Need to lose ${weightDiff} lbs` : `Need to gain ${Math.abs(parseFloat(weightDiff))} lbs`}
                            </div>
                        )}
                        <div>
                            <label className="text-gray-400 text-sm mb-2 block">Weight Goal Strategy</label>
                            <div className="grid grid-cols-2 gap-2">
                                {goals.map(goal => (
                                    <button key={goal.id} onClick={() => updateData('bodyCompGoal', goal.id)} className={`flex items-center gap-2 p-3 rounded-xl text-sm transition-all ${data.bodyCompGoal === goal.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        <i className={`fas ${goal.icon}`}></i>
                                        <div className="text-left">
                                            <div className="font-medium">{goal.label}</div>
                                            <div className="text-xs opacity-70">{goal.desc}</div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                </div>
            );
        };

        const StepExercisePreferences = ({ data, updateData, toggleArrayItem, onNext, onBack }) => {
            const cardioOptions = [
                { id: 'none', label: 'No Cardio', icon: 'fa-ban' },
                { id: 'liss', label: 'LISS', desc: 'Walking, cycling', icon: 'fa-walking' },
                { id: 'hiit', label: 'HIIT', desc: 'Intervals', icon: 'fa-bolt' },
                { id: 'sports', label: 'Sports', desc: 'Basketball, etc.', icon: 'fa-basketball' },
                { id: 'mixed', label: 'Mixed', desc: 'Variety', icon: 'fa-random' }
            ];
            const splitOptions = [
                { id: 'full-body', label: 'Full Body' },
                { id: 'upper-lower', label: 'Upper/Lower' },
                { id: 'ppl', label: 'Push/Pull/Legs' },
                { id: 'bro-split', label: 'Bro Split' },
                { id: 'ai-decides', label: 'Let AI Decide' }
            ];

            return (
                <div className="w-full max-w-md">
                    <div className="flex items-center gap-3 mb-4">
                        <i className="fas fa-dumbbell text-3xl text-orange-500"></i>
                        <div>
                            <h2 className="text-2xl font-bold text-white">Exercise Preferences</h2>
                            <p className="text-gray-400">What do you love (or hate)?</p>
                        </div>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label className="text-gray-400 text-sm">Favorite Exercises (comma separated)</label>
                            <input type="text" value={data.favoriteExercises || ''} onChange={(e) => updateData('favoriteExercises', e.target.value)} placeholder="Squat, Romanian Deadlift, Dips" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm">Exercises to Avoid (comma separated)</label>
                            <input type="text" value={data.hatedExercises || ''} onChange={(e) => updateData('hatedExercises', e.target.value)} placeholder="Leg extensions, Burpees" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm mb-2 block">Cardio Preference</label>
                            <div className="grid grid-cols-3 gap-2">
                                {cardioOptions.map(opt => (
                                    <button key={opt.id} onClick={() => updateData('cardioPreference', opt.id)} className={`flex flex-col items-center gap-1 p-3 rounded-xl text-sm transition-all ${data.cardioPreference === opt.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        <i className={`fas ${opt.icon}`}></i>
                                        <span>{opt.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm mb-2 block">Preferred Split</label>
                            <div className="flex flex-wrap gap-2">
                                {splitOptions.map(opt => (
                                    <button key={opt.id} onClick={() => updateData('preferredSplit', opt.id)} className={`px-4 py-2 rounded-xl text-sm transition-all ${data.preferredSplit === opt.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        {opt.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                </div>
            );
        };

        const StepDietaryPreferences = ({ data, updateData, onNext, onBack }) => {
            const dietTypes = [
                { id: 'flexible', label: 'Flexible', icon: 'fa-utensils' },
                { id: 'omnivore', label: 'Omnivore', icon: 'fa-drumstick-bite' },
                { id: 'vegetarian', label: 'Vegetarian', icon: 'fa-leaf' },
                { id: 'vegan', label: 'Vegan', icon: 'fa-seedling' },
                { id: 'keto', label: 'Keto', icon: 'fa-bacon' },
                { id: 'mediterranean', label: 'Mediterranean', icon: 'fa-fish' },
                { id: 'halal', label: 'Halal', icon: 'fa-moon' },
                { id: 'kosher', label: 'Kosher', icon: 'fa-star-of-david' }
            ];
            const cookingSkills = [
                { id: 'none', label: 'Takeout Only', icon: 'fa-truck' },
                { id: 'basic', label: 'Basic', icon: 'fa-egg' },
                { id: 'intermediate', label: 'Intermediate', icon: 'fa-blender' },
                { id: 'advanced', label: 'Chef Mode', icon: 'fa-hat-chef' }
            ];

            return (
                <div className="w-full max-w-md">
                    <div className="flex items-center gap-3 mb-4">
                        <i className="fas fa-utensils text-3xl text-orange-500"></i>
                        <div>
                            <h2 className="text-2xl font-bold text-white">Dietary Preferences</h2>
                            <p className="text-gray-400">For personalized nutrition</p>
                        </div>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label className="text-gray-400 text-sm mb-2 block">Diet Type</label>
                            <div className="grid grid-cols-4 gap-2">
                                {dietTypes.map(diet => (
                                    <button key={diet.id} onClick={() => updateData('dietType', diet.id)} className={`flex flex-col items-center gap-1 p-3 rounded-xl text-xs transition-all ${data.dietType === diet.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        <i className={`fas ${diet.icon} text-lg`}></i>
                                        <span>{diet.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm">Allergies (comma separated)</label>
                            <input type="text" value={data.allergies || ''} onChange={(e) => updateData('allergies', e.target.value)} placeholder="Nuts, Dairy, Gluten" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm mb-2 block">Cooking Skill</label>
                            <div className="grid grid-cols-4 gap-2">
                                {cookingSkills.map(skill => (
                                    <button key={skill.id} onClick={() => updateData('cookingSkill', skill.id)} className={`flex flex-col items-center gap-1 p-3 rounded-xl text-xs transition-all ${data.cookingSkill === skill.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        <i className={`fas ${skill.icon} text-lg`}></i>
                                        <span>{skill.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm">Meals Per Day</label>
                            <div className="flex gap-2 mt-1">
                                {[2, 3, 4, 5, 6].map(n => (
                                    <button key={n} onClick={() => updateData('mealsPerDay', n)} className={`flex-1 py-3 rounded-xl text-center transition-all ${data.mealsPerDay === n ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        {n}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                </div>
            );
        };

        const StepLifestyle = ({ data, updateData, onNext, onBack }) => {
            const jobTypes = [
                { id: 'sedentary', label: 'Desk Job', icon: 'fa-computer' },
                { id: 'lightly-active', label: 'Light Active', icon: 'fa-person-walking' },
                { id: 'moderately-active', label: 'Moderate', icon: 'fa-person-running' },
                { id: 'very-active', label: 'Very Active', icon: 'fa-person-digging' }
            ];
            const stressLevels = [
                { id: 'low', label: 'Low', color: 'green' },
                { id: 'moderate', label: 'Moderate', color: 'yellow' },
                { id: 'high', label: 'High', color: 'orange' },
                { id: 'very-high', label: 'Very High', color: 'red' }
            ];

            return (
                <div className="w-full max-w-md">
                    <div className="flex items-center gap-3 mb-4">
                        <i className="fas fa-heart-pulse text-3xl text-orange-500"></i>
                        <div>
                            <h2 className="text-2xl font-bold text-white">Lifestyle Factors</h2>
                            <p className="text-gray-400">Affects your recovery capacity</p>
                        </div>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label className="text-gray-400 text-sm mb-2 block">Job Activity Level</label>
                            <div className="grid grid-cols-4 gap-2">
                                {jobTypes.map(job => (
                                    <button key={job.id} onClick={() => updateData('jobType', job.id)} className={`flex flex-col items-center gap-1 p-3 rounded-xl text-xs transition-all ${data.jobType === job.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        <i className={`fas ${job.icon} text-lg`}></i>
                                        <span>{job.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm mb-2 block">Stress Level</label>
                            <div className="grid grid-cols-4 gap-2">
                                {stressLevels.map(stress => (
                                    <button key={stress.id} onClick={() => updateData('stressLevel', stress.id)} className={`py-3 rounded-xl text-sm transition-all ${data.stressLevel === stress.id ? `bg-${stress.color}-500 text-white` : 'bg-white/10 text-gray-400 border border-white/20'}`}>
                                        {stress.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-gray-400 text-sm">Avg Sleep (hrs)</label>
                                <input type="number" step="0.5" value={data.sleepHours || ''} onChange={(e) => updateData('sleepHours', e.target.value)} placeholder="7" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                            </div>
                            <div>
                                <label className="text-gray-400 text-sm">Sleep Quality</label>
                                <select value={data.sleepQuality || ''} onChange={(e) => updateData('sleepQuality', e.target.value)} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none">
                                    <option value="">Select</option>
                                    <option value="poor">Poor</option>
                                    <option value="fair">Fair</option>
                                    <option value="good">Good</option>
                                    <option value="excellent">Excellent</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="text-gray-400 text-sm">Other Activities/Hobbies (comma separated)</label>
                            <input type="text" value={data.hobbies || ''} onChange={(e) => updateData('hobbies', e.target.value)} placeholder="Basketball, Hiking, Swimming" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                        </div>
                    </div>
                    <div className="flex gap-3 mt-8">
                        <button onClick={onBack} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Back</button>
                        <button onClick={onNext} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl glow">Continue</button>
                    </div>
                </div>
            );
        };

        // ═══════════════════════════════════════════════════════════
        // HABITS TAB - GOD TIER HABIT TRACKING
        // ═══════════════════════════════════════════════════════════

        const HabitsTab = ({ user }) => {
            const [habits, setHabits] = useState([]);
            const [loading, setLoading] = useState(true);
            const [weekData, setWeekData] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [creating, setCreating] = useState(false);
            const [newHabit, setNewHabit] = useState({
                name: '', description: '', trackingType: 'boolean', targetValue: 1, unit: '', frequency: 'daily', specificDays: [], category: 'custom'
            });
            const [selectedHabit, setSelectedHabit] = useState(null);
            const [logValue, setLogValue] = useState('');

            const categories = [
                { id: 'training', icon: 'fa-dumbbell', label: 'Training' },
                { id: 'nutrition', icon: 'fa-utensils', label: 'Nutrition' },
                { id: 'recovery', icon: 'fa-bed', label: 'Recovery' },
                { id: 'mindset', icon: 'fa-brain', label: 'Mindset' },
                { id: 'lifestyle', icon: 'fa-heart', label: 'Lifestyle' },
                { id: 'custom', icon: 'fa-star', label: 'Custom' }
            ];
            const trackingTypes = [
                { id: 'boolean', icon: 'fa-check', label: 'Yes/No' },
                { id: 'quantity', icon: 'fa-hashtag', label: 'Quantity' },
                { id: 'duration', icon: 'fa-clock', label: 'Duration' }
            ];
            const frequencies = [
                { id: 'daily', label: 'Every Day' },
                { id: 'weekdays', label: 'Weekdays' },
                { id: 'weekends', label: 'Weekends' },
                { id: 'specific-days', label: 'Specific Days' }
            ];
            const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            useEffect(() => { loadHabits(); }, []);

            const loadHabits = async () => {
                try {
                    const [todayRes, weeklyRes] = await Promise.all([
                        api.get('/habits/today'),
                        api.get('/habits/weekly')
                    ]);
                    setHabits(todayRes.habits || []);
                    setWeekData(weeklyRes);
                } catch (err) { console.error('Load habits error:', err); }
                setLoading(false);
            };

            const toggleHabit = async (habitId) => {
                try {
                    const res = await api.post(`/habits/${habitId}/toggle`);
                    setHabits(prev => prev.map(h => h._id === habitId ? { ...h, completedToday: res.completed, currentStreak: res.streak } : h));
                } catch (err) { console.error('Toggle habit error:', err); }
            };

            const handleHabitClick = (habit) => {
                // For quantity/duration habits, open log modal
                if (habit.trackingType === 'quantity' || habit.trackingType === 'duration') {
                    setSelectedHabit(habit);
                    setLogValue(habit.todayProgress?.toString() || '');
                } else {
                    // Boolean habits just toggle
                    toggleHabit(habit._id);
                }
            };

            const logHabitProgress = async () => {
                if (!selectedHabit || !logValue) return;
                try {
                    const value = parseFloat(logValue);
                    // Use /complete endpoint with value for quantity habits
                    const res = await api.post(`/habits/${selectedHabit._id}/complete`, { value });
                    setHabits(prev => prev.map(h =>
                        h._id === selectedHabit._id
                            ? { ...h, todayProgress: value, completedToday: value >= (h.targetValue || 1), currentStreak: res.streak || h.currentStreak }
                            : h
                    ));
                    setSelectedHabit(null);
                    setLogValue('');
                    // Refresh to get updated data
                    loadHabits();
                } catch (err) {
                    console.error('Log habit error:', err);
                    alert('Failed to log progress');
                }
            };

            const createHabit = async () => {
                if (!newHabit.name.trim()) return;
                setCreating(true);
                try {
                    const res = await api.post('/habits', newHabit);
                    setHabits(prev => [...prev, { ...res.habit, completedToday: false }]);
                    setShowAddModal(false);
                    setNewHabit({ name: '', description: '', trackingType: 'boolean', targetValue: 1, unit: '', frequency: 'daily', specificDays: [], category: 'custom' });
                } catch (err) { console.error('Create habit error:', err); alert('Failed to create habit'); }
                setCreating(false);
            };

            const toggleDay = (day) => {
                setNewHabit(prev => ({
                    ...prev,
                    specificDays: prev.specificDays.includes(day) ? prev.specificDays.filter(d => d !== day) : [...prev.specificDays, day]
                }));
            };

            if (loading) {
                return <div className="flex items-center justify-center py-12"><div className="w-8 h-8 border-2 border-orange-500 border-t-transparent rounded-full animate-spin"></div></div>;
            }

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <h1 className="text-2xl font-bold text-white">Daily Habits</h1>
                        <button onClick={() => setShowAddModal(true)} className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-xl text-sm"><i className="fas fa-plus mr-2"></i>Add</button>
                    </div>

                    {/* Weekly Progress */}
                    {weekData && (
                        <div className="glass rounded-2xl p-4">
                            <div className="flex items-center justify-between mb-3">
                                <span className="text-gray-400 text-sm">This Week</span>
                                <span className="text-orange-500 font-bold">{weekData.summary?.weeklyPercentage || 0}%</span>
                            </div>
                            <div className="flex gap-1">
                                {weekData.weekData?.map((day, i) => (
                                    <div key={i} className="flex-1 text-center">
                                        <div className={`h-8 rounded-lg mb-1 flex items-end justify-center ${day.percentage >= 100 ? 'bg-green-500' : day.percentage >= 50 ? 'bg-orange-500' : day.percentage > 0 ? 'bg-orange-500/30' : 'bg-white/10'}`}>
                                            <div className="text-xs text-white font-medium pb-1">{day.percentage > 0 ? `${day.percentage}%` : ''}</div>
                                        </div>
                                        <div className="text-xs text-gray-500">{day.dayName}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Today's Habits */}
                    <div className="space-y-3">
                        {habits.length === 0 ? (
                            <div className="glass rounded-2xl p-8 text-center">
                                <i className="fas fa-check-circle text-4xl text-gray-600 mb-3"></i>
                                <p className="text-gray-400">No habits set up yet</p>
                                <button onClick={() => setShowAddModal(true)} className="mt-4 bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-xl">Add Habits</button>
                            </div>
                        ) : (
                            habits.map(habit => (
                                <button key={habit._id} onClick={() => handleHabitClick(habit)} className={`w-full flex items-center gap-4 p-4 rounded-xl border transition-all ${habit.completedToday ? 'bg-green-500/20 border-green-500/50' : 'bg-white/5 border-white/20 hover:bg-white/10'}`}>
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${habit.completedToday ? 'bg-green-500' : 'bg-white/10'}`}>
                                        {habit.completedToday ? <i className="fas fa-check text-white"></i> : <i className={`fas fa-${habit.icon || 'check-circle'} text-gray-400`}></i>}
                                    </div>
                                    <div className="flex-1 text-left">
                                        <div className={`font-medium ${habit.completedToday ? 'text-green-400' : 'text-white'}`}>{habit.name}</div>
                                        {/* Show progress for quantity/duration habits */}
                                        {(habit.trackingType === 'quantity' || habit.trackingType === 'duration') ? (
                                            <div className="text-xs text-gray-500">
                                                {habit.todayProgress || 0} / {habit.targetValue} {habit.unit || (habit.trackingType === 'duration' ? 'min' : '')}
                                            </div>
                                        ) : habit.description && (
                                            <div className="text-xs text-gray-500">{habit.description}</div>
                                        )}
                                    </div>
                                    {habit.currentStreak > 0 && (
                                        <div className="flex items-center gap-1 text-orange-500">
                                            <i className="fas fa-fire text-sm"></i>
                                            <span className="text-sm font-bold">{habit.currentStreak}</span>
                                        </div>
                                    )}
                                </button>
                            ))
                        )}
                    </div>

                    {/* Add Habit Modal */}
                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-end sm:items-center justify-center z-50 p-4">
                            <div className="glass rounded-2xl w-full max-w-md max-h-[85vh] overflow-y-auto">
                                <div className="p-4 border-b border-white/10 flex items-center justify-between sticky top-0 bg-black/50 backdrop-blur">
                                    <h2 className="text-lg font-bold text-white">New Habit</h2>
                                    <button onClick={() => setShowAddModal(false)} className="text-gray-400 hover:text-white"><i className="fas fa-times"></i></button>
                                </div>
                                <div className="p-4 space-y-4">
                                    {/* Name */}
                                    <div>
                                        <label className="text-gray-400 text-sm">Habit Name *</label>
                                        <input type="text" value={newHabit.name} onChange={(e) => setNewHabit(p => ({ ...p, name: e.target.value }))} placeholder="e.g., Drink 8 glasses of water" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                    </div>
                                    {/* Description */}
                                    <div>
                                        <label className="text-gray-400 text-sm">Description (optional)</label>
                                        <input type="text" value={newHabit.description} onChange={(e) => setNewHabit(p => ({ ...p, description: e.target.value }))} placeholder="Why this habit matters" className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                    </div>
                                    {/* Category */}
                                    <div>
                                        <label className="text-gray-400 text-sm mb-2 block">Category</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {categories.map(cat => (
                                                <button key={cat.id} onClick={() => setNewHabit(p => ({ ...p, category: cat.id }))} className={`flex flex-col items-center gap-1 p-3 rounded-xl text-xs transition-all ${newHabit.category === cat.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400'}`}>
                                                    <i className={`fas ${cat.icon}`}></i>
                                                    <span>{cat.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    {/* Tracking Type */}
                                    <div>
                                        <label className="text-gray-400 text-sm mb-2 block">How to Track</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {trackingTypes.map(tt => (
                                                <button key={tt.id} onClick={() => setNewHabit(p => ({ ...p, trackingType: tt.id }))} className={`flex flex-col items-center gap-1 p-3 rounded-xl text-xs transition-all ${newHabit.trackingType === tt.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400'}`}>
                                                    <i className={`fas ${tt.icon}`}></i>
                                                    <span>{tt.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    {/* Target Value (if quantity/duration) */}
                                    {(newHabit.trackingType === 'quantity' || newHabit.trackingType === 'duration') && (
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-gray-400 text-sm">Target</label>
                                                <input type="number" value={newHabit.targetValue} onChange={(e) => setNewHabit(p => ({ ...p, targetValue: parseInt(e.target.value) || 1 }))} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none" />
                                            </div>
                                            <div>
                                                <label className="text-gray-400 text-sm">Unit</label>
                                                <input type="text" value={newHabit.unit} onChange={(e) => setNewHabit(p => ({ ...p, unit: e.target.value }))} placeholder={newHabit.trackingType === 'duration' ? 'minutes' : 'glasses'} className="w-full mt-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                            </div>
                                        </div>
                                    )}
                                    {/* Frequency */}
                                    <div>
                                        <label className="text-gray-400 text-sm mb-2 block">Frequency</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {frequencies.map(f => (
                                                <button key={f.id} onClick={() => setNewHabit(p => ({ ...p, frequency: f.id }))} className={`p-3 rounded-xl text-sm transition-all ${newHabit.frequency === f.id ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400'}`}>
                                                    {f.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    {/* Specific Days (if selected) */}
                                    {newHabit.frequency === 'specific-days' && (
                                        <div>
                                            <label className="text-gray-400 text-sm mb-2 block">Select Days</label>
                                            <div className="flex flex-wrap gap-2">
                                                {daysOfWeek.map(day => (
                                                    <button key={day} onClick={() => toggleDay(day)} className={`px-3 py-2 rounded-lg text-xs capitalize transition-all ${newHabit.specificDays.includes(day) ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400'}`}>
                                                        {day.slice(0, 3)}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-white/10 flex gap-3">
                                    <button onClick={() => setShowAddModal(false)} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Cancel</button>
                                    <button onClick={createHabit} disabled={creating || !newHabit.name.trim()} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl disabled:opacity-50">
                                        {creating ? <><i className="fas fa-spinner fa-spin mr-2"></i>Creating...</> : 'Create Habit'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Log Habit Progress Modal */}
                    {selectedHabit && (
                        <div className="fixed inset-0 bg-black/80 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setSelectedHabit(null)}>
                            <div className="glass rounded-2xl w-full max-w-sm p-5" onClick={e => e.stopPropagation()}>
                                <div className="text-center mb-6">
                                    <div className={`w-16 h-16 rounded-full mx-auto mb-3 flex items-center justify-center ${selectedHabit.completedToday ? 'bg-green-500' : 'bg-orange-500/20'}`}>
                                        <i className={`fas fa-${selectedHabit.trackingType === 'duration' ? 'clock' : 'hashtag'} text-2xl ${selectedHabit.completedToday ? 'text-white' : 'text-orange-500'}`}></i>
                                    </div>
                                    <h2 className="text-xl font-bold text-white">{selectedHabit.name}</h2>
                                    <p className="text-gray-400 text-sm mt-1">
                                        Target: {selectedHabit.targetValue} {selectedHabit.unit || (selectedHabit.trackingType === 'duration' ? 'minutes' : '')}
                                    </p>
                                </div>

                                <div className="mb-6">
                                    <label className="text-gray-400 text-sm mb-2 block">
                                        {selectedHabit.trackingType === 'duration' ? 'Minutes completed' : `How many ${selectedHabit.unit || 'units'}?`}
                                    </label>
                                    <div className="flex items-center gap-3">
                                        <button
                                            onClick={() => setLogValue(Math.max(0, (parseFloat(logValue) || 0) - 1).toString())}
                                            className="w-12 h-12 rounded-xl bg-white/10 text-white text-xl hover:bg-white/20"
                                        >-</button>
                                        <input
                                            type="number"
                                            value={logValue}
                                            onChange={e => setLogValue(e.target.value)}
                                            placeholder="0"
                                            className="flex-1 text-center text-3xl font-bold bg-white/10 border border-white/20 rounded-xl py-3 text-white focus:border-orange-500 focus:outline-none"
                                        />
                                        <button
                                            onClick={() => setLogValue(((parseFloat(logValue) || 0) + 1).toString())}
                                            className="w-12 h-12 rounded-xl bg-white/10 text-white text-xl hover:bg-white/20"
                                        >+</button>
                                    </div>
                                    {/* Quick add buttons */}
                                    <div className="flex justify-center gap-2 mt-3">
                                        {[1, 2, 5, 10].map(n => (
                                            <button
                                                key={n}
                                                onClick={() => setLogValue(((parseFloat(logValue) || 0) + n).toString())}
                                                className="px-3 py-1 rounded-lg bg-white/10 text-gray-400 text-sm hover:bg-orange-500/20 hover:text-orange-400"
                                            >+{n}</button>
                                        ))}
                                    </div>
                                </div>

                                {/* Progress bar */}
                                <div className="mb-6">
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="text-gray-400">Progress</span>
                                        <span className="text-orange-500">{Math.round(((parseFloat(logValue) || 0) / selectedHabit.targetValue) * 100)}%</span>
                                    </div>
                                    <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                                        <div
                                            className={`h-full transition-all ${(parseFloat(logValue) || 0) >= selectedHabit.targetValue ? 'bg-green-500' : 'bg-orange-500'}`}
                                            style={{ width: `${Math.min(100, ((parseFloat(logValue) || 0) / selectedHabit.targetValue) * 100)}%` }}
                                        />
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setSelectedHabit(null)} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Cancel</button>
                                    <button onClick={logHabitProgress} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl">
                                        <i className="fas fa-check mr-2"></i>Log
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ═══════════════════════════════════════════════════════════
        // PR CELEBRATION WITH CONFETTI
        // ═══════════════════════════════════════════════════════════

        const PRCelebration = ({ pr, onClose }) => {
            const [confetti, setConfetti] = useState([]);

            useEffect(() => {
                // Generate confetti particles
                const particles = [];
                for (let i = 0; i < 50; i++) {
                    particles.push({
                        id: i,
                        x: Math.random() * 100,
                        delay: Math.random() * 2,
                        duration: 2 + Math.random() * 2,
                        color: ['#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7'][Math.floor(Math.random() * 5)]
                    });
                }
                setConfetti(particles);

                // Auto-close after 4 seconds
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center" onClick={onClose}>
                    {/* Confetti */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        {confetti.map(p => (
                            <div key={p.id} className="absolute w-3 h-3 rounded-full animate-confetti" style={{
                                left: `${p.x}%`,
                                backgroundColor: p.color,
                                animationDelay: `${p.delay}s`,
                                animationDuration: `${p.duration}s`
                            }} />
                        ))}
                    </div>

                    {/* PR Card */}
                    <div className="glass rounded-3xl p-8 text-center max-w-sm mx-4 animate-bounce-in">
                        <div className="text-6xl mb-4 animate-pulse">🏆</div>
                        <h2 className="text-3xl font-black text-yellow-500 mb-2">NEW PR!</h2>
                        <p className="text-xl text-white font-bold mb-1">{pr.exerciseName}</p>
                        <p className="text-3xl text-orange-500 font-black">{pr.weight}lbs × {pr.reps}</p>
                        <p className="text-gray-400 mt-2">Est. 1RM: {pr.oneRepMax}lbs</p>
                        {pr.improvement && (
                            <div className="mt-4 bg-green-500/20 text-green-400 px-4 py-2 rounded-xl inline-block">
                                <i className="fas fa-arrow-up mr-2"></i>+{pr.improvement}lbs ({pr.improvementPercent}%)
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Main App
        const MainApp = ({ user, setUser, onLogout }) => {
            const [activeTab, setActiveTab] = useState('home');
            const [globalGenerating, setGlobalGenerating] = useState(false);
            const [globalGenerateMessage, setGlobalGenerateMessage] = useState(null);

            const renderContent = () => {
                switch(activeTab) {
                    case 'home': return <HomeTab user={user} />;
                    case 'calendar': return <CalendarTab user={user} globalGenerating={globalGenerating} setGlobalGenerating={setGlobalGenerating} setGlobalGenerateMessage={setGlobalGenerateMessage} setActiveTab={setActiveTab} />;
                    case 'forge': return <ForgeTab user={user} setActiveTab={setActiveTab} />;
                    case 'habits': return <HabitsTab user={user} />;
                    case 'kitchen': return <KitchenTab user={user} />;
                    case 'exercises': return <ExercisesTab user={user} />;
                    case 'profile': return <ProfileTab user={user} setUser={setUser} onLogout={onLogout} />;
                    default: return <HomeTab user={user} />;
                }
            };

            return (
                <div className="min-h-screen pb-20">
                    {/* Global FORGE Generation Banner */}
                    {globalGenerating && (
                        <div className="fixed top-0 left-0 right-0 bg-gradient-to-r from-orange-600 via-red-500 to-orange-600 p-3 z-50 shadow-lg">
                            <div className="flex items-center justify-center gap-3">
                                <span className="text-2xl forge-hammering">🔨</span>
                                <span className="text-white font-bold forge-glowing">FORGE is crafting your program...</span>
                                <div className="flex gap-1">
                                    <span className="forge-spark text-yellow-300" style={{animationDelay: '0s'}}>✨</span>
                                    <span className="forge-spark text-yellow-300" style={{animationDelay: '0.2s'}}>✨</span>
                                    <span className="forge-spark text-yellow-300" style={{animationDelay: '0.4s'}}>✨</span>
                                </div>
                            </div>
                        </div>
                    )}
                    {globalGenerateMessage && (
                        <div className={`fixed top-0 left-0 right-0 p-3 z-50 ${globalGenerateMessage.type === 'success' ? 'bg-green-600' : globalGenerateMessage.type === 'error' ? 'bg-red-600' : 'bg-orange-500'}`}>
                            <div className="flex items-center justify-center gap-2">
                                <i className={`fas ${globalGenerateMessage.type === 'success' ? 'fa-check-circle' : globalGenerateMessage.type === 'error' ? 'fa-exclamation-circle' : 'fa-hammer fa-bounce'} text-white`}></i>
                                <span className="text-white font-medium">{globalGenerateMessage.text}</span>
                            </div>
                        </div>
                    )}
                    <div className={`max-w-lg mx-auto px-4 py-6 ${globalGenerating || globalGenerateMessage ? 'pt-16' : ''}`}>{renderContent()}</div>

                    {/* Workout Builder FAB - Available for all user types */}
                    <WorkoutBuilderFAB user={user} />

                    <nav className="fixed bottom-0 left-0 right-0 glass-dark border-t border-white/10">
                        <div className="max-w-lg mx-auto flex justify-around py-2">
                            {[
                                { id: 'home', icon: 'fa-home', label: 'Home' },
                                { id: 'calendar', icon: 'fa-calendar-alt', label: 'Calendar' },
                                { id: 'forge', icon: 'fa-bolt', label: 'FORGE' },
                                { id: 'kitchen', icon: 'fa-utensils', label: 'Kitchen' },
                                { id: 'exercises', icon: 'fa-dumbbell', label: 'Exercises' },
                                { id: 'profile', icon: 'fa-user', label: 'Profile' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${activeTab === tab.id ? 'text-orange-500 bg-orange-500/10' : 'text-gray-500 hover:text-gray-300'}`}>
                                    <i className={`fas ${tab.icon} text-lg`}></i>
                                    <span className="text-[10px]">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        // Workout Session Modal - Full workout logging experience
        const WorkoutSessionModal = ({ workout, onClose, onComplete }) => {
            const [exercises, setExercises] = useState(workout?.exercises || []);
            const [currentExercise, setCurrentExercise] = useState(0);
            const [currentSet, setCurrentSet] = useState(0);
            const [setData, setSetData] = useState({ weight: '', reps: '', rpe: 7 });
            const [restTimer, setRestTimer] = useState(null);
            const [restSeconds, setRestSeconds] = useState(90);
            const [showComplete, setShowComplete] = useState(false);
            const [mood, setMood] = useState(3);
            const [notes, setNotes] = useState('');
            const [completing, setCompleting] = useState(false);
            const [startTime] = useState(Date.now());
            // PR Tracking
            const [personalRecords, setPersonalRecords] = useState({});
            const [newPRs, setNewPRs] = useState([]);
            const [showPRCelebration, setShowPRCelebration] = useState(null);
            // Exercise swap
            const [showSwapModal, setShowSwapModal] = useState(false);
            const [swapAlternatives, setSwapAlternatives] = useState([]);
            const [loadingAlternatives, setLoadingAlternatives] = useState(false);

            const loadAlternatives = async (exerciseName) => {
                setLoadingAlternatives(true);
                try {
                    const data = await api.get(`/exercises/alternatives?exercise=${encodeURIComponent(exerciseName)}`);
                    setSwapAlternatives(data.data || data.alternatives || [
                        { name: 'Dumbbell ' + exerciseName, muscle: 'Same target muscle' },
                        { name: 'Machine ' + exerciseName, muscle: 'Same target muscle' },
                        { name: 'Cable ' + exerciseName, muscle: 'Same target muscle' }
                    ]);
                } catch (err) {
                    // Fallback alternatives
                    setSwapAlternatives([
                        { name: 'Dumbbell Variation', muscle: 'Same target' },
                        { name: 'Machine Variation', muscle: 'Same target' },
                        { name: 'Bodyweight Variation', muscle: 'Same target' }
                    ]);
                }
                setLoadingAlternatives(false);
                setShowSwapModal(true);
            };

            const swapExercise = (newExerciseName) => {
                const updated = [...exercises];
                updated[currentExercise] = {
                    ...updated[currentExercise],
                    name: newExerciseName,
                    swappedFrom: exercises[currentExercise].name
                };
                setExercises(updated);
                setShowSwapModal(false);
            };

            // Calculate estimated 1RM using Brzycki formula
            const calculate1RM = (weight, reps) => {
                if (reps <= 0 || weight <= 0) return 0;
                if (reps === 1) return weight;
                return Math.round(weight / (1.0278 - 0.0278 * reps));
            };

            // Fetch existing PRs on mount
            useEffect(() => {
                const fetchPRs = async () => {
                    try {
                        const data = await api.get('/users/prs');
                        if (data.data?.personalRecords) {
                            const prMap = {};
                            data.data.personalRecords.forEach(pr => {
                                prMap[pr.exerciseName.toLowerCase()] = pr;
                            });
                            setPersonalRecords(prMap);
                        }
                    } catch (err) { console.error('Failed to fetch PRs:', err); }
                };
                fetchPRs();
            }, []);

            // Parse exercises from workout description if not structured
            useEffect(() => {
                if (!workout?.exercises?.length && workout?.description) {
                    const parsed = workout.description.split('\n')
                        .filter(line => line.trim())
                        .map((line, i) => ({
                            name: line.replace(/^[-•]\s*/, '').trim(),
                            sets: 3,
                            reps: 10,
                            weight: 0,
                            actualSets: []
                        }));
                    if (parsed.length) setExercises(parsed);
                }
            }, [workout]);

            // Rest timer countdown
            useEffect(() => {
                if (restTimer !== null && restSeconds > 0) {
                    const t = setTimeout(() => setRestSeconds(s => s - 1), 1000);
                    return () => clearTimeout(t);
                } else if (restTimer !== null && restSeconds === 0) {
                    setRestTimer(null);
                    setRestSeconds(90);
                }
            }, [restTimer, restSeconds]);

            const logSet = () => {
                const weight = parseFloat(setData.weight) || 0;
                const reps = parseInt(setData.reps) || 0;
                const exerciseName = exercises[currentExercise]?.name || '';

                const updated = [...exercises];
                if (!updated[currentExercise].actualSets) updated[currentExercise].actualSets = [];
                updated[currentExercise].actualSets.push({
                    weight,
                    reps,
                    rpe: setData.rpe
                });
                setExercises(updated);

                // Check for PR
                if (weight > 0 && reps > 0 && exerciseName) {
                    const new1RM = calculate1RM(weight, reps);
                    const existingPR = personalRecords[exerciseName.toLowerCase()];
                    const existing1RM = existingPR?.oneRepMax || 0;

                    if (new1RM > existing1RM) {
                        // New PR!
                        const prData = { exerciseName, weight, reps, oneRepMax: new1RM };
                        setShowPRCelebration(prData);
                        setNewPRs(prev => [...prev.filter(p => p.exerciseName.toLowerCase() !== exerciseName.toLowerCase()), prData]);
                        setPersonalRecords(prev => ({ ...prev, [exerciseName.toLowerCase()]: prData }));
                        setTimeout(() => setShowPRCelebration(null), 3000);
                    }
                }

                setSetData({ weight: setData.weight, reps: '', rpe: 7 });

                if (currentSet + 1 >= (exercises[currentExercise]?.sets || 3)) {
                    if (currentExercise + 1 >= exercises.length) {
                        setShowComplete(true);
                    } else {
                        setCurrentExercise(currentExercise + 1);
                        setCurrentSet(0);
                        setRestTimer(Date.now());
                    }
                } else {
                    setCurrentSet(currentSet + 1);
                    setRestTimer(Date.now());
                }
            };

            const completeWorkout = async () => {
                setCompleting(true);
                try {
                    const duration = Math.round((Date.now() - startTime) / 60000);
                    await api.post(`/calendar/${workout._id}/complete`, { duration, mood, notes });

                    // Save new PRs to backend
                    if (newPRs.length > 0) {
                        await api.post('/users/prs', { newPRs }).catch(err => console.error('Save PRs error:', err));
                    }

                    onComplete?.();
                    onClose();
                } catch (err) {
                    console.error('Complete workout error:', err);
                }
                setCompleting(false);
            };

            const exercise = exercises[currentExercise];
            const progress = exercises.length ? Math.round((currentExercise / exercises.length) * 100) : 0;

            // Calculate workout stats
            const getWorkoutStats = () => {
                let totalSets = 0, totalReps = 0, totalVolume = 0;
                exercises.forEach(ex => {
                    if (ex.actualSets) {
                        ex.actualSets.forEach(set => {
                            totalSets++;
                            totalReps += set.reps || 0;
                            totalVolume += (set.weight || 0) * (set.reps || 0);
                        });
                    }
                });
                const duration = Math.round((Date.now() - startTime) / 60000);
                return { totalSets, totalReps, totalVolume, duration };
            };

            if (showComplete) {
                const stats = getWorkoutStats();
                return (
                    <div className="fixed inset-0 bg-black z-50 flex flex-col">
                        <div className="flex-1 flex flex-col items-center justify-center p-6 overflow-y-auto">
                            <i className="fas fa-trophy text-6xl text-orange-500 mb-4"></i>
                            <h2 className="text-2xl font-bold text-white mb-2">Workout Complete!</h2>

                            {/* Workout Stats Summary */}
                            <div className="w-full grid grid-cols-4 gap-2 mb-4">
                                <div className="bg-white/10 rounded-xl p-3 text-center">
                                    <div className="text-xl font-bold text-orange-500">{stats.duration}</div>
                                    <div className="text-xs text-gray-400">min</div>
                                </div>
                                <div className="bg-white/10 rounded-xl p-3 text-center">
                                    <div className="text-xl font-bold text-blue-400">{stats.totalSets}</div>
                                    <div className="text-xs text-gray-400">sets</div>
                                </div>
                                <div className="bg-white/10 rounded-xl p-3 text-center">
                                    <div className="text-xl font-bold text-green-400">{stats.totalReps}</div>
                                    <div className="text-xs text-gray-400">reps</div>
                                </div>
                                <div className="bg-white/10 rounded-xl p-3 text-center">
                                    <div className="text-xl font-bold text-purple-400">{stats.totalVolume >= 1000 ? `${(stats.totalVolume/1000).toFixed(1)}k` : stats.totalVolume}</div>
                                    <div className="text-xs text-gray-400">lbs</div>
                                </div>
                            </div>

                            {/* Show PRs hit during session */}
                            {newPRs.length > 0 && (
                                <div className="w-full bg-yellow-500/20 border border-yellow-500/30 rounded-xl p-4 mb-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <i className="fas fa-crown text-yellow-500"></i>
                                        <span className="text-yellow-500 font-bold">{newPRs.length} New PR{newPRs.length > 1 ? 's' : ''}!</span>
                                    </div>
                                    {newPRs.map((pr, i) => (
                                        <div key={i} className="text-sm text-yellow-400/80">
                                            {pr.exerciseName}: {pr.weight}lbs × {pr.reps} (Est. 1RM: {pr.oneRepMax}lbs)
                                        </div>
                                    ))}
                                </div>
                            )}

                            <p className="text-gray-400 mb-4">How did it feel?</p>
                            <div className="flex gap-3 mb-6">
                                {[1,2,3,4,5].map(n => (
                                    <button key={n} onClick={() => setMood(n)} className={`w-12 h-12 rounded-full flex items-center justify-center text-xl transition-all ${mood === n ? 'bg-orange-500 scale-110' : 'bg-white/10'}`}>
                                        {n === 1 ? '😫' : n === 2 ? '😕' : n === 3 ? '😐' : n === 4 ? '😊' : '🔥'}
                                    </button>
                                ))}
                            </div>
                            <textarea value={notes} onChange={e => setNotes(e.target.value)} placeholder="Notes (optional)" className="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white mb-6 h-24" />
                            <button onClick={completeWorkout} disabled={completing} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl">
                                {completing ? 'Saving...' : 'Save Workout'}
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    {/* Header */}
                    <div className="glass p-4 flex items-center justify-between">
                        <button onClick={onClose} className="text-gray-400 hover:text-white"><i className="fas fa-times text-xl"></i></button>
                        <div className="text-center">
                            <h2 className="text-white font-bold">{workout?.title || 'Workout'}</h2>
                            <p className="text-xs text-gray-400">{progress}% complete</p>
                        </div>
                        <button onClick={() => setShowComplete(true)} className="text-orange-500 text-sm">Finish</button>
                    </div>

                    {/* Progress bar */}
                    <div className="h-1 bg-white/10"><div className="h-full bg-orange-500 transition-all" style={{width: `${progress}%`}}></div></div>

                    {/* PR Celebration Overlay */}
                    {showPRCelebration && (
                        <div className="absolute inset-0 bg-yellow-500/20 flex flex-col items-center justify-center z-20 animate-pulse">
                            <i className="fas fa-crown text-8xl text-yellow-500 mb-4 animate-bounce"></i>
                            <h2 className="text-3xl font-bold text-yellow-500 mb-2">NEW PR!</h2>
                            <p className="text-xl text-white mb-2">{showPRCelebration.exerciseName}</p>
                            <p className="text-2xl font-bold text-yellow-400">{showPRCelebration.weight}lbs × {showPRCelebration.reps}</p>
                            <p className="text-gray-400 mt-2">Est. 1RM: {showPRCelebration.oneRepMax}lbs</p>
                        </div>
                    )}

                    {/* Exercise Swap Modal */}
                    {showSwapModal && (
                        <div className="absolute inset-0 bg-black/95 flex flex-col z-30 p-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-white font-bold text-lg">Swap Exercise</h3>
                                <button onClick={() => setShowSwapModal(false)} className="text-gray-400 hover:text-white">
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <p className="text-gray-400 text-sm mb-4">Choose an alternative for <span className="text-orange-500">{exercise?.name}</span></p>
                            <div className="flex-1 overflow-y-auto space-y-2">
                                {swapAlternatives.map((alt, i) => (
                                    <button key={i} onClick={() => swapExercise(alt.name)} className="w-full bg-white/10 hover:bg-white/20 border border-white/10 rounded-xl p-4 text-left transition-all">
                                        <div className="text-white font-medium">{alt.name}</div>
                                        {alt.muscle && <div className="text-gray-400 text-sm">{alt.muscle}</div>}
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setShowSwapModal(false)} className="mt-4 w-full bg-white/10 text-gray-400 py-3 rounded-xl">Cancel</button>
                        </div>
                    )}

                    {/* Rest Timer Overlay */}
                    {restTimer && !showPRCelebration && (
                        <div className="absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-10">
                            <p className="text-gray-400 mb-2">Rest</p>
                            <div className="text-6xl font-bold text-orange-500 mb-4">{restSeconds}s</div>
                            <button onClick={() => { setRestTimer(null); setRestSeconds(90); }} className="text-gray-400 hover:text-white">Skip Rest</button>
                        </div>
                    )}

                    {/* Current Exercise */}
                    <div className="flex-1 overflow-y-auto p-4">
                        {exercise ? (
                            <div className="space-y-4">
                                <div className="text-center mb-6">
                                    <div className="flex items-center justify-center gap-2 mb-1">
                                        <h3 className="text-xl font-bold text-white">{exercise.name}</h3>
                                        <button onClick={() => loadAlternatives(exercise.name)} disabled={loadingAlternatives} className="text-gray-400 hover:text-orange-500 p-1">
                                            <i className={`fas ${loadingAlternatives ? 'fa-spinner fa-spin' : 'fa-exchange-alt'}`}></i>
                                        </button>
                                    </div>
                                    <p className="text-gray-400">Set {currentSet + 1} of {exercise.sets || 3}</p>
                                    {exercise.swappedFrom && <p className="text-xs text-orange-400">Swapped from {exercise.swappedFrom}</p>}
                                </div>

                                <div className="glass rounded-2xl p-4 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-gray-400 text-sm mb-1 block">Weight (lbs)</label>
                                            <input type="number" value={setData.weight} onChange={e => setSetData({...setData, weight: e.target.value})} placeholder={exercise.weight || '135'} className="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white text-center text-xl" />
                                        </div>
                                        <div>
                                            <label className="text-gray-400 text-sm mb-1 block">Reps</label>
                                            <input type="number" value={setData.reps} onChange={e => setSetData({...setData, reps: e.target.value})} placeholder={exercise.reps || '10'} className="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white text-center text-xl" />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-gray-400 text-sm mb-2 block">RPE (1-10): {setData.rpe}</label>
                                        <input type="range" min="1" max="10" value={setData.rpe} onChange={e => setSetData({...setData, rpe: parseInt(e.target.value)})} className="w-full accent-orange-500" />
                                        <div className="flex justify-between text-xs text-gray-500 mt-1"><span>Easy</span><span>Max effort</span></div>
                                    </div>
                                </div>

                                <button onClick={logSet} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl text-lg">
                                    Log Set <i className="fas fa-check ml-2"></i>
                                </button>

                                {/* Logged sets */}
                                {exercise.actualSets?.length > 0 && (
                                    <div className="glass rounded-xl p-3">
                                        <p className="text-gray-400 text-sm mb-2">Logged Sets</p>
                                        <div className="space-y-1">
                                            {exercise.actualSets.map((s, i) => (
                                                <div key={i} className="flex justify-between text-sm">
                                                    <span className="text-gray-400">Set {i+1}</span>
                                                    <span className="text-white">{s.weight}lbs × {s.reps} @ RPE {s.rpe}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="text-center py-12 text-gray-400">No exercises found</div>
                        )}
                    </div>

                    {/* Exercise list */}
                    <div className="glass p-3 border-t border-white/10">
                        <div className="flex gap-2 overflow-x-auto pb-2">
                            {exercises.map((ex, i) => (
                                <button key={i} onClick={() => { setCurrentExercise(i); setCurrentSet(0); }} className={`flex-shrink-0 px-3 py-2 rounded-lg text-xs ${i === currentExercise ? 'bg-orange-500 text-white' : i < currentExercise ? 'bg-green-500/20 text-green-400' : 'bg-white/10 text-gray-400'}`}>
                                    {i < currentExercise && <i className="fas fa-check mr-1"></i>}
                                    {ex.name?.substring(0, 15)}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Check-In Modal - Daily readiness assessment
        const CheckInModal = ({ user, onClose, onComplete }) => {
            const [sleep, setSleep] = useState(3);
            const [energy, setEnergy] = useState(3);
            const [soreness, setSoreness] = useState(3);
            const [stress, setStress] = useState(3);
            const [weight, setWeight] = useState('');
            const [notes, setNotes] = useState('');
            const [submitting, setSubmitting] = useState(false);
            const [result, setResult] = useState(null);
            // Habit tracking
            const [waterCups, setWaterCups] = useState(0);
            const [sleepHours, setSleepHours] = useState('');
            const [supplements, setSupplements] = useState({ protein: false, creatine: false, vitamins: false, preworkout: false });
            // Progress photo
            const [progressPhoto, setProgressPhoto] = useState(null);
            const photoInputRef = useRef(null);

            const handlePhotoCapture = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setProgressPhoto(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const sliders = [
                { label: 'Sleep Quality', value: sleep, setValue: setSleep, low: 'Poor', high: 'Great', icon: 'fa-moon' },
                { label: 'Energy Level', value: energy, setValue: setEnergy, low: 'Low', high: 'High', icon: 'fa-bolt' },
                { label: 'Muscle Soreness', value: soreness, setValue: setSoreness, low: 'Very Sore', high: 'Fresh', icon: 'fa-dumbbell' },
                { label: 'Stress Level', value: stress, setValue: setStress, low: 'High', high: 'Low', icon: 'fa-brain' }
            ];

            const submit = async () => {
                setSubmitting(true);
                try {
                    const res = await api.post('/check-ins', {
                        userId: user._id || user.id,
                        sleep, energy, soreness, stress,
                        weight: weight ? parseFloat(weight) : undefined,
                        notes,
                        date: new Date().toISOString().split('T')[0],
                        // Habit tracking data
                        habits: {
                            waterCups,
                            sleepHours: sleepHours ? parseFloat(sleepHours) : undefined,
                            supplements: Object.entries(supplements).filter(([k, v]) => v).map(([k]) => k)
                        },
                        // Progress photo (base64)
                        progressPhoto: progressPhoto || undefined
                    });
                    setResult(res);
                } catch (err) {
                    console.error('Check-in error:', err);
                    setResult({ readinessScore: Math.round((sleep + energy + soreness + stress) / 4 * 20), recommendation: 'Data saved locally.' });
                }
                setSubmitting(false);
            };

            if (result) {
                const score = result.readinessScore || result.data?.readinessScore || 50;
                const getScoreColor = () => score >= 70 ? 'text-green-400' : score >= 40 ? 'text-orange-400' : 'text-red-400';
                return (
                    <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                        <div className="glass rounded-2xl p-6 w-full max-w-md text-center">
                            <div className={`text-6xl font-bold ${getScoreColor()} mb-2`}>{score}</div>
                            <p className="text-gray-400 mb-4">Readiness Score</p>
                            <div className="glass rounded-xl p-4 mb-6 text-left">
                                <p className="text-white text-sm">
                                    {score >= 70 ? "You're ready to train hard today. Go get it." :
                                     score >= 40 ? "Moderate readiness. Consider adjusting intensity based on how you feel during warmup." :
                                     "Low readiness detected. Consider a lighter session or active recovery."}
                                </p>
                            </div>
                            <button onClick={() => { onComplete?.(); onClose(); }} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl">Done</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                    <div className="glass rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">Daily Check-In</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><i className="fas fa-times"></i></button>
                        </div>

                        <div className="space-y-5">
                            {sliders.map(({ label, value, setValue, low, high, icon }) => (
                                <div key={label}>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="text-white text-sm flex items-center gap-2">
                                            <i className={`fas ${icon} text-orange-500`}></i>{label}
                                        </label>
                                        <span className="text-orange-500 font-bold">{value}/5</span>
                                    </div>
                                    <input type="range" min="1" max="5" value={value} onChange={e => setValue(parseInt(e.target.value))} className="w-full accent-orange-500" />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>{low}</span><span>{high}</span>
                                    </div>
                                </div>
                            ))}

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-white text-sm mb-2 block">Weight (lbs)</label>
                                    <input type="number" value={weight} onChange={e => setWeight(e.target.value)} placeholder="175" className="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white" />
                                </div>
                                <div>
                                    <label className="text-white text-sm mb-2 block">Sleep (hrs)</label>
                                    <input type="number" step="0.5" value={sleepHours} onChange={e => setSleepHours(e.target.value)} placeholder="7.5" className="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white" />
                                </div>
                            </div>

                            {/* Water Intake */}
                            <div>
                                <label className="text-white text-sm mb-2 flex items-center gap-2">
                                    <i className="fas fa-tint text-blue-400"></i>Water Intake
                                </label>
                                <div className="flex items-center gap-2">
                                    {[1,2,3,4,5,6,7,8].map(n => (
                                        <button key={n} onClick={() => setWaterCups(n)} className={`w-8 h-8 rounded-full flex items-center justify-center text-xs transition-all ${n <= waterCups ? 'bg-blue-500 text-white' : 'bg-white/10 text-gray-400'}`}>
                                            <i className="fas fa-tint"></i>
                                        </button>
                                    ))}
                                    <span className="text-gray-400 text-sm ml-2">{waterCups}/8 cups</span>
                                </div>
                            </div>

                            {/* Supplements */}
                            <div>
                                <label className="text-white text-sm mb-2 flex items-center gap-2">
                                    <i className="fas fa-pills text-purple-400"></i>Supplements Taken
                                </label>
                                <div className="flex flex-wrap gap-2">
                                    {Object.entries({ protein: 'Protein', creatine: 'Creatine', vitamins: 'Vitamins', preworkout: 'Pre-Workout' }).map(([key, label]) => (
                                        <button key={key} onClick={() => setSupplements(prev => ({ ...prev, [key]: !prev[key] }))} className={`px-3 py-2 rounded-lg text-sm transition-all ${supplements[key] ? 'bg-purple-500 text-white' : 'bg-white/10 text-gray-400'}`}>
                                            {supplements[key] && <i className="fas fa-check mr-1"></i>}{label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Progress Photo */}
                            <div>
                                <label className="text-white text-sm mb-2 flex items-center gap-2">
                                    <i className="fas fa-camera text-orange-400"></i>Progress Photo (optional)
                                </label>
                                <input type="file" accept="image/*" capture="environment" ref={photoInputRef} onChange={handlePhotoCapture} className="hidden" />
                                {progressPhoto ? (
                                    <div className="relative">
                                        <img src={progressPhoto} alt="Progress" className="w-full h-48 object-cover rounded-xl" />
                                        <button onClick={() => setProgressPhoto(null)} className="absolute top-2 right-2 w-8 h-8 bg-black/70 rounded-full flex items-center justify-center text-white hover:bg-red-500">
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={() => photoInputRef.current?.click()} className="w-full bg-white/10 border border-dashed border-white/30 rounded-xl p-6 flex flex-col items-center gap-2 hover:bg-white/15 transition-all">
                                        <i className="fas fa-camera text-2xl text-gray-400"></i>
                                        <span className="text-gray-400 text-sm">Tap to take photo</span>
                                    </button>
                                )}
                            </div>

                            <div>
                                <label className="text-white text-sm mb-2 block">Notes (optional)</label>
                                <textarea value={notes} onChange={e => setNotes(e.target.value)} placeholder="How are you feeling today?" className="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white h-20" />
                            </div>
                        </div>

                        <button onClick={submit} disabled={submitting} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl mt-6">
                            {submitting ? 'Submitting...' : 'Submit Check-In'}
                        </button>
                    </div>
                </div>
            );
        };

        // Subscription Modal - Stripe checkout
        const SubscriptionModal = ({ user, onClose }) => {
            const [loading, setLoading] = useState(false);
            const isPro = user?.subscription?.plan === 'pro' && user?.subscription?.status === 'active';
            const trialDaysLeft = user?.subscription?.trialEndsAt ? Math.max(0, Math.ceil((new Date(user.subscription.trialEndsAt) - new Date()) / (1000*60*60*24))) : 0;

            const handleUpgrade = async () => {
                setLoading(true);
                try {
                    const res = await api.post('/subscriptions/checkout', {
                        priceKey: 'pro_monthly',
                        successUrl: window.location.origin + '?success=true',
                        cancelUrl: window.location.origin + '?canceled=true'
                    });
                    if (res.url || res.data?.url) {
                        window.location.href = res.url || res.data.url;
                    } else {
                        throw new Error('No checkout URL returned');
                    }
                } catch (err) {
                    console.error('Checkout error:', err);
                    alert(err.message || 'Could not start checkout. Please try again.');
                }
                setLoading(false);
            };

            const handleManage = async () => {
                setLoading(true);
                try {
                    const res = await api.post('/subscriptions/portal');
                    if (res.url || res.data?.url) {
                        window.location.href = res.url || res.data.url;
                    }
                } catch (err) {
                    console.error('Portal error:', err);
                    alert('Could not open portal. Please try again.');
                }
                setLoading(false);
            };

            const proFeatures = [
                { icon: 'fa-brain', text: 'Unlimited AI coaching conversations' },
                { icon: 'fa-calendar-alt', text: 'Full workout program generation' },
                { icon: 'fa-utensils', text: 'Personalized meal plans' },
                { icon: 'fa-chart-line', text: 'Advanced progress analytics' },
                { icon: 'fa-watch', text: 'Wearable data integration' },
                { icon: 'fa-dumbbell', text: 'Custom exercise library' }
            ];

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                    <div className="glass rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">ClockWork Pro</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><i className="fas fa-times"></i></button>
                        </div>

                        {isPro ? (
                            <div className="text-center">
                                <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4">
                                    <i className="fas fa-crown text-2xl text-green-400"></i>
                                </div>
                                <h3 className="text-white font-bold text-lg mb-2">You're on Pro!</h3>
                                <p className="text-gray-400 text-sm mb-6">You have access to all premium features.</p>
                                <button onClick={handleManage} disabled={loading} className="w-full bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl transition-colors">
                                    {loading ? 'Loading...' : 'Manage Subscription'}
                                </button>
                            </div>
                        ) : (
                            <>
                                <div className="text-center mb-6">
                                    <div className="text-4xl font-bold text-white">$9.99<span className="text-lg text-gray-400">/mo</span></div>
                                    {trialDaysLeft > 0 && <p className="text-orange-400 text-sm mt-2">{trialDaysLeft} days left in trial</p>}
                                </div>

                                <div className="space-y-3 mb-6">
                                    {proFeatures.map(({ icon, text }) => (
                                        <div key={text} className="flex items-center gap-3">
                                            <i className={`fas ${icon} text-orange-500 w-5`}></i>
                                            <span className="text-white text-sm">{text}</span>
                                        </div>
                                    ))}
                                </div>

                                <button onClick={handleUpgrade} disabled={loading} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition-colors mb-3">
                                    {loading ? 'Loading...' : 'Upgrade to Pro'}
                                </button>
                                <p className="text-center text-gray-500 text-xs">Cancel anytime. No commitment.</p>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // Home Tab
        // STREAM 4: NAVIGATION INTEGRATION ================================
        // Add Workout Builder FAB for all user types
        const WorkoutBuilderFAB = ({ user }) => {
            const [showBuilder, setShowBuilder] = useState(false);

            return (
                <>
                    <button
                        onClick={() => setShowBuilder(true)}
                        className="fixed bottom-24 right-6 w-14 h-14 bg-orange-500 hover:bg-orange-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all z-40 glow"
                        title="Create Workout"
                    >
                        <i className="fas fa-plus text-xl"></i>
                    </button>

                    <WorkoutBuilder
                        isOpen={showBuilder}
                        onClose={() => setShowBuilder(false)}
                        user={user}
                    />
                </>
            );
        };

        // Coach Dashboard - Shows pending clients and active clients
        const CoachDashboard = ({ user }) => {
            const [pendingClients, setPendingClients] = useState([]);
            const [activeClients, setActiveClients] = useState([]);
            const [loading, setLoading] = useState(true);
            const [processing, setProcessing] = useState(null);

            useEffect(() => {
                loadClients();
            }, []);

            // Real-time socket listener
            useEffect(() => {
                const socket = getSocket();
                if (!socket) return;

                // Subscribe to coach updates
                socket.emit('coach:subscribe');
                console.log('[Coach] Subscribed to real-time updates');

                // Listen for new client requests
                socket.on('coach:new-client-request', (data) => {
                    console.log('[Coach] New client request:', data);
                    // Reload clients to show new pending request
                    loadClients();
                    alert(`New client request from ${data.client.name || data.client.email}!`);
                });

                // Listen for client workout completions
                socket.on('coach:client-workout-complete', (data) => {
                    console.log('[Coach] Client completed workout:', data);
                    alert(`${data.workout.clientName} completed ${data.workout.name}!`);
                });

                // Cleanup
                return () => {
                    socket.off('coach:new-client-request');
                    socket.off('coach:client-workout-complete');
                };
            }, []);

            const loadClients = async () => {
                setLoading(true);
                try {
                    const res = await api.get('/coach/clients');
                    // Separate by status
                    const clients = res.clients || [];
                    setPendingClients(clients.filter(c => c.status === 'pending'));
                    setActiveClients(clients.filter(c => c.status === 'active'));
                } catch (err) {
                    console.error('Failed to load clients:', err);
                }
                setLoading(false);
            };

            const handleApprove = async (relationshipId) => {
                setProcessing(relationshipId);
                try {
                    await api.put(`/coach/clients/${relationshipId}/approve`);
                    await loadClients(); // Reload
                    alert('✓ Client approved!');
                } catch (err) {
                    alert('Failed to approve: ' + err.message);
                }
                setProcessing(null);
            };

            const handleReject = async (relationshipId) => {
                if (!confirm('Are you sure you want to reject this client request?')) return;
                setProcessing(relationshipId);
                try {
                    await api.delete(`/coach/clients/${relationshipId}`);
                    await loadClients(); // Reload
                    alert('✓ Client request rejected');
                } catch (err) {
                    alert('Failed to reject: ' + err.message);
                }
                setProcessing(null);
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-3"></div>
                            <p className="text-gray-400">Loading dashboard...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6 pb-24">
                    {/* Header */}
                    <div className="text-center">
                        <h1 className="text-3xl font-bold text-white mb-2">
                            👨‍🏫 Coach Dashboard
                        </h1>
                        <p className="text-gray-400">Manage your clients and programs</p>
                    </div>

                    {/* Stats */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="glass rounded-2xl p-4">
                            <div className="text-gray-400 text-sm mb-1">Active Clients</div>
                            <div className="text-3xl font-bold text-white">{activeClients.length}</div>
                        </div>
                        <div className="glass rounded-2xl p-4">
                            <div className="text-gray-400 text-sm mb-1">Pending Requests</div>
                            <div className="text-3xl font-bold text-orange-500">{pendingClients.length}</div>
                        </div>
                    </div>

                    {/* Pending Client Requests - Coming Soon */}
                    {pendingClients.length > 0 && (
                        <div className="relative opacity-50 pointer-events-none">
                            <div className="absolute inset-0 flex items-center justify-center z-10 bg-black/30 rounded-2xl backdrop-blur-sm">
                                <div className="text-center">
                                    <p className="text-white font-bold text-lg">Coming Soon</p>
                                    <p className="text-gray-300 text-sm">Coach/Client features launching Q1 2026</p>
                                </div>
                            </div>
                            <h2 className="text-white font-semibold text-lg mb-3 flex items-center gap-2 line-through opacity-50">
                                <i className="fas fa-clock text-orange-500"></i>
                                Pending Approvals ({pendingClients.length})
                            </h2>
                            <div className="space-y-3">
                                {pendingClients.map(relationship => (
                                    <div key={relationship._id} className="glass rounded-2xl p-4">
                                        <div className="flex items-start justify-between mb-3">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white font-bold text-lg">
                                                    {relationship.client?.name?.charAt(0).toUpperCase() || '?'}
                                                </div>
                                                <div>
                                                    <h3 className="text-white font-semibold">{relationship.client?.name || 'Unknown'}</h3>
                                                    <p className="text-gray-400 text-sm">{relationship.client?.email}</p>
                                                    <p className="text-gray-500 text-xs mt-1">
                                                        Requested {new Date(relationship.invitedAt).toLocaleDateString()}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => handleApprove(relationship._id)}
                                                disabled={processing === relationship._id}
                                                className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-xl font-medium transition-all disabled:opacity-50"
                                            >
                                                <i className="fas fa-check mr-2"></i>
                                                {processing === relationship._id ? 'Approving...' : 'Approve'}
                                            </button>
                                            <button
                                                onClick={() => handleReject(relationship._id)}
                                                disabled={processing === relationship._id}
                                                className="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 rounded-xl font-medium transition-all disabled:opacity-50"
                                            >
                                                <i className="fas fa-times mr-2"></i>
                                                Reject
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Active Clients - Coming Soon */}
                    {activeClients.length > 0 && (
                        <div className="relative opacity-50 pointer-events-none">
                            <div className="absolute inset-0 flex items-center justify-center z-10 bg-black/30 rounded-2xl backdrop-blur-sm">
                                <div className="text-center">
                                    <p className="text-white font-bold text-lg">Coming Soon</p>
                                    <p className="text-gray-300 text-sm">Coach/Client features launching Q1 2026</p>
                                </div>
                            </div>
                            <h2 className="text-white font-semibold text-lg mb-3 flex items-center gap-2 line-through opacity-50">
                                <i className="fas fa-users text-green-500"></i>
                                Active Clients ({activeClients.length})
                            </h2>
                            <div className="grid grid-cols-2 gap-3">
                                {activeClients.map(relationship => (
                                    <div key={relationship._id} className="glass rounded-2xl p-4">
                                        <div className="flex flex-col items-center text-center">
                                            <div className="w-16 h-16 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center text-white font-bold text-xl mb-2">
                                                {relationship.client?.name?.charAt(0).toUpperCase() || '?'}
                                            </div>
                                            <h3 className="text-white font-semibold text-sm">{relationship.client?.name || 'Unknown'}</h3>
                                            <p className="text-gray-500 text-xs mt-1">
                                                {relationship.durationDays || 0} days
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Empty State - Coming Soon */}
                    {pendingClients.length === 0 && activeClients.length === 0 && (
                        <div className="glass rounded-2xl p-8 text-center relative opacity-50 pointer-events-none">
                            <div className="absolute inset-0 flex items-center justify-center z-10 bg-black/30 rounded-2xl backdrop-blur-sm">
                                <div className="text-center">
                                    <p className="text-white font-bold text-lg">Coming Soon</p>
                                    <p className="text-gray-300 text-sm">Coach/Client features launching Q1 2026</p>
                                </div>
                            </div>
                            <i className="fas fa-users text-6xl text-gray-600 mb-4 line-through"></i>
                            <h3 className="text-white font-semibold mb-2 line-through">No clients yet</h3>
                            <p className="text-gray-400 text-sm line-through">
                                Clients will appear here when they sign up and select you as their coach.
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        const HomeTab = ({ user }) => {
            // Show different dashboard based on user type
            if (user?.userType === 'coach') {
                return <CoachDashboard user={user} />;
            }

            // Original HomeTab for clients and individuals
            const [wearableData, setWearableData] = useState(null);
            const [todayWorkout, setTodayWorkout] = useState(null);
            const [weeklyStats, setWeeklyStats] = useState({ workouts: 0, total: 4, streak: 0 });
            const [loading, setLoading] = useState(true);
            const [fitbitConnected, setFitbitConnected] = useState(false);
            const [activeWorkout, setActiveWorkout] = useState(null);
            const [showCheckIn, setShowCheckIn] = useState(false);
            const [todayCheckIn, setTodayCheckIn] = useState(null);
            const [connecting, setConnecting] = useState(false);
            const [tipIndex, setTipIndex] = useState(0);
            const firstName = user?.name?.split(' ')[0] || 'Athlete';

            // FORGE Tips - rotating daily tips
            const forgeTips = [
                "Progressive overload doesn't mean adding weight every session. Adding a rep or improving form counts too.",
                "Sleep is where gains are made. Aim for 7-9 hours. Your muscles recover and grow during deep sleep.",
                "Deload weeks aren't weakness - they're strategy. Every 4-6 weeks, reduce volume to come back stronger.",
                "The best program is the one you'll actually do consistently. Adherence beats optimization.",
                "Track your lifts. What gets measured gets managed. You can't improve what you don't track.",
                "Recovery isn't passive. Prioritize mobility work, hydration, and nutrition on rest days.",
                "RPE 8 means 2 reps left in the tank. Learn to auto-regulate based on daily readiness.",
                "Compound movements first, isolation work second. Build the foundation before the details."
            ];

            // Featured exercises with muscle groups
            const featuredExercises = [
                { name: 'Romanian Deadlift', muscles: 'Hamstrings, Glutes, Lower Back', icon: 'fa-dumbbell' },
                { name: 'Incline Dumbbell Press', muscles: 'Upper Chest, Front Delts', icon: 'fa-dumbbell' },
                { name: 'Bulgarian Split Squat', muscles: 'Quads, Glutes, Balance', icon: 'fa-person-walking' },
                { name: 'Barbell Row', muscles: 'Lats, Rhomboids, Biceps', icon: 'fa-weight-hanging' },
                { name: 'Face Pulls', muscles: 'Rear Delts, Rotator Cuff', icon: 'fa-hands' },
                { name: 'Hip Thrust', muscles: 'Glutes, Hamstrings', icon: 'fa-fire' }
            ];

            const todayExercise = featuredExercises[new Date().getDay() % featuredExercises.length];

            useEffect(() => { loadData(); setTipIndex(Math.floor(Math.random() * forgeTips.length)); }, []);

            const loadData = async () => {
                try {
                    const [calendarRes, wearableRes, connectionsRes, weekRes, checkInRes] = await Promise.all([
                        api.get(`/calendar/${user._id || user.id}/today`).catch(() => ({ data: [] })),
                        api.get(`/wearables/user/${user._id || user.id}?days=1`).catch(() => ({ data: [] })),
                        api.get('/wearables/connections').catch(() => ({ connections: [] })),
                        api.get(`/calendar/${user._id || user.id}?start=${new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0]}&end=${new Date().toISOString().split('T')[0]}`).catch(() => ({ data: [] })),
                        api.get('/check-ins/today').catch(() => null)
                    ]);
                    const workouts = (calendarRes.data || []).filter(e => e.type === 'workout');
                    setTodayWorkout(workouts[0] || null);
                    setWearableData((wearableRes.data || [])[0] || null);
                    setFitbitConnected((connectionsRes.connections || []).some(c => c.provider === 'fitbit' && c.connected));
                    setTodayCheckIn(checkInRes?.data || checkInRes || null);

                    // Calculate weekly stats
                    const weekWorkouts = (weekRes.data || []).filter(e => e.type === 'workout');
                    const completedWorkouts = weekWorkouts.filter(e => e.status === 'completed').length;
                    setWeeklyStats({ workouts: completedWorkouts, total: weekWorkouts.length || 4, streak: completedWorkouts });
                } catch (err) { console.error('Load error:', err); }
                setLoading(false);
            };

            const connectFitbit = async () => {
                setConnecting(true);
                try {
                    const data = await api.post('/wearables/connect/fitbit');
                    if (data.authUrl) window.location.href = data.authUrl;
                } catch (err) { alert('Failed to connect Fitbit: ' + err.message); }
                setConnecting(false);
            };

            const refreshTip = () => setTipIndex((tipIndex + 1) % forgeTips.length);

            const hasWearableData = wearableData !== null;
            const recoveryScore = wearableData?.recoveryScore;
            const sleepHours = wearableData?.sleepDuration ? (wearableData.sleepDuration / 60).toFixed(1) : null;
            const hrv = wearableData?.hrv;
            const restingHR = wearableData?.restingHeartRate;

            const getGreeting = () => { const hour = new Date().getHours(); if (hour < 12) return 'Good morning'; if (hour < 17) return 'Good afternoon'; return 'Good evening'; };
            const getRecoveryColor = (score) => { if (!score) return '#6b7280'; if (score >= 67) return '#22c55e'; if (score >= 34) return '#f97316'; return '#ef4444'; };

            return (
            <>
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <div><p className="text-gray-400 text-sm">{getGreeting()}</p><h1 className="text-2xl font-bold text-white">{firstName}</h1></div>
                        <div className="text-right text-sm text-gray-400">{new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                    </div>

                    {/* Card 1: Quick Stats */}
                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center gap-2 mb-3">
                            <i className="fas fa-chart-line text-orange-500"></i>
                            <h3 className="text-white font-semibold">This Week</h3>
                        </div>
                        <div className="grid grid-cols-3 gap-3 text-center">
                            <div className="bg-white/5 rounded-xl p-3">
                                <div className="text-2xl font-bold text-orange-500">{weeklyStats.workouts}/{weeklyStats.total}</div>
                                <div className="text-xs text-gray-400">Workouts</div>
                            </div>
                            <div className="bg-white/5 rounded-xl p-3">
                                <div className="text-2xl font-bold text-green-400">{weeklyStats.streak}</div>
                                <div className="text-xs text-gray-400">Day Streak</div>
                            </div>
                            <div className="bg-white/5 rounded-xl p-3">
                                <div className="text-2xl font-bold text-blue-400">{todayWorkout ? '1' : '0'}</div>
                                <div className="text-xs text-gray-400">Today</div>
                            </div>
                        </div>
                    </div>

                    {/* Daily Check-In Card */}
                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <i className={`fas ${todayCheckIn ? 'fa-check-circle text-green-500' : 'fa-clipboard-check text-orange-500'}`}></i>
                                <h3 className="text-white font-semibold">Daily Check-In</h3>
                            </div>
                            {todayCheckIn && (
                                <div className={`text-lg font-bold ${todayCheckIn.readinessScore >= 70 ? 'text-green-400' : todayCheckIn.readinessScore >= 40 ? 'text-orange-400' : 'text-red-400'}`}>
                                    {todayCheckIn.readinessScore || '--'}
                                </div>
                            )}
                        </div>
                        {todayCheckIn ? (
                            <p className="text-gray-400 text-sm mt-2">
                                {todayCheckIn.readinessScore >= 70 ? "Ready to train hard" : todayCheckIn.readinessScore >= 40 ? "Moderate readiness" : "Consider recovery focus"}
                            </p>
                        ) : (
                            <button onClick={() => setShowCheckIn(true)} className="w-full mt-3 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 py-2 rounded-xl text-sm transition-colors">
                                Complete Check-In
                            </button>
                        )}
                    </div>

                    {/* Card 2: Daily FORGE Tip */}
                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <i className="fas fa-lightbulb text-yellow-500"></i>
                                <h3 className="text-white font-semibold">FORGE Tip</h3>
                            </div>
                            <button onClick={refreshTip} className="text-gray-400 hover:text-orange-500 transition-colors">
                                <i className="fas fa-sync-alt text-sm"></i>
                            </button>
                        </div>
                        <p className="text-gray-300 text-sm leading-relaxed">"{forgeTips[tipIndex]}"</p>
                    </div>

                    {/* Card 3: Featured Exercise */}
                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center gap-2 mb-3">
                            <i className="fas fa-bullseye text-purple-500"></i>
                            <h3 className="text-white font-semibold">Exercise Spotlight</h3>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                <i className={`fas ${todayExercise.icon} text-white text-2xl`}></i>
                            </div>
                            <div className="flex-1">
                                <h4 className="text-white font-bold">{todayExercise.name}</h4>
                                <p className="text-gray-400 text-sm">{todayExercise.muscles}</p>
                            </div>
                        </div>
                    </div>

                    {/* Card 4: Nutrition Corner */}
                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center gap-2 mb-3">
                            <i className="fas fa-utensils text-green-500"></i>
                            <h3 className="text-white font-semibold">Fuel Up</h3>
                        </div>
                        <div className="space-y-2 text-sm">
                            <div className="flex items-start gap-2">
                                <span className="text-orange-500">Pre:</span>
                                <span className="text-gray-300">Banana + coffee (30 min before)</span>
                            </div>
                            <div className="flex items-start gap-2">
                                <span className="text-green-500">Post:</span>
                                <span className="text-gray-300">Protein + carbs within 1 hour</span>
                            </div>
                            <div className="flex items-center gap-2 text-blue-400">
                                <i className="fas fa-tint"></i>
                                <span>Aim for 3L water today</span>
                            </div>
                        </div>
                    </div>

                    {/* Fitbit Connect Banner */}
                    {!fitbitConnected && (
                        <button onClick={connectFitbit} disabled={connecting} className="w-full glass rounded-2xl p-4 flex items-center gap-4 hover:bg-white/10 transition-all">
                            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center"><i className="fas fa-watch text-white text-xl"></i></div>
                            <div className="flex-1 text-left"><h3 className="text-white font-medium">Connect Fitbit</h3><p className="text-gray-400 text-sm">Sync recovery, sleep & HRV data</p></div>
                            <i className="fas fa-chevron-right text-gray-500"></i>
                        </button>
                    )}

                    {/* Recovery Ring - Show when wearable connected */}
                    {hasWearableData && (
                        <div className="glass rounded-2xl p-5">
                            <div className="flex items-start gap-4">
                                <div className="relative w-24 h-24 flex-shrink-0">
                                    <svg className="w-full h-full metric-ring" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="8" />
                                        <circle cx="50" cy="50" r="42" fill="none" stroke={getRecoveryColor(recoveryScore)} strokeWidth="8" strokeDasharray={`${(recoveryScore || 0) * 2.64} 264`} strokeLinecap="round" className="progress-ring ring-progress" />
                                    </svg>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                                        <span className="text-2xl font-bold text-white">{recoveryScore || '--'}</span>
                                        <span className="text-gray-400 text-[10px]">Recovery</span>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-2">
                                        <i className={`fas ${recoveryScore >= 67 ? 'fa-check-circle text-green-400' : recoveryScore >= 34 ? 'fa-exclamation-circle text-orange-400' : 'fa-times-circle text-red-400'}`}></i>
                                        <span className="text-white font-medium text-sm">
                                            {recoveryScore >= 67 ? 'Ready to train hard' : recoveryScore >= 34 ? 'Train with caution' : 'Prioritize recovery'}
                                        </span>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 text-center">
                                        <div className="bg-white/5 rounded-lg p-2"><div className="text-sm font-bold text-green-400">{sleepHours || '--'}h</div><div className="text-[10px] text-gray-500">Sleep</div></div>
                                        <div className="bg-white/5 rounded-lg p-2"><div className="text-sm font-bold text-blue-400">{hrv || '--'}</div><div className="text-[10px] text-gray-500">HRV</div></div>
                                        <div className="bg-white/5 rounded-lg p-2"><div className="text-sm font-bold text-purple-400">{restingHR || '--'}</div><div className="text-[10px] text-gray-500">RHR</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Today's Workout */}
                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                                <i className="fas fa-dumbbell text-orange-500"></i>
                                <h3 className="text-white font-semibold">Today's Workout</h3>
                            </div>
                            {todayWorkout && <span className="text-xs text-orange-500 bg-orange-500/20 px-2 py-1 rounded-full">Scheduled</span>}
                        </div>
                        {loading ? (
                            <div className="text-center py-3"><div className="animate-pulse text-gray-400">Loading...</div></div>
                        ) : todayWorkout ? (
                            <div>
                                <h4 className="text-lg font-bold text-orange-500 mb-1">{todayWorkout.title}</h4>
                                {todayWorkout.description && <p className="text-gray-400 text-sm mb-3">{todayWorkout.description.substring(0, 80)}...</p>}
                                <button onClick={() => setActiveWorkout(todayWorkout)} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2.5 rounded-xl transition-all">Start Workout</button>
                            </div>
                        ) : (
                            <div className="text-center py-3"><i className="fas fa-bed text-2xl text-gray-600 mb-2"></i><h4 className="text-white font-medium text-sm">Rest Day</h4><p className="text-gray-400 text-xs">Recovery is part of the process</p></div>
                        )}
                    </div>
                </div>
                {activeWorkout && <WorkoutSessionModal workout={activeWorkout} onClose={() => setActiveWorkout(null)} onComplete={loadData} />}
                {showCheckIn && <CheckInModal user={user} onClose={() => setShowCheckIn(false)} onComplete={loadData} />}
            </>
            );
        };

        // Calendar Tab
        const CalendarTab = ({ user, globalGenerating, setGlobalGenerating, setGlobalGenerateMessage, setActiveTab }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [events, setEvents] = useState([]);
            const [selectedDate, setSelectedDate] = useState(null);
            const [expandedEvent, setExpandedEvent] = useState(null);
            const [activeWorkout, setActiveWorkout] = useState(null);

            useEffect(() => { loadEvents(); }, [currentDate]);

            const loadEvents = async () => {
                try {
                    const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString().split('T')[0];
                    const end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).toISOString().split('T')[0];
                    const data = await api.get(`/calendar/${user._id || user.id}?start=${start}&end=${end}`);
                    setEvents(data.data || []);
                } catch (err) { console.error('Calendar load error:', err); }
            };

            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const getEventsForDay = (day) => { const dateStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toISOString().split('T')[0]; return events.filter(e => e.date?.split('T')[0] === dateStr); };
            const isToday = (day) => { const today = new Date(); return day === today.getDate() && currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear(); };

            const selectedDayEvents = selectedDate ? getEventsForDay(selectedDate) : [];
            const sortedEvents = [...selectedDayEvents].sort((a, b) => { const priority = { workout: 1, nutrition: 2, 'rest-day': 3 }; return (priority[a.type] || 4) - (priority[b.type] || 4); });

            const generateMonth = async () => {
                if (globalGenerating) return;
                setGlobalGenerating(true);

                // Show immediate feedback - generating in background
                setGlobalGenerateMessage({ type: 'info', text: '🔨 Forging your program... You can navigate around, we\'ll notify you when ready!' });

                // Run generation in background (don't block UI)
                const runGeneration = async () => {
                    try {
                        // Generate workout calendar AND nutrition in parallel (using longer AI timeout)
                        const [calendarResult, nutritionResult, mealPlanResult] = await Promise.all([
                            api.post('/calendar/generate-month', { startDate: new Date().toISOString().split('T')[0] }, AI_TIMEOUT),
                            api.post('/nutrition/calculate', {}, AI_TIMEOUT).catch(e => ({ error: e.message })),
                            api.post('/nutrition/generate-meal-plan', {}, AI_TIMEOUT).catch(e => ({ error: e.message }))
                        ]);

                        // Build success message
                        let message = '✅ Program ready! ';
                        const workoutCount = calendarResult.data?.events?.filter(e => e.type === 'workout')?.length || 0;
                        if (workoutCount > 0) message += `${workoutCount} workouts`;
                        if (!nutritionResult.error && nutritionResult.targets) {
                            message += ' + Nutrition set';
                        }
                        if (!mealPlanResult.error && mealPlanResult.data?.calendarEventsCreated) {
                            message += ` + ${mealPlanResult.data.calendarEventsCreated} meals`;
                        }

                        setGlobalGenerateMessage({ type: 'success', text: message });

                        // Play notification sound (if available)
                        try { new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQNHm9f/ubFvECRvq+H/2aJhDBp3uc7/7rdhDB52tMT/98VhDhZ0sLz//9dhChBwq7P//+1lCgxqqaz//+9sCwdlpaX//+9yCgRhoZ7//+93CQFdnZf//+98CQBZmZD//+9/CP9VlYn//+6BCP5RkYL//+2DCP1NjXv//+yFCP1Jinb//+uHCPxGhm///+qJCPtCgmn//+mLCPo+fmP//+iNCPk6emD//+ePCPg2dl3//+aRCPcydFn//+WTCPYucVb//+SUCPU=').play(); } catch(e) {}

                        // Reload events to show new content
                        await loadEvents();

                        setTimeout(() => setGlobalGenerateMessage(null), 8000);
                    } catch (err) {
                        console.error('Generate month error:', err);
                        setGlobalGenerateMessage({ type: 'error', text: '❌ ' + (err.message || 'Generation failed. Please try again.') });
                        setTimeout(() => setGlobalGenerateMessage(null), 8000);
                    } finally {
                        setGlobalGenerating(false);
                    }
                };

                // Start generation without blocking
                runGeneration();
            };

            return (<>
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <h1 className="text-2xl font-bold text-white">Calendar</h1>
                        <button onClick={generateMonth} disabled={globalGenerating} className={`text-sm px-3 py-1.5 rounded-lg flex items-center gap-2 ${globalGenerating ? 'bg-gray-500/20 text-gray-400 cursor-not-allowed' : 'bg-orange-500/20 text-orange-500 hover:bg-orange-500/30'}`}>
                            <i className={`fas ${globalGenerating ? 'fa-spinner fa-spin' : 'fa-hammer'}`}></i>
                            {globalGenerating ? 'Forging...' : 'FORGE'}
                        </button>
                    </div>

                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center justify-between mb-4">
                            <button onClick={prevMonth} className="p-2 text-gray-400 hover:text-white"><i className="fas fa-chevron-left"></i></button>
                            <h2 className="text-lg font-semibold text-white">{monthName}</h2>
                            <button onClick={nextMonth} className="p-2 text-gray-400 hover:text-white"><i className="fas fa-chevron-right"></i></button>
                        </div>
                        <div className="grid grid-cols-7 gap-1 mb-2">{['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, i) => <div key={i} className="text-center text-gray-500 text-xs py-2">{day}</div>)}</div>
                        <div className="grid grid-cols-7 gap-1">
                            {Array.from({ length: firstDayOfMonth }).map((_, i) => <div key={`empty-${i}`} />)}
                            {Array.from({ length: daysInMonth }).map((_, i) => {
                                const day = i + 1;
                                const dayEvents = getEventsForDay(day);
                                const hasWorkout = dayEvents.some(e => e.type === 'workout');
                                const hasNutrition = dayEvents.some(e => e.type === 'nutrition');
                                const isCompleted = dayEvents.some(e => e.status === 'completed');
                                return (
                                    <button key={day} onClick={() => setSelectedDate(day)} className={`calendar-day aspect-square rounded-lg flex flex-col items-center justify-center text-sm relative ${isToday(day) ? 'bg-orange-500 text-white font-bold' : selectedDate === day ? 'bg-white/20 text-white' : 'text-gray-300 hover:bg-white/10'}`}>
                                        {day}
                                        {dayEvents.length > 0 && (
                                            <div className="flex gap-0.5 mt-0.5">
                                                {hasWorkout && <div className={`w-1.5 h-1.5 rounded-full ${isCompleted ? 'bg-green-500' : 'bg-orange-500'}`} />}
                                                {hasNutrition && <div className="w-1.5 h-1.5 rounded-full bg-green-500" />}
                                            </div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {selectedDate && (
                        <div className="glass rounded-2xl p-4">
                            <h3 className="text-white font-semibold mb-3">{new Date(currentDate.getFullYear(), currentDate.getMonth(), selectedDate).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</h3>
                            {sortedEvents.length > 0 ? (
                                <div className="space-y-3">
                                    {sortedEvents.map((event, i) => (
                                        <div key={i} className="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                                            <button onClick={() => setExpandedEvent(expandedEvent === i ? null : i)} className="w-full p-4 flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${i === 0 ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400'}`}>{i + 1}</span>
                                                    <div className="text-left">
                                                        <h4 className="text-white font-medium">{event.title}</h4>
                                                        <span className={`text-xs ${event.type === 'workout' ? 'text-orange-400' : event.type === 'nutrition' ? 'text-green-400' : 'text-gray-400'}`}>{event.type === 'nutrition' && event.mealData ? event.mealData.mealType : event.type}</span>
                                                    </div>
                                                </div>
                                                <i className={`fas fa-chevron-${expandedEvent === i ? 'up' : 'down'} text-gray-500`}></i>
                                            </button>
                                            {expandedEvent === i && (
                                                <div className="px-4 pb-4 pt-0 border-t border-white/10">
                                                    {event.type === 'nutrition' && event.mealData ? (
                                                        <div className="mt-3">
                                                            {event.mealData.imageUrl && (
                                                                <img src={event.mealData.imageUrl} alt={event.title} className="w-full h-32 object-cover rounded-lg mb-3" />
                                                            )}
                                                            <div className="grid grid-cols-4 gap-2 text-center mb-3">
                                                                <div className="bg-orange-500/20 rounded-lg p-2">
                                                                    <div className="text-orange-400 font-bold text-sm">{event.mealData.calories}</div>
                                                                    <div className="text-gray-500 text-xs">cal</div>
                                                                </div>
                                                                <div className="bg-blue-500/20 rounded-lg p-2">
                                                                    <div className="text-blue-400 font-bold text-sm">{event.mealData.protein}g</div>
                                                                    <div className="text-gray-500 text-xs">protein</div>
                                                                </div>
                                                                <div className="bg-green-500/20 rounded-lg p-2">
                                                                    <div className="text-green-400 font-bold text-sm">{event.mealData.carbs}g</div>
                                                                    <div className="text-gray-500 text-xs">carbs</div>
                                                                </div>
                                                                <div className="bg-purple-500/20 rounded-lg p-2">
                                                                    <div className="text-purple-400 font-bold text-sm">{event.mealData.fat}g</div>
                                                                    <div className="text-gray-500 text-xs">fat</div>
                                                                </div>
                                                            </div>
                                                            {event.mealData.prepTime && (
                                                                <p className="text-gray-500 text-xs"><i className="fas fa-clock mr-1"></i>{event.mealData.prepTime} min prep</p>
                                                            )}
                                                        </div>
                                                    ) : event.type === 'workout' ? (
                                                        <div className="mt-3 space-y-3">
                                                            {event.duration && <p className="text-gray-500 text-xs mb-2"><i className="fas fa-clock mr-1"></i>{event.duration} min</p>}
                                                            {/* Show exercises if available */}
                                                            {event.exercises?.length > 0 ? (
                                                                <div className="space-y-2">
                                                                    {event.exercises.map((ex, j) => (
                                                                        <div key={j} className="bg-white/5 rounded-lg p-3 flex items-center justify-between">
                                                                            <div className="flex-1">
                                                                                <div className="text-white font-medium text-sm">{ex.name || ex.exercise}</div>
                                                                                <div className="text-orange-400 text-xs mt-1">
                                                                                    {ex.sets && <span>{ex.sets} sets</span>}
                                                                                    {ex.reps && <span> × {ex.reps}</span>}
                                                                                    {ex.rest && <span className="text-gray-500 ml-2">({ex.rest} rest)</span>}
                                                                                </div>
                                                                                {ex.notes && <div className="text-gray-500 text-xs mt-1 italic">{ex.notes}</div>}
                                                                            </div>
                                                                            <button onClick={() => { setActiveTab('exercises'); setExerciseSearch && setExerciseSearch(ex.name || ex.exercise); }} className="text-orange-500 hover:text-orange-400 p-2" title="View in Library">
                                                                                <i className="fas fa-external-link-alt text-xs"></i>
                                                                            </button>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            ) : event.description ? (
                                                                <div className="space-y-2">
                                                                    {event.description.split('\n').filter(l => l.trim()).map((line, j) => (
                                                                        <div key={j} className="bg-white/5 rounded-lg p-3 flex items-center justify-between">
                                                                            <span className="text-gray-300 text-sm">{line.replace(/^[-•]\s*/, '')}</span>
                                                                            <button onClick={() => { setActiveTab('exercises'); }} className="text-orange-500 hover:text-orange-400 p-2" title="View in Library">
                                                                                <i className="fas fa-external-link-alt text-xs"></i>
                                                                            </button>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            ) : null}
                                                            {/* Start Workout button */}
                                                            {!event.completed && (
                                                                <button onClick={() => setActiveWorkout(event)} className="w-full mt-3 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                                                                    <i className="fas fa-play"></i> Start Workout
                                                                </button>
                                                            )}
                                                            {event.completed && (
                                                                <div className="text-green-500 text-sm text-center mt-2"><i className="fas fa-check-circle mr-1"></i>Completed</div>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <>
                                                            {event.description && <p className="text-gray-400 text-sm mt-3">{event.description}</p>}
                                                            {event.duration && <p className="text-gray-500 text-xs mt-2"><i className="fas fa-clock mr-1"></i>{event.duration} min</p>}
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-gray-400 text-center py-4">No events scheduled</p>
                            )}
                        </div>
                    )}

                    <div className="flex justify-center gap-6 text-xs text-gray-400">
                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-orange-500" />Workout</div>
                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-green-500" />Meal</div>
                    </div>
                </div>
                {activeWorkout && <WorkoutSessionModal workout={activeWorkout} onClose={() => setActiveWorkout(null)} onComplete={loadEvents} />}
            </>
            );
        };

        // FORGE AI Coach Tab
        const ForgeTab = ({ user, setActiveTab }) => {
            const [messages, setMessages] = useState(() => {
                const saved = chatStorage.get();
                return saved.length > 0 ? saved : [{ role: 'assistant', content: `Yo ${user?.name?.split(' ')[0] || 'Elite'} - I'm FORGE, your AI coach who actually knows what you need before you do. I analyze your training, read your recovery data, and build programs that evolve with you. No generic BS, no cookie-cutter plans. Just real coaching that adapts in real-time. Ready to get after it?` }];
            });
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [actionNotice, setActionNotice] = useState(null);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);
            // Limit chat history to 50 messages to prevent localStorage overflow
            useEffect(() => { chatStorage.set(messages.slice(-50)); }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || loading) return;
                const userMessage = input.trim();
                setInput('');
                const newMessages = [...messages, { role: 'user', content: userMessage }];

                // Add loading message with hammer
                const loadingMessage = { role: 'assistant', content: '🔨', isForging: true };
                setMessages([...newMessages, loadingMessage]);
                setLoading(true);

                // Retry logic with exponential backoff
                const maxRetries = 3;
                let retryCount = 0;
                let lastError = null;

                while (retryCount < maxRetries) {
                    try {
                        // Send conversation history for context (last 20 messages to avoid token limits)
                        const conversationHistory = newMessages.slice(-20).map(m => ({
                            role: m.role,
                            content: m.content
                        }));
                        const data = await api.post('/ai-coach/ask', {
                            question: userMessage,
                            conversationHistory: conversationHistory
                        }, AI_TIMEOUT);

                        // Replace loading message with actual response
                        const responseMessages = [...newMessages, { role: 'assistant', content: data.answer || data.response || 'I had trouble processing that. Try rephrasing?' }];
                        setMessages(responseMessages);

                        // Handle action results from FORGE
                        if (data.action?.action === 'CALENDAR_GENERATED' || data.action?.action === 'PROGRAM_GENERATED') {
                            const eventsCount = data.action.eventsCreated || data.action.stats?.totalEventsCreated || 0;
                            setActionNotice({
                                type: 'calendar',
                                message: `✅ Program created! ${eventsCount} workouts added to calendar.`,
                                icon: 'fa-calendar-check'
                            });
                        }
                        setLoading(false);
                        return; // Success - exit function
                    } catch (err) {
                        lastError = err;

                        // Check for 403 - Trial expired / Subscription required
                        if (err.status === 403 || err.requiresSubscription) {
                            setMessages([...newMessages, {
                                role: 'assistant',
                                content: err.message || 'Your free trial has ended.',
                                isSubscribePrompt: true
                            }]);
                            setLoading(false);
                            return; // Don't retry - show subscribe prompt
                        }

                        retryCount++;
                        console.error(`FORGE error (attempt ${retryCount}/${maxRetries}):`, err);

                        if (retryCount < maxRetries) {
                            // Exponential backoff: 1s, 2s, 4s
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount - 1) * 1000));
                        }
                    }
                }

                // All retries failed
                console.error('FORGE failed after all retries:', lastError);
                setMessages([...newMessages, { role: 'assistant', content: "I'm having trouble connecting right now. Please check your internet connection and try again." }]);
                setLoading(false);
            };

            const clearChat = () => { chatStorage.clear(); setMessages([{ role: 'assistant', content: `Reset. Let's go, ${user?.name?.split(' ')[0] || 'Elite'} - what's the move?` }]); };

            const quickActions = ['Add workouts to calendar', "I'm feeling sore", 'Nutrition advice', 'Check my progress', 'Deload week?'];

            return (
                <div className="flex flex-col h-[calc(100vh-180px)]">

                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center lightning-icon"><i className="fas fa-bolt text-white text-xl"></i></div>
                            <div><h1 className="text-xl font-bold text-white lightning-text">FORGE</h1><p className="text-sm text-green-400"><i className="fas fa-circle text-[8px] mr-1 animate-pulse"></i>Your AI Coach</p></div>
                        </div>
                        <button onClick={clearChat} className="text-gray-500 hover:text-gray-300 text-sm"><i className="fas fa-trash mr-1"></i>Clear</button>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-4 mb-4">
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`chat-bubble rounded-2xl px-4 py-3 ${msg.role === 'user' ? 'bg-orange-500 text-white rounded-br-md' : 'glass text-gray-200 rounded-bl-md'}`}>
                                    {msg.isForging ? (
                                        <div className="flex items-center gap-3">
                                            <div className="forge-hammering-slow">🔨</div>
                                            <span className="text-sm text-gray-300">Forging your program...</span>
                                        </div>
                                    ) : msg.isSubscribePrompt ? (
                                        <div className="space-y-3">
                                            <p className="text-orange-400 font-semibold">⚠️ Trial Ended</p>
                                            <p>{msg.content}</p>
                                            <button
                                                onClick={() => setActiveTab('profile')}
                                                className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:opacity-90 transition"
                                            >
                                                Update Subscription
                                            </button>
                                        </div>
                                    ) : (
                                        msg.content
                                    )}
                                </div>
                            </div>
                        ))}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Calendar Action Button */}
                    {actionNotice && (
                        <div className="mb-3 p-4 rounded-xl bg-green-500/20 border border-green-500/30">
                            <div className="flex items-center gap-3 mb-3">
                                <i className={`fas ${actionNotice.icon} text-green-400 text-xl`}></i>
                                <span className="text-green-400 font-medium flex-1">{actionNotice.message}</span>
                                <button onClick={() => setActionNotice(null)} className="text-green-400/60 hover:text-green-400">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            {actionNotice.type === 'calendar' && (
                                <button
                                    onClick={() => {
                                        setActiveTab('calendar');
                                        setActionNotice(null);
                                    }}
                                    className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2"
                                >
                                    <i className="fas fa-calendar-check"></i>
                                    Go to Calendar
                                </button>
                            )}
                        </div>
                    )}

                    <div className="flex gap-2 overflow-x-auto pb-2 mb-2">
                        {quickActions.map((action, i) => (
                            <button key={i} onClick={() => setInput(action)} className="flex-shrink-0 px-3 py-1.5 rounded-full bg-white/10 text-gray-300 text-sm hover:bg-white/20">{action}</button>
                        ))}
                    </div>

                    <div className="flex gap-2">
                        <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendMessage()} placeholder="Ask FORGE anything..." className="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                        <button onClick={sendMessage} disabled={!input.trim() || loading} className="bg-orange-500 hover:bg-orange-600 text-white px-4 rounded-xl transition-all disabled:opacity-50"><i className="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            );
        };

        // Exercises Tab - MuscleWiki Video Library
        const ExercisesTab = ({ user }) => {
            const [exercises, setExercises] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [search, setSearch] = useState('');
            const [selectedMuscle, setSelectedMuscle] = useState('');
            const [muscles, setMuscles] = useState([]);
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [stats, setStats] = useState(null);

            useEffect(() => {
                loadExercises();
                loadMuscles();
                loadStats();
            }, []);

            // Debounced search to prevent API spam on every keystroke
            useEffect(() => {
                const debounceTimer = setTimeout(() => {
                    if (search || selectedMuscle) {
                        searchExercises();
                    } else {
                        loadExercises();
                    }
                }, 300); // 300ms debounce

                return () => clearTimeout(debounceTimer);
            }, [search, selectedMuscle]);

            const loadExercises = async () => {
                setLoading(true);
                setError(null);
                try {
                    const data = await api.get('/exercises/videos?limit=30&hasVideo=true');
                    setExercises(data.exercises || []);
                } catch (err) {
                    console.error('Load exercises error:', err);
                    setError(err.message || 'Failed to load exercises');
                }
                setLoading(false);
            };

            const loadMuscles = async () => {
                try {
                    const data = await api.get('/exercises/videos/muscles');
                    setMuscles(data.muscleGroups || []);
                } catch (err) { console.error('Load muscles error:', err); }
            };

            const loadStats = async () => {
                try {
                    const data = await api.get('/exercises/videos/stats');
                    setStats(data.stats);
                } catch (err) { console.error('Load stats error:', err); }
            };

            const searchExercises = async () => {
                setLoading(true);
                setError(null);
                try {
                    let url = '/exercises/videos?limit=50&hasVideo=true';
                    if (selectedMuscle) url = `/exercises/videos/muscle/${selectedMuscle}`;
                    else if (search) url = `/exercises/videos/search?q=${encodeURIComponent(search)}`;
                    const data = await api.get(url);
                    setExercises(data.exercises || []);
                } catch (err) {
                    console.error('Search error:', err);
                    setError(err.message || 'Failed to search exercises');
                }
                setLoading(false);
            };

            const ExerciseCard = ({ exercise }) => (
                <button onClick={() => setSelectedExercise(exercise)} className="w-full glass rounded-xl p-3 flex items-center gap-3 hover:bg-white/10 transition-all text-left">
                    <div className="w-14 h-14 rounded-lg bg-orange-500/20 flex items-center justify-center flex-shrink-0">
                        {exercise.hasVideo ? <i className="fas fa-play text-orange-500"></i> : <i className="fas fa-dumbbell text-orange-500/50"></i>}
                    </div>
                    <div className="flex-1 min-w-0">
                        <h3 className="text-white font-medium truncate">{exercise.name}</h3>
                        <div className="flex items-center gap-2 text-xs text-gray-400">
                            <span className="capitalize">{exercise.primaryMuscles?.[0] || 'General'}</span>
                            <span className="text-gray-600">|</span>
                            <span className="capitalize">{exercise.equipment || 'Bodyweight'}</span>
                        </div>
                    </div>
                    {exercise.hasVideo && <i className="fas fa-video text-green-500 text-xs"></i>}
                </button>
            );

            const ExerciseModal = ({ exercise, onClose, user, onSelectVariation }) => {
                const [videoError, setVideoError] = useState(false);
                const [variations, setVariations] = useState([]);
                const [whyRecommended, setWhyRecommended] = useState(null);
                const [loadingVariations, setLoadingVariations] = useState(true);
                const videoUrl = exercise.videos?.[0];
                const youtubeUrl = exercise.youtubeUrl;
                const posterImage = exercise.images?.[0];

                // Fetch variations and recommendation on mount
                useEffect(() => {
                    const fetchVariations = async () => {
                        try {
                            const data = await api.get(`/exercises/videos/${exercise.id}/variations`);
                            if (data.success) {
                                setVariations(data.variations || []);
                                setWhyRecommended(data.whyRecommended);
                            }
                        } catch (err) {
                            console.error('Failed to load variations:', err);
                        }
                        setLoadingVariations(false);
                    };
                    if (exercise.id) fetchVariations();
                }, [exercise.id]);

                return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="glass rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-white/10 flex items-center justify-between">
                            <h2 className="text-lg font-bold text-white">{exercise.name}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><i className="fas fa-times"></i></button>
                        </div>
                        {/* Try video first, fallback to YouTube, then image */}
                        {videoUrl && !videoError ? (
                            <div className="aspect-video bg-black relative">
                                <video
                                    src={videoUrl}
                                    controls
                                    autoPlay
                                    loop
                                    muted
                                    playsInline
                                    crossOrigin="anonymous"
                                    poster={posterImage}
                                    className="w-full h-full object-contain"
                                    onError={() => setVideoError(true)}
                                />
                            </div>
                        ) : youtubeUrl ? (
                            <div className="aspect-video bg-black">
                                <iframe
                                    src={youtubeUrl}
                                    className="w-full h-full"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowFullScreen
                                />
                            </div>
                        ) : posterImage ? (
                            <div className="aspect-video bg-black flex items-center justify-center">
                                <img src={posterImage} alt={exercise.name} className="max-w-full max-h-full object-contain" />
                            </div>
                        ) : null}
                        <div className="p-4 space-y-4">
                            <div className="flex flex-wrap gap-2">
                                {exercise.primaryMuscles?.map(m => (
                                    <span key={m} className="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs rounded-full capitalize">{m}</span>
                                ))}
                                {exercise.secondaryMuscles?.map(m => (
                                    <span key={m} className="px-2 py-1 bg-white/10 text-gray-400 text-xs rounded-full capitalize">{m}</span>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="glass rounded-lg p-3 text-center">
                                    <i className="fas fa-dumbbell text-orange-500 mb-1"></i>
                                    <p className="text-white text-sm capitalize">{exercise.equipment || 'Bodyweight'}</p>
                                    <p className="text-gray-500 text-xs">Equipment</p>
                                </div>
                                <div className="glass rounded-lg p-3 text-center">
                                    <i className="fas fa-signal text-orange-500 mb-1"></i>
                                    <p className="text-white text-sm">{['Beginner', 'Intermediate', 'Advanced'][exercise.difficulty - 1] || 'All Levels'}</p>
                                    <p className="text-gray-500 text-xs">Difficulty</p>
                                </div>
                            </div>
                            {exercise.instructions && exercise.instructions.length > 0 && (
                                <div>
                                    <h3 className="text-white font-medium mb-2">Instructions</h3>
                                    <ol className="text-gray-400 text-sm space-y-2">
                                        {exercise.instructions.map((step, i) => (
                                            <li key={i} className="flex gap-2"><span className="text-orange-500">{i + 1}.</span>{step}</li>
                                        ))}
                                    </ol>
                                </div>
                            )}

                            {/* Why It's Recommended */}
                            {whyRecommended && (
                                <div className="glass rounded-xl p-4 border border-orange-500/30">
                                    <div className="flex items-center gap-2 mb-2">
                                        <i className="fas fa-lightbulb text-orange-500"></i>
                                        <h3 className="text-white font-medium">Why It's Recommended</h3>
                                    </div>
                                    <p className="text-gray-300 text-sm mb-2">{whyRecommended.reason}</p>
                                    <p className="text-orange-400 text-xs"><i className="fas fa-bolt mr-1"></i>{whyRecommended.tip}</p>
                                </div>
                            )}

                            {/* Variations */}
                            {!loadingVariations && variations.length > 0 && (
                                <div>
                                    <h3 className="text-white font-medium mb-3">Try These Variations</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        {variations.map((v, i) => (
                                            <button
                                                key={v.id || i}
                                                onClick={() => onSelectVariation && onSelectVariation(v)}
                                                className="glass rounded-lg p-3 text-left hover:bg-white/10 transition-all"
                                            >
                                                <p className="text-white text-sm font-medium truncate">{v.name}</p>
                                                <div className="flex items-center gap-2 mt-1">
                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${
                                                        v.difficultyLabel === 'easier' ? 'bg-green-500/20 text-green-400' :
                                                        v.difficultyLabel === 'harder' ? 'bg-red-500/20 text-red-400' :
                                                        'bg-white/10 text-gray-400'
                                                    }`}>
                                                        {v.difficultyLabel === 'easier' ? '↓ Easier' :
                                                         v.difficultyLabel === 'harder' ? '↑ Harder' : '= Similar'}
                                                    </span>
                                                    {v.hasVideo && <i className="fas fa-video text-green-500 text-xs"></i>}
                                                </div>
                                                <p className="text-gray-500 text-xs mt-1 capitalize">{v.equipment || 'bodyweight'}</p>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {loadingVariations && (
                                <div className="text-center py-4">
                                    <i className="fas fa-spinner fa-spin text-orange-500"></i>
                                    <p className="text-gray-500 text-sm mt-1">Loading variations...</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
            };

            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <h1 className="text-2xl font-bold text-white">Exercises</h1>
                        {stats && <span className="text-orange-500 text-sm">{stats.withVideos} videos</span>}
                    </div>

                    {/* Search */}
                    <div className="relative">
                        <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                        <input type="text" value={search} onChange={e => setSearch(e.target.value)} placeholder="Search exercises..." className="w-full pl-11 pr-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                    </div>

                    {/* Muscle Filter */}
                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                        <button onClick={() => setSelectedMuscle('')} className={`px-3 py-1.5 rounded-full text-sm whitespace-nowrap transition-all ${!selectedMuscle ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 hover:bg-white/20'}`}>All</button>
                        {['chest', 'back', 'shoulders', 'biceps', 'triceps', 'quads', 'hamstrings', 'glutes', 'abs'].map(muscle => (
                            <button key={muscle} onClick={() => setSelectedMuscle(muscle)} className={`px-3 py-1.5 rounded-full text-sm whitespace-nowrap capitalize transition-all ${selectedMuscle === muscle ? 'bg-orange-500 text-white' : 'bg-white/10 text-gray-400 hover:bg-white/20'}`}>{muscle}</button>
                        ))}
                    </div>

                    {/* Exercise List */}
                    {loading ? (
                        <div className="space-y-2">
                            {[1,2,3,4,5].map(i => (
                                <div key={i} className="glass rounded-xl p-4 animate-pulse">
                                    <div className="flex gap-4">
                                        <div className="w-16 h-16 rounded-lg bg-white/10"></div>
                                        <div className="flex-1 space-y-2">
                                            <div className="h-4 bg-white/10 rounded w-3/4"></div>
                                            <div className="h-3 bg-white/10 rounded w-1/2"></div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : error ? (
                        <div className="text-center py-12">
                            <i className="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                            <p className="text-red-400 mb-4">{error}</p>
                            <button onClick={loadExercises} className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                                <i className="fas fa-redo mr-2"></i>Try Again
                            </button>
                        </div>
                    ) : exercises.length === 0 ? (
                        <div className="text-center py-12 text-gray-400">No exercises found</div>
                    ) : (
                        <div className="space-y-2">
                            {exercises.map(ex => <ExerciseCard key={ex.id} exercise={ex} />)}
                        </div>
                    )}

                    {selectedExercise && <ExerciseModal
                        exercise={selectedExercise}
                        onClose={() => setSelectedExercise(null)}
                        user={user}
                        onSelectVariation={(variation) => {
                            // Fetch full exercise data for the variation
                            api.get(`/exercises/videos/${variation.id}`).then(data => {
                                if (data.success && data.exercise) {
                                    setSelectedExercise(data.exercise);
                                }
                            }).catch(err => console.error('Failed to load variation:', err));
                        }}
                    />}
                </div>
            );
        };

        // Kitchen Tab - FORGE Nutrition System
        const KitchenTab = ({ user }) => {
            const [loading, setLoading] = useState(true);
            const [generating, setGenerating] = useState(false);
            const [targets, setTargets] = useState(null);
            const [mealPlan, setMealPlan] = useState([]);
            const [todayLog, setTodayLog] = useState([]);
            const [showLogModal, setShowLogModal] = useState(false);
            const [newLog, setNewLog] = useState({ name: '', calories: '', protein: '', carbs: '', fat: '' });
            const [selectedMeal, setSelectedMeal] = useState(null);
            const [error, setError] = useState(null);
            const [userPrefs, setUserPrefs] = useState(null);
            const [showEditPrefs, setShowEditPrefs] = useState(false);
            const [editingPrefs, setEditingPrefs] = useState({
                dietType: 'flexible',
                allergies: [],
                currentWeight: '',
                targetWeight: '',
                goal: 'maintain'
            });

            useEffect(() => {
                loadNutrition();
                loadUserPrefs();
            }, []);

            const loadNutrition = async () => {
                setLoading(true);
                setError(null);
                try {
                    const data = await api.get('/nutrition/me');
                    if (data.targets) setTargets(data.targets);
                    if (data.mealPlan?.meals) setMealPlan(data.mealPlan.meals);
                    if (data.todayLog) setTodayLog(data.todayLog);
                } catch (err) {
                    console.error('Load nutrition error:', err);
                    // Only show error if it's a timeout or network issue, not a 404 (no data yet)
                    if (err.message?.includes('timeout') || err.message?.includes('network')) {
                        setError(err.message || 'Failed to load nutrition data');
                    }
                }
                setLoading(false);
            };

            const loadUserPrefs = async () => {
                try {
                    const userData = await api.get('/users/profile');
                    const prefs = {
                        dietType: userData.dietaryPreferences?.dietType || userData.profile?.dietType || 'flexible',
                        allergies: userData.dietaryPreferences?.allergies || userData.profile?.allergies || [],
                        currentWeight: userData.bodyComposition?.currentWeight || userData.profile?.currentWeight || userData.currentWeight,
                        targetWeight: userData.bodyComposition?.targetWeight || userData.profile?.targetWeight || userData.targetWeight,
                        goal: userData.bodyComposition?.goal || userData.profile?.goal || userData.goal
                    };
                    setUserPrefs(prefs);
                    setEditingPrefs(prefs);
                } catch (err) {
                    console.error('Load user prefs error:', err);
                }
            };

            const saveUserPrefs = async () => {
                try {
                    await api.put('/users/profile', {
                        dietaryPreferences: {
                            dietType: editingPrefs.dietType,
                            allergies: editingPrefs.allergies
                        },
                        bodyComposition: {
                            currentWeight: parseFloat(editingPrefs.currentWeight) || undefined,
                            targetWeight: parseFloat(editingPrefs.targetWeight) || undefined,
                            goal: editingPrefs.goal
                        }
                    });
                    setUserPrefs(editingPrefs);
                    setShowEditPrefs(false);
                    // Recalculate targets if they exist since body comp changed
                    if (targets) {
                        calculateTargets();
                    }
                } catch (err) {
                    alert('Failed to save preferences: ' + err.message);
                }
            };

            const calculateTargets = async () => {
                setGenerating(true);
                setError(null);
                try {
                    const data = await api.post('/nutrition/calculate');
                    setTargets(data.targets);
                } catch (err) {
                    setError(err.message || 'Failed to calculate targets');
                }
                setGenerating(false);
            };

            const generateMealPlan = async () => {
                setGenerating(true);
                setError(null);
                try {
                    const data = await api.post('/nutrition/generate-meal-plan');
                    setMealPlan(data.mealPlan || []);
                } catch (err) {
                    setError(err.message || 'Failed to generate meal plan');
                }
                setGenerating(false);
            };

            const logFood = async () => {
                if (!newLog.name) return;
                try {
                    await api.post('/nutrition/log', {
                        name: newLog.name,
                        calories: parseInt(newLog.calories) || 0,
                        protein: parseInt(newLog.protein) || 0,
                        carbs: parseInt(newLog.carbs) || 0,
                        fat: parseInt(newLog.fat) || 0
                    });
                    await loadNutrition();
                    setNewLog({ name: '', calories: '', protein: '', carbs: '', fat: '' });
                    setShowLogModal(false);
                } catch (err) {
                    alert('Failed to log food: ' + err.message);
                }
            };

            const logMealFromPlan = async (meal) => {
                try {
                    await api.post('/nutrition/log', {
                        name: meal.name,
                        calories: meal.macros?.calories || 0,
                        protein: meal.macros?.protein || 0,
                        carbs: meal.macros?.carbs || 0,
                        fat: meal.macros?.fat || 0
                    });
                    await loadNutrition();
                    setSelectedMeal(null);
                } catch (err) {
                    alert('Failed to log meal: ' + err.message);
                }
            };

            // Calculate today's totals
            const todayTotals = todayLog.reduce((acc, log) => ({
                calories: acc.calories + (log.calories || 0),
                protein: acc.protein + (log.protein || 0),
                carbs: acc.carbs + (log.carbs || 0),
                fat: acc.fat + (log.fat || 0)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

            const MacroRing = ({ current, target, color, label, unit = 'g' }) => {
                const percentage = target ? Math.min((current / target) * 100, 100) : 0;
                const circumference = 2 * Math.PI * 40;
                const offset = circumference - (percentage / 100) * circumference;
                return (
                    <div className="text-center">
                        <svg className="w-20 h-20 mx-auto -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="8" />
                            <circle cx="50" cy="50" r="40" fill="none" stroke={color} strokeWidth="8" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className="transition-all duration-500" />
                        </svg>
                        <div className="mt-2">
                            <div className="text-white font-bold">{Math.round(current)}{unit}</div>
                            <div className="text-gray-500 text-xs">{label}</div>
                            <div className="text-gray-600 text-xs">{target ? `/ ${target}${unit}` : ''}</div>
                        </div>
                    </div>
                );
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center py-20">
                        <div className="text-center">
                            <i className="fas fa-spinner fa-spin text-orange-500 text-3xl mb-4"></i>
                            <p className="text-gray-400">Loading kitchen...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6 pb-20">
                    {/* Header */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                                <i className="fas fa-utensils text-orange-500"></i>
                                Kitchen
                            </h1>
                            <p className="text-gray-400 text-sm">FORGE Nutrition</p>
                        </div>
                        <button onClick={() => setShowLogModal(true)} className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-xl text-sm">
                            <i className="fas fa-plus mr-1"></i>Log Food
                        </button>
                    </div>

                    {error && (
                        <div className="bg-red-500/20 border border-red-500/30 rounded-xl p-4 flex items-center justify-between">
                            <span className="text-red-400 text-sm">{error}</span>
                            <button onClick={loadNutrition} className="px-3 py-1 bg-orange-500 text-white rounded-lg text-sm hover:bg-orange-600 transition-colors">
                                <i className="fas fa-redo mr-1"></i>Retry
                            </button>
                        </div>
                    )}

                    {/* Nutrition Profile Card - Always show so user can set preferences */}
                    <div className="glass rounded-2xl p-4">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-white font-semibold flex items-center gap-2">
                                <i className="fas fa-user-cog text-orange-500"></i>
                                Your Nutrition Profile
                            </h3>
                            <button onClick={() => setShowEditPrefs(true)} className="text-orange-500 hover:text-orange-400 text-sm">
                                <i className="fas fa-edit mr-1"></i>Edit
                            </button>
                        </div>

                        {/* Diet Type & Allergies */}
                        <div className="flex flex-wrap gap-2 mb-3">
                            <span className="bg-orange-500/20 text-orange-400 px-3 py-1 rounded-full text-sm flex items-center gap-1">
                                <i className="fas fa-utensils"></i>
                                {userPrefs?.dietType ? userPrefs.dietType.charAt(0).toUpperCase() + userPrefs.dietType.slice(1) : 'Flexible'}
                            </span>
                            {userPrefs?.allergies?.length > 0 && userPrefs.allergies.map(allergy => (
                                <span key={allergy} className="bg-red-500/20 text-red-400 px-3 py-1 rounded-full text-sm flex items-center gap-1">
                                    <i className="fas fa-exclamation-triangle"></i>
                                    {allergy}
                                </span>
                            ))}
                        </div>

                        {/* Body Composition */}
                        {(userPrefs?.currentWeight || userPrefs?.targetWeight) ? (
                            <div className="flex items-center gap-3 text-sm">
                                {userPrefs.currentWeight && (
                                    <span className="text-white font-medium">{userPrefs.currentWeight} lbs</span>
                                )}
                                {userPrefs.targetWeight && (
                                    <>
                                        <i className="fas fa-arrow-right text-orange-500"></i>
                                        <span className="text-white font-medium">{userPrefs.targetWeight} lbs</span>
                                    </>
                                )}
                                {userPrefs.goal && (
                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                        userPrefs.goal?.includes('cut') || userPrefs.goal?.includes('lose') ? 'bg-red-500/20 text-red-400' :
                                        userPrefs.goal?.includes('bulk') || userPrefs.goal?.includes('gain') ? 'bg-green-500/20 text-green-400' :
                                        'bg-blue-500/20 text-blue-400'
                                    }`}>
                                        {userPrefs.goal?.replace('-', ' ').replace('_', ' ') || 'Maintain'}
                                    </span>
                                )}
                            </div>
                        ) : (
                            <p className="text-gray-500 text-sm">Tap Edit to set your weight and goals</p>
                        )}
                    </div>

                    {/* Targets Card - Show if no targets yet */}
                    {!targets ? (
                        <div className="glass rounded-2xl p-6 text-center">
                            <i className="fas fa-calculator text-orange-500 text-4xl mb-4"></i>
                            <h2 className="text-xl font-bold text-white mb-2">Set Your Nutrition Targets</h2>
                            <p className="text-gray-400 mb-6">FORGE will calculate your TDEE and macros based on your profile and goals.</p>
                            <button onClick={calculateTargets} disabled={generating} className="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold disabled:opacity-50">
                                {generating ? <><i className="fas fa-spinner fa-spin mr-2"></i>Calculating...</> : <><i className="fas fa-fire mr-2"></i>Calculate My Targets</>}
                            </button>
                        </div>
                    ) : (
                        <>
                            {/* Daily Progress */}
                            <div className="glass rounded-2xl p-5">
                                <div className="text-center mb-6">
                                    <div className="text-5xl font-bold text-white">{Math.round(todayTotals.calories)}</div>
                                    <div className="text-gray-400">of {targets.calories} calories</div>
                                    <div className="w-full h-2 bg-white/10 rounded-full mt-3 overflow-hidden">
                                        <div className="h-full bg-gradient-to-r from-orange-500 to-red-500 rounded-full transition-all" style={{ width: `${Math.min((todayTotals.calories / targets.calories) * 100, 100)}%` }} />
                                    </div>
                                </div>
                                <div className="grid grid-cols-3 gap-4">
                                    <MacroRing current={todayTotals.protein} target={targets.protein} color="#ef4444" label="Protein" />
                                    <MacroRing current={todayTotals.carbs} target={targets.carbs} color="#3b82f6" label="Carbs" />
                                    <MacroRing current={todayTotals.fat} target={targets.fat} color="#eab308" label="Fat" />
                                </div>
                            </div>

                            {/* Meal Plan */}
                            <div className="glass rounded-2xl p-5">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-white font-semibold flex items-center gap-2">
                                        <i className="fas fa-bolt text-orange-500"></i>
                                        FORGE Meal Plan
                                    </h3>
                                    <button onClick={generateMealPlan} disabled={generating} className="text-orange-500 hover:text-orange-400 text-sm disabled:opacity-50">
                                        {generating ? <i className="fas fa-spinner fa-spin"></i> : <><i className="fas fa-sync-alt mr-1"></i>Generate</>}
                                    </button>
                                </div>

                                {mealPlan.length > 0 ? (
                                    <div className="space-y-3">
                                        {mealPlan.map((meal, idx) => (
                                            <button key={idx} onClick={() => setSelectedMeal(meal)} className="w-full text-left bg-white/5 hover:bg-white/10 rounded-xl overflow-hidden border border-white/10 transition-all">
                                                {meal.imageUrl && (
                                                    <div className="h-32 bg-gray-800 overflow-hidden">
                                                        <img src={meal.imageUrl} alt={meal.name} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                                    </div>
                                                )}
                                                <div className="p-4">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <span className="text-orange-500 text-xs uppercase font-semibold">{meal.type}</span>
                                                            <h4 className="text-white font-medium">{meal.name}</h4>
                                                        </div>
                                                        <span className="text-orange-500 font-bold">{meal.macros?.calories || 0} cal</span>
                                                    </div>
                                                    <div className="flex gap-3 text-xs text-gray-400">
                                                        <span>P: {meal.macros?.protein || 0}g</span>
                                                        <span>C: {meal.macros?.carbs || 0}g</span>
                                                        <span>F: {meal.macros?.fat || 0}g</span>
                                                    </div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-8">
                                        <i className="fas fa-utensils text-gray-600 text-3xl mb-3"></i>
                                        <p className="text-gray-400 mb-4">No meal plan yet</p>
                                        <button onClick={generateMealPlan} disabled={generating} className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-xl text-sm disabled:opacity-50">
                                            {generating ? 'Generating...' : 'Generate AI Meal Plan'}
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Today's Log */}
                            <div className="glass rounded-2xl p-5">
                                <h3 className="text-white font-semibold mb-4">Today's Food Log</h3>
                                {todayLog.length > 0 ? (
                                    <div className="space-y-2">
                                        {todayLog.map((log, idx) => (
                                            <div key={idx} className="bg-white/5 rounded-lg p-3 flex justify-between items-center">
                                                <div>
                                                    <h4 className="text-white font-medium">{log.name}</h4>
                                                    <div className="text-xs text-gray-500">{new Date(log.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-orange-500 font-bold">{log.calories} cal</div>
                                                    <div className="text-xs text-gray-500">P:{log.protein} C:{log.carbs} F:{log.fat}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-400 text-center py-4">No food logged today</p>
                                )}
                            </div>
                        </>
                    )}

                    {/* Log Food Modal */}
                    {showLogModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="glass rounded-2xl p-6 w-full max-w-md">
                                <h3 className="text-xl font-bold text-white mb-4">Log Food</h3>
                                <div className="space-y-4">
                                    <input type="text" placeholder="Food name" value={newLog.name} onChange={e => setNewLog({...newLog, name: e.target.value})} className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                    <div className="grid grid-cols-2 gap-3">
                                        <input type="number" placeholder="Calories" value={newLog.calories} onChange={e => setNewLog({...newLog, calories: e.target.value})} className="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                        <input type="number" placeholder="Protein (g)" value={newLog.protein} onChange={e => setNewLog({...newLog, protein: e.target.value})} className="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                        <input type="number" placeholder="Carbs (g)" value={newLog.carbs} onChange={e => setNewLog({...newLog, carbs: e.target.value})} className="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                        <input type="number" placeholder="Fat (g)" value={newLog.fat} onChange={e => setNewLog({...newLog, fat: e.target.value})} className="bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none" />
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setShowLogModal(false)} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Cancel</button>
                                    <button onClick={logFood} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl">Log</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Meal Detail Modal */}
                    {selectedMeal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => setSelectedMeal(null)}>
                            <div className="glass rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                {selectedMeal.imageUrl && (
                                    <div className="h-48 bg-gray-800 overflow-hidden">
                                        <img src={selectedMeal.imageUrl} alt={selectedMeal.name} className="w-full h-full object-cover" />
                                    </div>
                                )}
                                <div className="p-5">
                                    <span className="text-orange-500 text-xs uppercase font-semibold">{selectedMeal.type}</span>
                                    <h2 className="text-xl font-bold text-white mb-2">{selectedMeal.name}</h2>
                                    {selectedMeal.description && <p className="text-gray-400 text-sm mb-4">{selectedMeal.description}</p>}

                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        <div className="text-center p-2 bg-white/10 rounded-lg">
                                            <div className="text-orange-500 font-bold">{selectedMeal.macros?.calories || 0}</div>
                                            <div className="text-gray-500 text-xs">cal</div>
                                        </div>
                                        <div className="text-center p-2 bg-white/10 rounded-lg">
                                            <div className="text-red-400 font-bold">{selectedMeal.macros?.protein || 0}g</div>
                                            <div className="text-gray-500 text-xs">protein</div>
                                        </div>
                                        <div className="text-center p-2 bg-white/10 rounded-lg">
                                            <div className="text-blue-400 font-bold">{selectedMeal.macros?.carbs || 0}g</div>
                                            <div className="text-gray-500 text-xs">carbs</div>
                                        </div>
                                        <div className="text-center p-2 bg-white/10 rounded-lg">
                                            <div className="text-yellow-400 font-bold">{selectedMeal.macros?.fat || 0}g</div>
                                            <div className="text-gray-500 text-xs">fat</div>
                                        </div>
                                    </div>

                                    {selectedMeal.ingredients && selectedMeal.ingredients.length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-white font-semibold mb-2">Ingredients</h3>
                                            <ul className="text-gray-400 text-sm space-y-1">
                                                {selectedMeal.ingredients.map((ing, i) => <li key={i} className="flex items-center gap-2"><i className="fas fa-check text-orange-500 text-xs"></i>{ing}</li>)}
                                            </ul>
                                        </div>
                                    )}

                                    <div className="flex gap-3">
                                        <button onClick={() => setSelectedMeal(null)} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Close</button>
                                        <button onClick={() => logMealFromPlan(selectedMeal)} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl">
                                            <i className="fas fa-plus mr-2"></i>Log This Meal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Preferences Modal */}
                    {showEditPrefs && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={() => setShowEditPrefs(false)}>
                            <div className="glass rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto p-5" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-white mb-4">
                                    <i className="fas fa-user-cog text-orange-500 mr-2"></i>
                                    Edit Nutrition Profile
                                </h2>

                                <div className="space-y-4">
                                    {/* Diet Type */}
                                    <div>
                                        <label className="text-gray-400 text-sm mb-2 block">Diet Type</label>
                                        <select
                                            value={editingPrefs.dietType || 'flexible'}
                                            onChange={e => setEditingPrefs({...editingPrefs, dietType: e.target.value})}
                                            className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none"
                                        >
                                            <option value="flexible" className="bg-gray-900">Flexible</option>
                                            <option value="vegan" className="bg-gray-900">Vegan</option>
                                            <option value="vegetarian" className="bg-gray-900">Vegetarian</option>
                                            <option value="pescatarian" className="bg-gray-900">Pescatarian</option>
                                            <option value="keto" className="bg-gray-900">Keto</option>
                                            <option value="paleo" className="bg-gray-900">Paleo</option>
                                            <option value="mediterranean" className="bg-gray-900">Mediterranean</option>
                                        </select>
                                    </div>

                                    {/* Allergies */}
                                    <div>
                                        <label className="text-gray-400 text-sm mb-2 block">Allergies / Restrictions</label>
                                        <div className="flex flex-wrap gap-2">
                                            {['Dairy', 'Gluten', 'Nuts', 'Soy', 'Eggs', 'Shellfish', 'Fish'].map(allergy => (
                                                <button
                                                    key={allergy}
                                                    onClick={() => {
                                                        const current = editingPrefs.allergies || [];
                                                        if (current.includes(allergy)) {
                                                            setEditingPrefs({...editingPrefs, allergies: current.filter(a => a !== allergy)});
                                                        } else {
                                                            setEditingPrefs({...editingPrefs, allergies: [...current, allergy]});
                                                        }
                                                    }}
                                                    className={`px-3 py-1.5 rounded-full text-sm transition-all ${
                                                        (editingPrefs.allergies || []).includes(allergy)
                                                            ? 'bg-red-500/30 text-red-400 border border-red-500/50'
                                                            : 'bg-white/10 text-gray-400 hover:bg-white/20'
                                                    }`}
                                                >
                                                    {allergy}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Body Composition */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-gray-400 text-sm mb-2 block">Current Weight (lbs)</label>
                                            <input
                                                type="number"
                                                value={editingPrefs.currentWeight || ''}
                                                onChange={e => setEditingPrefs({...editingPrefs, currentWeight: e.target.value})}
                                                placeholder="180"
                                                className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="text-gray-400 text-sm mb-2 block">Target Weight (lbs)</label>
                                            <input
                                                type="number"
                                                value={editingPrefs.targetWeight || ''}
                                                onChange={e => setEditingPrefs({...editingPrefs, targetWeight: e.target.value})}
                                                placeholder="170"
                                                className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                            />
                                        </div>
                                    </div>

                                    {/* Goal */}
                                    <div>
                                        <label className="text-gray-400 text-sm mb-2 block">Goal</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            <button
                                                onClick={() => setEditingPrefs({...editingPrefs, goal: 'cut'})}
                                                className={`p-3 rounded-xl text-center transition-all ${
                                                    editingPrefs.goal === 'cut'
                                                        ? 'bg-red-500/30 border border-red-500/50 text-red-400'
                                                        : 'bg-white/10 text-gray-400 hover:bg-white/20'
                                                }`}
                                            >
                                                <i className="fas fa-arrow-down mb-1"></i>
                                                <div className="text-sm">Cut</div>
                                            </button>
                                            <button
                                                onClick={() => setEditingPrefs({...editingPrefs, goal: 'maintain'})}
                                                className={`p-3 rounded-xl text-center transition-all ${
                                                    editingPrefs.goal === 'maintain'
                                                        ? 'bg-blue-500/30 border border-blue-500/50 text-blue-400'
                                                        : 'bg-white/10 text-gray-400 hover:bg-white/20'
                                                }`}
                                            >
                                                <i className="fas fa-equals mb-1"></i>
                                                <div className="text-sm">Maintain</div>
                                            </button>
                                            <button
                                                onClick={() => setEditingPrefs({...editingPrefs, goal: 'bulk'})}
                                                className={`p-3 rounded-xl text-center transition-all ${
                                                    editingPrefs.goal === 'bulk'
                                                        ? 'bg-green-500/30 border border-green-500/50 text-green-400'
                                                        : 'bg-white/10 text-gray-400 hover:bg-white/20'
                                                }`}
                                            >
                                                <i className="fas fa-arrow-up mb-1"></i>
                                                <div className="text-sm">Bulk</div>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setShowEditPrefs(false)} className="flex-1 border border-white/20 text-white py-3 rounded-xl hover:bg-white/10">Cancel</button>
                                    <button onClick={saveUserPrefs} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl">
                                        <i className="fas fa-save mr-2"></i>Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Profile Tab
        const ProfileTab = ({ user, setUser, onLogout }) => {
            const [showWearables, setShowWearables] = useState(false);
            const [showSubscription, setShowSubscription] = useState(false);
            const [showIntelligence, setShowIntelligence] = useState(false);
            const [showProfilePhoto, setShowProfilePhoto] = useState(false);
            const [connections, setConnections] = useState([]);
            const [connecting, setConnecting] = useState(null);

            useEffect(() => { loadConnections(); }, []);

            const loadConnections = async () => { try { const data = await api.get('/wearables/connections'); setConnections(data.connections || []); } catch (err) { console.error('Connections error:', err); } };
            const connectWearable = async (provider) => { setConnecting(provider); try { const data = await api.post(`/wearables/connect/${provider}`); if (data.authUrl) window.location.href = data.authUrl; } catch (err) { alert(`Failed to connect ${provider}: ${err.message}`); } setConnecting(null); };
            const disconnectWearable = async (provider) => { try { await api.delete(`/wearables/disconnect/${provider}`); loadConnections(); } catch (err) { alert(`Failed to disconnect: ${err.message}`); } };
            const syncWearable = async (provider) => { try { await api.post(`/wearables/sync/${provider}`); alert('Sync complete!'); } catch (err) { alert(`Sync failed: ${err.message}`); } };

            const wearables = [
                { id: 'fitbit', name: 'Fitbit', icon: 'fa-watch', color: 'from-teal-500 to-cyan-500' },
                { id: 'polar', name: 'Polar', icon: 'fa-heart', color: 'from-red-500 to-pink-500' },
                { id: 'garmin', name: 'Garmin', icon: 'fa-running', color: 'from-blue-500 to-indigo-500', disabled: true },
                { id: 'whoop', name: 'WHOOP', icon: 'fa-circle-notch', color: 'from-green-500 to-emerald-500', disabled: true },
                { id: 'oura', name: 'Oura', icon: 'fa-ring', color: 'from-purple-500 to-violet-500', disabled: true }
            ];

            const isConnected = (id) => connections.some(c => c.provider === id && c.connected);

            // Show ClockWork Intelligence view
            if (showIntelligence) {
                return (
                    <div className="space-y-6">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setShowIntelligence(false)} className="text-gray-400 hover:text-white">
                                <i className="fas fa-arrow-left text-xl"></i>
                            </button>
                        </div>
                        <ClockWorkIntelligence userId={user?._id} />
                    </div>
                );
            }

            if (showWearables) {
                return (
                    <div className="space-y-6">
                        <div className="flex items-center gap-4"><button onClick={() => setShowWearables(false)} className="text-gray-400 hover:text-white"><i className="fas fa-arrow-left text-xl"></i></button><h1 className="text-2xl font-bold text-white">Connect Wearables</h1></div>
                        <p className="text-gray-400">Connect your fitness devices for real-time recovery and strain tracking.</p>
                        <div className="space-y-4">
                            {wearables.map(w => {
                                const connected = isConnected(w.id);
                                return (
                                    <div key={w.id} className={`glass rounded-2xl p-5 ${w.disabled ? 'opacity-50' : ''}`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${w.color} flex items-center justify-center`}><i className={`fas ${w.icon} text-white text-xl`}></i></div>
                                                <div><h3 className="text-white font-semibold">{w.name}</h3><p className="text-gray-400 text-sm">{connected ? 'Connected' : w.disabled ? 'Coming soon' : 'Not connected'}</p></div>
                                            </div>
                                            {!w.disabled && (connected ? (
                                                <div className="flex gap-2">
                                                    <button onClick={() => syncWearable(w.id)} className="px-3 py-1.5 rounded-lg bg-white/10 text-white text-sm hover:bg-white/20"><i className="fas fa-sync-alt mr-1"></i>Sync</button>
                                                    <button onClick={() => disconnectWearable(w.id)} className="px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm hover:bg-red-500/30">Disconnect</button>
                                                </div>
                                            ) : (
                                                <button onClick={() => connectWearable(w.id)} disabled={connecting === w.id} className="px-4 py-2 rounded-xl bg-orange-500 hover:bg-orange-600 text-white font-medium transition-all disabled:opacity-50">{connecting === w.id ? 'Connecting...' : 'Connect'}</button>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            return (
            <>
                <div className="space-y-6">
                    {/* Profile Photo Upload */}
                    <ProfilePhotoUpload user={user} onUploadComplete={() => window.location.reload()} />

                    <div className="text-center">
                        <h1 className="text-xl font-bold text-white">{user?.name || 'Athlete'}</h1>
                        <p className="text-gray-400">{user?.email}</p>
                        <div className="flex justify-center gap-2 mt-3">
                            <span className="px-3 py-1 rounded-full bg-orange-500/20 text-orange-400 text-sm capitalize">{user?.userType || 'Individual'}</span>
                            <span className="px-3 py-1 rounded-full bg-green-500/20 text-green-400 text-sm">{user?.subscription?.tier || 'Free'}</span>
                        </div>
                    </div>

                    {/* ClockWork Intelligence Quick Access */}
                    {connections.filter(c => c.connected).length > 0 && (
                        <button
                            onClick={() => setShowIntelligence(true)}
                            className="w-full glass rounded-2xl p-5 hover:bg-white/5 transition-all border border-orange-500/30"
                        >
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-xl bg-orange-500/20 flex items-center justify-center">
                                        <i className="fas fa-brain text-orange-500 text-xl"></i>
                                    </div>
                                    <div className="text-left">
                                        <h3 className="text-white font-semibold">ClockWork Intelligence</h3>
                                        <p className="text-gray-400 text-sm">View your wearable insights</p>
                                    </div>
                                </div>
                                <i className="fas fa-chevron-right text-gray-500"></i>
                            </div>
                        </button>
                    )}

                    {connections.filter(c => c.connected).length > 0 && (
                        <div className="glass rounded-2xl p-4">
                            <h3 className="text-white font-semibold mb-3">Connected Devices</h3>
                            <div className="flex gap-3">
                                {connections.filter(c => c.connected).map(c => (
                                    <div key={c.provider} className="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-2"><span className="text-green-400"><i className="fas fa-circle text-xs"></i></span><span className="text-white capitalize">{c.provider}</span></div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="glass rounded-2xl divide-y divide-white/10">
                        <button onClick={() => setShowWearables(true)} className="w-full flex items-center justify-between p-4 hover:bg-white/5 transition-colors">
                            <div className="flex items-center gap-3"><i className="fas fa-heart-pulse text-gray-400 w-6"></i><span className="text-white">Connect Wearables</span></div>
                            <div className="flex items-center gap-2">{connections.filter(c => c.connected).length > 0 && <span className="text-green-400 text-sm">{connections.filter(c => c.connected).length} connected</span>}<i className="fas fa-chevron-right text-gray-500"></i></div>
                        </button>
                        <button onClick={() => setShowSubscription(true)} className="w-full flex items-center justify-between p-4 hover:bg-white/5 transition-colors"><div className="flex items-center gap-3"><i className="fas fa-credit-card text-gray-400 w-6"></i><span className="text-white">Subscription</span></div><span className="text-orange-500">{user?.subscription?.tier || 'Free'}</span></button>
                        <button className="w-full flex items-center justify-between p-4 hover:bg-white/5 transition-colors"><div className="flex items-center gap-3"><i className="fas fa-bell text-gray-400 w-6"></i><span className="text-white">Notifications</span></div><i className="fas fa-chevron-right text-gray-500"></i></button>
                    </div>

                    <button onClick={onLogout} className="w-full py-3 text-red-400 hover:text-red-300 transition-colors"><i className="fas fa-sign-out-alt mr-2"></i>Sign Out</button>
                    <div className="text-center text-gray-500 text-sm flex items-center justify-center gap-2">
                        <i className="fas fa-bolt text-orange-500/50"></i>
                        <span>ClockWork v3.0</span>
                        <i className="fas fa-bolt text-orange-500/50"></i>
                    </div>
                </div>
                {showSubscription && <SubscriptionModal user={user} onClose={() => setShowSubscription(false)} />}
            </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- PWA SERVICE WORKER REGISTRATION -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    console.log('ServiceWorker registered:', registration.scope);

                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New version available! Refresh to update.');
                            }
                        });
                    });
                } catch (error) {
                    console.log('ServiceWorker registration failed:', error);
                }
            });
        }

        // Handle PWA install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('PWA install available');
        });

        // Handle successful install
        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            console.log('PWA installed successfully');
        });

        // ============================================
        // WORKOUT BUILDER SYSTEM - APEX-EX PARALLEL BUILD
        // Stream 1: Core Components
        // Stream 2: Library Browser
        // Stream 3: Workout Builder
        // Stream 4: Navigation Integration
        // ============================================

    </script>

    <script type="text/babel">
        // STREAM 1: CORE COMPONENTS ================================

        // Workout Exercise Card Component (Matches Screenshot Design)
        const WorkoutExerciseCard = ({ exercise, onRemove, onEdit, onViewDetails }) => {
            const { name, sets, reps, rest, notes, exerciseId, _libraryData } = exercise;

            return (
                <div className="glass rounded-xl p-4 flex items-center gap-3">
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                            <h4 className="text-white font-medium">{name}</h4>
                            {exerciseId && onViewDetails && (
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        onViewDetails(exerciseId);
                                    }}
                                    className="text-orange-500 hover:text-orange-400 transition-colors"
                                    title="View demonstration"
                                >
                                    <i className="fas fa-arrow-right text-sm"></i>
                                </button>
                            )}
                        </div>
                        <p className="text-gray-400 text-sm mt-1">
                            {sets} sets × {reps}  {rest && `(${rest} rest)`}
                        </p>
                        {notes && <p className="text-gray-500 text-sm italic mt-1">{notes}</p>}
                    </div>
                    {onRemove && (
                        <button
                            onClick={onRemove}
                            className="text-gray-500 hover:text-red-500 transition-colors"
                        >
                            <i className="fas fa-times"></i>
                        </button>
                    )}
                </div>
            );
        };

        // Exercise Library Browser Modal Component
        const ExerciseLibraryBrowser = ({ isOpen, onClose, onSelectExercise }) => {
            const [exercises, setExercises] = useState([]);
            const [loading, setLoading] = useState(false);
            const [search, setSearch] = useState('');
            const [selectedType, setSelectedType] = useState('all');
            const [selectedMuscle, setSelectedMuscle] = useState('all');
            const [page, setPage] = useState(1);

            useEffect(() => {
                if (isOpen) {
                    loadExercises();
                }
            }, [isOpen, search, selectedType, selectedMuscle]);

            const loadExercises = async () => {
                setLoading(true);
                try {
                    let url = '/exercises/library?limit=50';

                    if (search) {
                        url = `/exercises/library/search?q=${encodeURIComponent(search)}`;
                    } else if (selectedMuscle !== 'all') {
                        url = `/exercises/library/muscle/${selectedMuscle}`;
                    }

                    const data = await api.get(url);
                    let results = data.exercises || data.data || [];

                    // Filter by type if selected
                    if (selectedType !== 'all') {
                        results = results.filter(ex => ex.type === selectedType);
                    }

                    setExercises(results);
                } catch (err) {
                    console.error('Failed to load exercises:', err);
                }
                setLoading(false);
            };

            if (!isOpen) return null;

            const exerciseTypes = [
                { value: 'all', label: 'All Types' },
                { value: 'compound', label: 'Compound' },
                { value: 'isolation', label: 'Isolation' },
                { value: 'cardio', label: 'Cardio' },
                { value: 'plyometric', label: 'Plyometric' },
                { value: 'mobility', label: 'Yoga/Mobility' },
                { value: 'stability', label: 'Stability/Core' }
            ];

            const muscleGroups = [
                { value: 'all', label: 'All Muscles' },
                { value: 'chest', label: 'Chest' },
                { value: 'back', label: 'Back' },
                { value: 'shoulders', label: 'Shoulders' },
                { value: 'biceps', label: 'Biceps' },
                { value: 'triceps', label: 'Triceps' },
                { value: 'quads', label: 'Quads' },
                { value: 'hamstrings', label: 'Hamstrings' },
                { value: 'glutes', label: 'Glutes' },
                { value: 'calves', label: 'Calves' },
                { value: 'abs', label: 'Abs' },
                { value: 'full_body', label: 'Full Body' }
            ];

            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="glass rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-white/10 flex items-center justify-between">
                            <div>
                                <h2 className="text-xl font-bold text-white">Exercise Library</h2>
                                <p className="text-gray-400 text-sm">633 exercises with videos</p>
                            </div>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Search & Filters */}
                        <div className="p-4 space-y-3 border-b border-white/10">
                            <input
                                type="text"
                                placeholder="Search exercises..."
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                                className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                            />
                            <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                                {exerciseTypes.map(type => (
                                    <button
                                        key={type.value}
                                        onClick={() => setSelectedType(type.value)}
                                        className={`px-4 py-2 rounded-lg whitespace-nowrap transition-all ${
                                            selectedType === type.value
                                                ? 'bg-orange-500 text-white'
                                                : 'bg-white/10 text-gray-400 hover:bg-white/20'
                                        }`}
                                    >
                                        {type.label}
                                    </button>
                                ))}
                            </div>
                            <select
                                value={selectedMuscle}
                                onChange={(e) => setSelectedMuscle(e.target.value)}
                                className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none"
                            >
                                {muscleGroups.map(muscle => (
                                    <option key={muscle.value} value={muscle.value} className="bg-gray-900">
                                        {muscle.label}
                                    </option>
                                ))}
                            </select>
                        </div>

                        {/* Exercise List */}
                        <div className="flex-1 overflow-y-auto p-4">
                            {loading ? (
                                <div className="text-center py-12">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
                                    <p className="text-gray-400 mt-3">Loading exercises...</p>
                                </div>
                            ) : exercises.length === 0 ? (
                                <div className="text-center py-12">
                                    <i className="fas fa-search text-4xl text-gray-600 mb-3"></i>
                                    <p className="text-gray-400">No exercises found</p>
                                </div>
                            ) : (
                                <div className="grid gap-2">
                                    {exercises.map((exercise) => (
                                        <button
                                            key={exercise.id}
                                            onClick={() => {
                                                onSelectExercise(exercise);
                                                onClose();
                                            }}
                                            className="glass rounded-xl p-4 flex items-center gap-3 hover:bg-white/10 transition-all text-left"
                                        >
                                            <div className="w-12 h-12 rounded-lg bg-orange-500/20 flex items-center justify-center flex-shrink-0">
                                                <i className={`fas ${
                                                    exercise.type === 'cardio' ? 'fa-heartbeat' :
                                                    exercise.type === 'mobility' ? 'fa-yoga' :
                                                    exercise.type === 'plyometric' ? 'fa-bolt' :
                                                    'fa-dumbbell'
                                                } text-orange-500`}></i>
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h4 className="text-white font-medium truncate">{exercise.name}</h4>
                                                <div className="flex items-center gap-2 text-xs text-gray-400 mt-1">
                                                    <span className="capitalize">{exercise.primary?.[0] || 'General'}</span>
                                                    <span>•</span>
                                                    <span className="capitalize">{exercise.type || 'Exercise'}</span>
                                                    {exercise.equipment && (
                                                        <>
                                                            <span>•</span>
                                                            <span className="capitalize">{exercise.equipment[0]}</span>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                            <i className="fas fa-plus text-orange-500"></i>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Exercise Detail Modal (for arrow click demonstrations)
        const ExerciseDetailModal = ({ exerciseId, onClose }) => {
            const [exercise, setExercise] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (exerciseId) {
                    loadExerciseDetails();
                }
            }, [exerciseId]);

            const loadExerciseDetails = async () => {
                setLoading(true);
                try {
                    // Try video library first (has videos)
                    let data = await api.get(`/exercises/videos/${exerciseId}`);
                    if (data.exercise) {
                        setExercise(data.exercise);
                    } else {
                        // Fallback to static library
                        data = await api.get(`/exercises/library/${exerciseId}`);
                        setExercise(data.exercise || data.data);
                    }
                } catch (err) {
                    console.error('Failed to load exercise:', err);
                }
                setLoading(false);
            };

            if (!exerciseId) return null;

            return (
                <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="glass rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        {loading ? (
                            <div className="p-12 text-center">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mb-3"></div>
                                <p className="text-gray-400">Loading exercise...</p>
                            </div>
                        ) : exercise ? (
                            <>
                                <div className="p-4 border-b border-white/10 flex items-center justify-between">
                                    <h2 className="text-lg font-bold text-white">{exercise.name}</h2>
                                    <button onClick={onClose} className="text-gray-400 hover:text-white">
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>

                                {/* Video Player */}
                                {exercise.videos?.[0] && (
                                    <div className="aspect-video bg-black">
                                        <video
                                            src={exercise.videos[0]}
                                            controls
                                            autoPlay
                                            loop
                                            muted
                                            playsInline
                                            className="w-full h-full object-contain"
                                        />
                                    </div>
                                )}

                                {/* Exercise Details */}
                                <div className="p-4 space-y-4">
                                    {/* Primary Muscle Badge */}
                                    {exercise.primaryMuscles?.[0] && (
                                        <div className="inline-block bg-orange-500/20 text-orange-500 px-3 py-1 rounded-full text-sm capitalize">
                                            {exercise.primaryMuscles[0]}
                                        </div>
                                    )}

                                    {/* Equipment & Difficulty */}
                                    <div className="grid grid-cols-2 gap-3">
                                        {exercise.equipment && (
                                            <div className="glass rounded-lg p-3 text-center">
                                                <i className="fas fa-dumbbell text-orange-500 text-xl mb-2"></i>
                                                <p className="text-white text-sm font-medium capitalize">{exercise.equipment}</p>
                                                <p className="text-gray-500 text-xs">Equipment</p>
                                            </div>
                                        )}
                                        {exercise.difficulty && (
                                            <div className="glass rounded-lg p-3 text-center">
                                                <i className="fas fa-chart-line text-orange-500 text-xl mb-2"></i>
                                                <p className="text-white text-sm font-medium capitalize">{exercise.difficulty}</p>
                                                <p className="text-gray-500 text-xs">Difficulty</p>
                                            </div>
                                        )}
                                    </div>

                                    {/* Instructions */}
                                    {exercise.instructions && exercise.instructions.length > 0 && (
                                        <div>
                                            <h3 className="text-white font-medium mb-2">Instructions</h3>
                                            <ol className="space-y-2 text-gray-300 text-sm">
                                                {exercise.instructions.map((instruction, i) => (
                                                    <li key={i}>
                                                        <span className="text-orange-500 font-medium">{i + 1}.</span> {instruction}
                                                    </li>
                                                ))}
                                            </ol>
                                        </div>
                                    )}

                                    {/* Cues */}
                                    {exercise.cues && exercise.cues.length > 0 && (
                                        <div>
                                            <h3 className="text-white font-medium mb-2 flex items-center gap-2">
                                                <i className="fas fa-lightbulb text-orange-500"></i>
                                                Form Cues
                                            </h3>
                                            <ul className="space-y-1 text-gray-300 text-sm">
                                                {exercise.cues.map((cue, i) => (
                                                    <li key={i} className="flex items-start gap-2">
                                                        <i className="fas fa-check text-green-500 text-xs mt-1"></i>
                                                        <span>{cue}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="p-12 text-center">
                                <i className="fas fa-exclamation-circle text-4xl text-gray-600 mb-3"></i>
                                <p className="text-gray-400">Exercise not found</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // STREAM 3: WORKOUT BUILDER ================================

        const WorkoutBuilder = ({ isOpen, onClose, user, clientId }) => {
            const [workoutName, setWorkoutName] = useState('');
            const [exercises, setExercises] = useState([]);
            const [scheduledDate, setScheduledDate] = useState('');
            const [notes, setNotes] = useState('');
            const [showLibrary, setShowLibrary] = useState(false);
            const [editingExercise, setEditingExercise] = useState(null);
            const [saving, setSaving] = useState(false);
            const [clients, setClients] = useState([]);
            const [selectedClient, setSelectedClient] = useState(clientId || '');
            const [viewingExerciseId, setViewingExerciseId] = useState(null);

            useEffect(() => {
                if (isOpen && user.userType === 'coach') {
                    loadClients();
                }
            }, [isOpen]);

            const loadClients = async () => {
                try {
                    const data = await api.get('/coach/clients');
                    setClients(data.clients || []);
                } catch (err) {
                    console.error('Failed to load clients:', err);
                }
            };

            const handleSelectExercise = (exercise) => {
                const newExercise = {
                    exerciseId: exercise.id,
                    name: exercise.name,
                    sets: 3,
                    reps: '10-12',
                    rest: '90s',
                    notes: '',
                    _libraryData: {
                        id: exercise.id,
                        name: exercise.name,
                        videoUrl: `/exercises/library/${exercise.id}`,
                        primary: exercise.primary,
                        equipment: exercise.equipment,
                        type: exercise.type
                    }
                };
                setExercises([...exercises, newExercise]);
            };

            const handleRemoveExercise = (index) => {
                setExercises(exercises.filter((_, i) => i !== index));
            };

            const handleSaveWorkout = async () => {
                if (!workoutName.trim()) {
                    alert('Please enter a workout name');
                    return;
                }

                if (exercises.length === 0) {
                    alert('Please add at least one exercise');
                    return;
                }

                if (user.userType === 'coach' && !selectedClient) {
                    alert('Please select a client');
                    return;
                }

                setSaving(true);
                try {
                    const targetClient = user.userType === 'coach' ? selectedClient : user._id;
                    const endpoint = user.userType === 'coach'
                        ? `/coach/clients/${targetClient}/workouts`
                        : '/workouts';

                    const payload = {
                        name: workoutName,
                        exercises: exercises.map(({ exerciseId, name, sets, reps, rest, notes }) => ({
                            exerciseId,
                            name,
                            sets,
                            reps,
                            rest,
                            notes
                        })),
                        scheduledDate: scheduledDate || null,
                        notes
                    };

                    await api.post(endpoint, payload);
                    alert('Workout saved successfully!');
                    onClose();

                    // Reset form
                    setWorkoutName('');
                    setExercises([]);
                    setScheduledDate('');
                    setNotes('');
                } catch (err) {
                    console.error('Failed to save workout:', err);
                    alert(err.message || 'Failed to save workout');
                }
                setSaving(false);
            };

            if (!isOpen) return null;

            return (
                <>
                    <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={onClose}>
                        <div className="glass rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                            <div className="p-4 border-b border-white/10 flex items-center justify-between">
                                <h2 className="text-xl font-bold text-white">Create Workout</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-white">
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                {/* Workout Name */}
                                <input
                                    type="text"
                                    placeholder="Workout Name (e.g., Upper Strength)"
                                    value={workoutName}
                                    onChange={(e) => setWorkoutName(e.target.value)}
                                    className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                                />

                                {/* Client Selector (Coach Only) */}
                                {user.userType === 'coach' && (
                                    <select
                                        value={selectedClient}
                                        onChange={(e) => setSelectedClient(e.target.value)}
                                        className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none"
                                    >
                                        <option value="" className="bg-gray-900">Select Client</option>
                                        {clients.map(client => (
                                            <option key={client.id} value={client.id} className="bg-gray-900">
                                                {client.name}
                                            </option>
                                        ))}
                                    </select>
                                )}

                                {/* Scheduled Date */}
                                <input
                                    type="date"
                                    value={scheduledDate}
                                    onChange={(e) => setScheduledDate(e.target.value)}
                                    className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:border-orange-500 focus:outline-none"
                                />

                                {/* Exercises */}
                                <div>
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="text-white font-medium">Exercises ({exercises.length})</h3>
                                        <button
                                            onClick={() => setShowLibrary(true)}
                                            className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all flex items-center gap-2"
                                        >
                                            <i className="fas fa-plus"></i>
                                            Add Exercise
                                        </button>
                                    </div>

                                    {exercises.length === 0 ? (
                                        <div className="glass rounded-xl p-8 text-center">
                                            <i className="fas fa-dumbbell text-4xl text-gray-600 mb-3"></i>
                                            <p className="text-gray-400">No exercises added yet</p>
                                            <button
                                                onClick={() => setShowLibrary(true)}
                                                className="text-orange-500 hover:text-orange-400 mt-2"
                                            >
                                                Browse 633 exercises →
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {exercises.map((exercise, index) => (
                                                <div key={index}>
                                                    <WorkoutExerciseCard
                                                        exercise={exercise}
                                                        onRemove={() => handleRemoveExercise(index)}
                                                        onViewDetails={(id) => setViewingExerciseId(id)}
                                                    />
                                                    {editingExercise === index && (
                                                        <div className="mt-2 glass rounded-xl p-4 space-y-3">
                                                            <div className="grid grid-cols-2 gap-3">
                                                                <input
                                                                    type="number"
                                                                    placeholder="Sets"
                                                                    value={exercise.sets}
                                                                    onChange={(e) => {
                                                                        const updated = [...exercises];
                                                                        updated[index].sets = parseInt(e.target.value) || 1;
                                                                        setExercises(updated);
                                                                    }}
                                                                    className="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white"
                                                                />
                                                                <input
                                                                    type="text"
                                                                    placeholder="Reps"
                                                                    value={exercise.reps}
                                                                    onChange={(e) => {
                                                                        const updated = [...exercises];
                                                                        updated[index].reps = e.target.value;
                                                                        setExercises(updated);
                                                                    }}
                                                                    className="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white"
                                                                />
                                                            </div>
                                                            <input
                                                                type="text"
                                                                placeholder="Rest (e.g., 90s, 2min)"
                                                                value={exercise.rest}
                                                                onChange={(e) => {
                                                                    const updated = [...exercises];
                                                                    updated[index].rest = e.target.value;
                                                                    setExercises(updated);
                                                                }}
                                                                className="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white"
                                                            />
                                                            <input
                                                                type="text"
                                                                placeholder="Notes (optional)"
                                                                value={exercise.notes}
                                                                onChange={(e) => {
                                                                    const updated = [...exercises];
                                                                    updated[index].notes = e.target.value;
                                                                    setExercises(updated);
                                                                }}
                                                                className="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white"
                                                            />
                                                            <button
                                                                onClick={() => setEditingExercise(null)}
                                                                className="text-orange-500 hover:text-orange-400 text-sm"
                                                            >
                                                                Done Editing
                                                            </button>
                                                        </div>
                                                    )}
                                                    {editingExercise !== index && (
                                                        <button
                                                            onClick={() => setEditingExercise(index)}
                                                            className="text-gray-500 hover:text-orange-500 text-xs mt-1"
                                                        >
                                                            Edit sets/reps/rest
                                                        </button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Notes */}
                                <textarea
                                    placeholder="Workout notes (optional)"
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    rows={3}
                                    className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none resize-none"
                                />
                            </div>

                            <div className="p-4 border-t border-white/10 flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl transition-all"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleSaveWorkout}
                                    disabled={saving}
                                    className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50"
                                >
                                    {saving ? 'Saving...' : 'Save Workout'}
                                </button>
                            </div>
                        </div>
                    </div>

                    <ExerciseLibraryBrowser
                        isOpen={showLibrary}
                        onClose={() => setShowLibrary(false)}
                        onSelectExercise={handleSelectExercise}
                    />

                    {viewingExerciseId && (
                        <ExerciseDetailModal
                            exerciseId={viewingExerciseId}
                            onClose={() => setViewingExerciseId(null)}
                        />
                    )}
                </>
            );
        };

        // ============================================
        // CLOCKWORK INTELLIGENCE SYSTEM
        // Wearable data branded as native platform intelligence
        // ============================================

        // ClockWork Intelligence Dashboard Component
        const ClockWorkIntelligence = ({ userId, isCoach = false }) => {
            const [intelligence, setIntelligence] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncing, setSyncing] = useState(false);
            const [connections, setConnections] = useState([]);

            useEffect(() => {
                loadIntelligence();
                loadConnections();
            }, [userId]);

            const loadIntelligence = async () => {
                setLoading(true);
                try {
                    const data = await api.get(`/intelligence/${userId}`);
                    setIntelligence(data);
                } catch (err) {
                    console.error('Failed to load intelligence:', err);
                }
                setLoading(false);
            };

            const loadConnections = async () => {
                try {
                    const data = await api.get('/wearables/connections');
                    setConnections(data.connections || []);
                } catch (err) {
                    console.error('Failed to load connections:', err);
                }
            };

            const handleSync = async () => {
                setSyncing(true);
                try {
                    // Sync all connected providers
                    const connected = connections.filter(c => c.connected);
                    for (const conn of connected) {
                        await api.post(`/wearables/sync/${conn.provider}`);
                    }
                    // Reload intelligence after sync
                    await loadIntelligence();
                    alert('✓ Intelligence synced successfully!');
                } catch (err) {
                    alert('Sync failed: ' + err.message);
                }
                setSyncing(false);
            };

            if (loading) {
                return (
                    <div className="glass rounded-2xl p-8 text-center">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mb-3"></div>
                        <p className="text-gray-400">Loading intelligence...</p>
                    </div>
                );
            }

            const wearableData = intelligence?.wearableData;
            const aiInsights = intelligence?.aiInsights;
            const hasConnectedDevices = connections.filter(c => c.connected).length > 0;

            return (
                <div className="space-y-6">
                    {/* Header with Sync Button */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                <i className="fas fa-brain text-orange-500"></i>
                                ClockWork Intelligence
                            </h2>
                            <p className="text-gray-400 text-sm mt-1">Last 24 hours</p>
                        </div>
                        {hasConnectedDevices && (
                            <button
                                onClick={handleSync}
                                disabled={syncing}
                                className="bg-orange-500 hover:bg-orange-600 disabled:opacity-50 text-white px-4 py-2 rounded-xl transition-all flex items-center gap-2"
                            >
                                <i className={`fas fa-sync-alt ${syncing ? 'animate-spin' : ''}`}></i>
                                {syncing ? 'Syncing...' : 'Sync Now'}
                            </button>
                        )}
                    </div>

                    {/* No devices connected state */}
                    {!hasConnectedDevices ? (
                        <div className="glass rounded-2xl p-8 text-center">
                            <i className="fas fa-watch text-5xl text-gray-600 mb-4"></i>
                            <h3 className="text-white font-semibold mb-2">Connect Your Wearable</h3>
                            <p className="text-gray-400 mb-4">
                                Connect your fitness tracker to unlock personalized intelligence
                            </p>
                            <button
                                onClick={() => window.location.hash = '#profile'}
                                className="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl inline-flex items-center gap-2"
                            >
                                <i className="fas fa-plus"></i>
                                Connect Device
                            </button>
                        </div>
                    ) : (
                        <>
                            {/* AI Insights Banner */}
                            {aiInsights && (
                                <div className="glass rounded-2xl p-5 border-l-4 border-orange-500">
                                    <div className="flex items-start gap-3">
                                        <i className="fas fa-lightbulb text-orange-500 text-xl mt-1"></i>
                                        <div className="flex-1">
                                            <h3 className="text-white font-semibold mb-1">Intelligence Summary</h3>
                                            <p className="text-gray-300 text-sm leading-relaxed">{aiInsights}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Metrics Grid */}
                            {wearableData && (
                                <div className="grid grid-cols-2 gap-4">
                                    {/* Steps */}
                                    <div className="glass rounded-2xl p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-400 text-sm">Steps</span>
                                            <i className="fas fa-walking text-orange-500"></i>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {wearableData.steps?.toLocaleString() || '0'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">Daily movement</div>
                                    </div>

                                    {/* Calories */}
                                    <div className="glass rounded-2xl p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-400 text-sm">Calories</span>
                                            <i className="fas fa-fire text-orange-500"></i>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {wearableData.caloriesBurned?.toLocaleString() || '0'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">Burned today</div>
                                    </div>

                                    {/* Sleep */}
                                    <div className="glass rounded-2xl p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-400 text-sm">Sleep</span>
                                            <i className="fas fa-bed text-orange-500"></i>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {wearableData.sleepDuration ? `${(wearableData.sleepDuration / 60).toFixed(1)}h` : '0h'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">Last night</div>
                                    </div>

                                    {/* HRV */}
                                    <div className="glass rounded-2xl p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-400 text-sm">HRV</span>
                                            <i className="fas fa-heartbeat text-orange-500"></i>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {wearableData.hrv || '—'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">Milliseconds</div>
                                    </div>

                                    {/* Resting Heart Rate */}
                                    <div className="glass rounded-2xl p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-400 text-sm">Resting HR</span>
                                            <i className="fas fa-heart text-orange-500"></i>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {wearableData.restingHeartRate || '—'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">Beats per min</div>
                                    </div>

                                    {/* Recovery Score */}
                                    <div className="glass rounded-2xl p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-400 text-sm">Recovery</span>
                                            <i className="fas fa-battery-three-quarters text-orange-500"></i>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {wearableData.recoveryScore ? `${wearableData.recoveryScore}%` : '—'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">Readiness</div>
                                    </div>

                                    {/* Active Minutes */}
                                    <div className="glass rounded-2xl p-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-400 text-sm">Active</span>
                                            <i className="fas fa-running text-orange-500"></i>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {wearableData.activeMinutes || '0'}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">Minutes</div>
                                    </div>

                                    {/* Heart Rate Zones */}
                                    {wearableData.heartRateZones && (
                                        <div className="glass rounded-2xl p-4">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-gray-400 text-sm">HR Zones</span>
                                                <i className="fas fa-chart-area text-orange-500"></i>
                                            </div>
                                            <div className="flex gap-1 mt-2">
                                                {['cardio', 'fatBurn', 'peak'].map((zone, i) => {
                                                    const minutes = wearableData.heartRateZones[zone] || 0;
                                                    return (
                                                        <div key={zone} className="flex-1 text-center">
                                                            <div className={`h-12 rounded flex items-end justify-center ${
                                                                i === 0 ? 'bg-blue-500/30' : i === 1 ? 'bg-orange-500/30' : 'bg-red-500/30'
                                                            }`}>
                                                                <span className="text-white text-xs font-bold mb-1">{minutes}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-500 mt-1 capitalize">{zone}</div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Connected Devices (subtle) */}
                            <div className="glass rounded-xl p-4">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <i className="fas fa-circle text-green-500 text-xs"></i>
                                        <span className="text-gray-400 text-sm">
                                            {connections.filter(c => c.connected).length} device{connections.filter(c => c.connected).length !== 1 ? 's' : ''} connected
                                        </span>
                                    </div>
                                    <div className="flex gap-2">
                                        {connections.filter(c => c.connected).map(conn => (
                                            <span key={conn.provider} className="text-xs text-gray-500 capitalize">
                                                {conn.provider}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // Profile Photo Upload Component
        const ProfilePhotoUpload = ({ user, onUploadComplete }) => {
            const [uploading, setUploading] = useState(false);
            const [preview, setPreview] = useState(null);
            const fileInputRef = React.useRef(null);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onloadend = () => {
                    setPreview(reader.result);
                };
                reader.readAsDataURL(file);
            };

            const handleUpload = async () => {
                if (!preview) return;

                setUploading(true);
                try {
                    if (user.userType === 'coach') {
                        // Coaches: POST to /coach/profile/picture with imageData
                        await api.post('/coach/profile/picture', { imageData: preview });
                    } else {
                        // Clients/Individuals: Update via PUT /users/profile
                        await api.put('/users/profile', { profilePicture: preview });
                    }

                    alert('✓ Profile photo updated!');
                    setPreview(null);
                    if (onUploadComplete) onUploadComplete();
                } catch (err) {
                    console.error('Upload error:', err);
                    alert('Upload failed: ' + (err.message || 'Unknown error'));
                }
                setUploading(false);
            };

            return (
                <div className="glass rounded-2xl p-5">
                    <h3 className="text-white font-semibold mb-4">Profile Photo</h3>

                    <div className="flex items-center gap-4">
                        {/* Current/Preview Photo */}
                        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center overflow-hidden">
                            {preview ? (
                                <img src={preview} alt="Preview" className="w-full h-full object-cover" />
                            ) : user?.coachProfile?.profilePicture || user?.profile?.photo ? (
                                <img
                                    src={user.coachProfile?.profilePicture || user.profile?.photo}
                                    alt={user.name}
                                    className="w-full h-full object-cover"
                                />
                            ) : (
                                <i className="fas fa-user text-4xl text-white"></i>
                            )}
                        </div>

                        {/* Upload Controls */}
                        <div className="flex-1">
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*"
                                onChange={handleFileSelect}
                                className="hidden"
                            />

                            {!preview ? (
                                <button
                                    onClick={() => fileInputRef.current?.click()}
                                    className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-xl transition-all flex items-center gap-2"
                                >
                                    <i className="fas fa-camera"></i>
                                    Choose Photo
                                </button>
                            ) : (
                                <div className="flex gap-2">
                                    <button
                                        onClick={handleUpload}
                                        disabled={uploading}
                                        className="bg-green-500 hover:bg-green-600 disabled:opacity-50 text-white px-4 py-2 rounded-xl transition-all flex items-center gap-2"
                                    >
                                        <i className="fas fa-check"></i>
                                        {uploading ? 'Uploading...' : 'Save'}
                                    </button>
                                    <button
                                        onClick={() => setPreview(null)}
                                        className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-xl transition-all"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            )}
                            <p className="text-gray-500 text-xs mt-2">Max 5MB • JPG, PNG, GIF</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Coach Client Detail View with Intelligence
        const CoachClientDetailView = ({ clientId, onBack }) => {
            const [client, setClient] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('intelligence');

            useEffect(() => {
                loadClientDetails();
            }, [clientId]);

            const loadClientDetails = async () => {
                setLoading(true);
                try {
                    const data = await api.get(`/coach/clients/${clientId}`);
                    setClient(data.client);
                } catch (err) {
                    console.error('Failed to load client:', err);
                }
                setLoading(false);
            };

            if (loading) {
                return (
                    <div className="glass rounded-2xl p-8 text-center">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
                    </div>
                );
            }

            if (!client) {
                return (
                    <div className="glass rounded-2xl p-8 text-center">
                        <p className="text-gray-400">Client not found</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="flex items-center gap-4">
                        <button onClick={onBack} className="text-gray-400 hover:text-white">
                            <i className="fas fa-arrow-left text-xl"></i>
                        </button>
                        <div className="flex items-center gap-4 flex-1">
                            <div className="w-16 h-16 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center overflow-hidden">
                                {client.profile?.photo ? (
                                    <img src={client.profile.photo} alt={client.name} className="w-full h-full object-cover" />
                                ) : (
                                    <i className="fas fa-user text-2xl text-white"></i>
                                )}
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-white">{client.name}</h1>
                                <p className="text-gray-400">{client.email}</p>
                            </div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex gap-2 border-b border-white/10">
                        <button
                            onClick={() => setActiveTab('intelligence')}
                            className={`px-4 py-2 transition-all ${
                                activeTab === 'intelligence'
                                    ? 'text-orange-500 border-b-2 border-orange-500'
                                    : 'text-gray-400 hover:text-white'
                            }`}
                        >
                            Intelligence
                        </button>
                        <button
                            onClick={() => setActiveTab('workouts')}
                            className={`px-4 py-2 transition-all ${
                                activeTab === 'workouts'
                                    ? 'text-orange-500 border-b-2 border-orange-500'
                                    : 'text-gray-400 hover:text-white'
                            }`}
                        >
                            Workouts
                        </button>
                        <button
                            onClick={() => setActiveTab('notes')}
                            className={`px-4 py-2 transition-all ${
                                activeTab === 'notes'
                                    ? 'text-orange-500 border-b-2 border-orange-500'
                                    : 'text-gray-400 hover:text-white'
                            }`}
                        >
                            Notes
                        </button>
                    </div>

                    {/* Tab Content */}
                    {activeTab === 'intelligence' && (
                        <ClockWorkIntelligence userId={clientId} isCoach={true} />
                    )}

                    {activeTab === 'workouts' && (
                        <div className="glass rounded-2xl p-8 text-center">
                            <i className="fas fa-dumbbell text-4xl text-gray-600 mb-3"></i>
                            <p className="text-gray-400">Client workout history coming soon</p>
                        </div>
                    )}

                    {activeTab === 'notes' && (
                        <div className="glass rounded-2xl p-5">
                            <textarea
                                placeholder="Add notes about this client..."
                                rows={6}
                                className="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none resize-none"
                            />
                            <button className="mt-3 bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-xl">
                                Save Notes
                            </button>
                        </div>
                    )}
                </div>
            );
        };

    </script>
</body>
</html>
