<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ClockWork Admin Dashboard">
    <meta name="theme-color" content="#f97316">
    <title>ClockWork Admin Dashboard</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clockwork: { orange: '#f97316', dark: '#0a0a0a', darker: '#050505' }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .glow { box-shadow: 0 0 30px rgba(249, 115, 22, 0.3); }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // API Configuration - use relative path to go through Vercel proxy
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:5000/api'
            : '/api';

        // API Helper
        const api = {
            async fetch(endpoint, options = {}) {
                const token = localStorage.getItem('adminToken');
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : '',
                        ...options.headers
                    }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Request failed');
                return data;
            }
        };

        // Login Component
        function LoginForm({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    const res = await api.fetch('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ email, password })
                    });

                    localStorage.setItem('adminToken', res.token);

                    // Test admin access
                    await api.fetch('/admin/stats');
                    onLogin(res.user);
                } catch (err) {
                    setError(err.message === 'Admin access required'
                        ? 'You do not have admin access. Contact support.'
                        : err.message);
                    localStorage.removeItem('adminToken');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass rounded-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="text-4xl mb-2"><i className="fas fa-bolt text-orange-500"></i></div>
                            <h1 className="text-2xl font-bold">ClockWork Admin</h1>
                            <p className="text-gray-400 mt-2">Sign in with your admin account</p>
                        </div>

                        {error && (
                            <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4 text-red-300 text-sm">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-gray-400 text-sm mb-2">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-orange-500"
                                    placeholder="admin@example.com"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-gray-400 text-sm mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-orange-500"
                                    placeholder="********"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50"
                            >
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Stat Card Component
        function StatCard({ icon, label, value, subValue, color = 'orange' }) {
            const colors = {
                orange: 'text-orange-500',
                green: 'text-green-500',
                blue: 'text-blue-500',
                purple: 'text-purple-500',
                yellow: 'text-yellow-500'
            };

            return (
                <div className="stat-card rounded-xl p-4 border border-white/10">
                    <div className="flex items-center gap-3">
                        <div className={`text-2xl ${colors[color]}`}>
                            <i className={`fas fa-${icon}`}></i>
                        </div>
                        <div>
                            <div className="text-gray-400 text-sm">{label}</div>
                            <div className="text-2xl font-bold">{value?.toLocaleString() || 0}</div>
                            {subValue && <div className="text-xs text-gray-500">{subValue}</div>}
                        </div>
                    </div>
                </div>
            );
        }

        // User Row Component
        function UserRow({ user, onAddVIP, onRemoveVIP, onUpdateType, onUpdateTier }) {
            const [editing, setEditing] = useState(false);
            const [editingTier, setEditingTier] = useState(false);
            const [newType, setNewType] = useState(user.userType || 'member');
            const [newTier, setNewTier] = useState(user.subscription?.tier || 'free');
            const [saving, setSaving] = useState(false);
            const [savingTier, setSavingTier] = useState(false);

            const tierColors = {
                free: 'bg-gray-500',
                pro: 'bg-blue-500',
                vip: 'bg-yellow-500',
                elite: 'bg-purple-500',
                coach_starter: 'bg-green-500',
                coach_pro: 'bg-green-600',
                coach_scale: 'bg-green-700',
                coach_enterprise: 'bg-green-800'
            };

            const typeColors = {
                member: 'text-gray-400',
                individual: 'text-blue-400',
                coach: 'text-green-400',
                client: 'text-purple-400',
                influencer: 'text-pink-400'
            };

            const tier = user.subscription?.tier || 'free';
            const isVIP = tier === 'vip';

            const handleSaveType = async () => {
                if (newType === user.userType) {
                    setEditing(false);
                    return;
                }
                setSaving(true);
                await onUpdateType(user._id, newType);
                setSaving(false);
                setEditing(false);
            };

            const handleSaveTier = async () => {
                if (newTier === tier) {
                    setEditingTier(false);
                    return;
                }
                setSavingTier(true);
                await onUpdateTier(user._id, newTier);
                setSavingTier(false);
                setEditingTier(false);
            };

            return (
                <tr className="border-b border-white/5 hover:bg-white/5">
                    <td className="py-3 px-4">
                        <div className="font-medium">{user.name}</div>
                        <div className="text-gray-500 text-sm">{user.email}</div>
                    </td>
                    <td className="py-3 px-4">
                        {editing ? (
                            <div className="flex items-center gap-2">
                                <select
                                    value={newType}
                                    onChange={(e) => setNewType(e.target.value)}
                                    className="bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-orange-500"
                                >
                                    <option value="member">Member</option>
                                    <option value="individual">Individual</option>
                                    <option value="coach">Coach</option>
                                    <option value="influencer">Influencer</option>
                                    <option value="client">Client</option>
                                </select>
                                <button
                                    onClick={handleSaveType}
                                    disabled={saving}
                                    className="text-green-400 hover:text-green-300 text-sm"
                                >
                                    {saving ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-check"></i>}
                                </button>
                                <button
                                    onClick={() => { setEditing(false); setNewType(user.userType || 'member'); }}
                                    className="text-red-400 hover:text-red-300 text-sm"
                                >
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                        ) : (
                            <span
                                className={`${typeColors[user.userType] || 'text-gray-400'} capitalize cursor-pointer hover:underline`}
                                onClick={() => setEditing(true)}
                                title="Click to edit"
                            >
                                {user.userType || 'member'}
                            </span>
                        )}
                    </td>
                    <td className="py-3 px-4">
                        {editingTier ? (
                            <div className="flex items-center gap-2">
                                <select
                                    value={newTier}
                                    onChange={(e) => setNewTier(e.target.value)}
                                    className="bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-orange-500"
                                >
                                    <option value="free">Free</option>
                                    <option value="pro">Pro</option>
                                    <option value="vip">VIP</option>
                                    <option value="elite">Elite</option>
                                    <option value="coach_starter">Coach Starter</option>
                                    <option value="coach_pro">Coach Pro</option>
                                    <option value="coach_scale">Coach Scale</option>
                                    <option value="coach_enterprise">Coach Enterprise</option>
                                </select>
                                <button
                                    onClick={handleSaveTier}
                                    disabled={savingTier}
                                    className="text-green-400 hover:text-green-300 text-sm"
                                >
                                    {savingTier ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-check"></i>}
                                </button>
                                <button
                                    onClick={() => { setEditingTier(false); setNewTier(tier); }}
                                    className="text-red-400 hover:text-red-300 text-sm"
                                >
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                        ) : (
                            <div className="flex items-center gap-2">
                                <span
                                    className={`${tierColors[tier]} text-white text-xs px-2 py-1 rounded-full cursor-pointer hover:opacity-80`}
                                    onClick={() => setEditingTier(true)}
                                    title="Click to edit tier"
                                >
                                    {tier.replace('_', ' ').toUpperCase()}
                                </span>
                                {user.isEnvVIP && (
                                    <span className="text-yellow-500 text-xs" title="Set via VIP_EMAILS env var">
                                        <i className="fas fa-star"></i>
                                    </span>
                                )}
                                {tier !== 'free' && (
                                    <button
                                        onClick={() => onUpdateTier(user._id, 'free')}
                                        className="text-red-400 hover:text-red-300 text-xs"
                                        title="Remove tier (reset to free)"
                                    >
                                        <i className="fas fa-trash-alt"></i>
                                    </button>
                                )}
                            </div>
                        )}
                    </td>
                    <td className="py-3 px-4 text-gray-400 text-sm">
                        {new Date(user.createdAt).toLocaleDateString()}
                    </td>
                    <td className="py-3 px-4 text-gray-400 text-sm">
                        {user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}
                    </td>
                    <td className="py-3 px-4">
                        {isVIP ? (
                            <button
                                onClick={() => onRemoveVIP(user.email)}
                                disabled={user.isEnvVIP}
                                className={`text-red-400 hover:text-red-300 text-sm ${user.isEnvVIP ? 'opacity-50 cursor-not-allowed' : ''}`}
                                title={user.isEnvVIP ? 'Remove from VIP_EMAILS env var' : 'Remove VIP'}
                            >
                                <i className="fas fa-crown-alt mr-1"></i>
                                Remove VIP
                            </button>
                        ) : (
                            <button
                                onClick={() => onAddVIP(user.email)}
                                className="text-yellow-400 hover:text-yellow-300 text-sm"
                            >
                                <i className="fas fa-crown mr-1"></i>
                                Make VIP
                            </button>
                        )}
                    </td>
                </tr>
            );
        }

        function InfluencerApplicationRow({ app, onApprove, onDeny }) {
            const getEngagementColor = (rate) => {
                if (rate < 3) return 'text-red-400';
                if (rate >= 5) return 'text-green-400';
                return 'text-yellow-400';
            };

            return (
                <tr className="border-b border-white/5 hover:bg-white/5">
                    <td className="py-3 px-4">
                        <div className="font-medium">{app.name}</div>
                        <div className="text-gray-500 text-sm">{app.email}</div>
                    </td>
                    <td className="py-3 px-4">{app.platform}</td>
                    <td className="py-3 px-4">{(app.followerCount || 0).toLocaleString()}</td>
                    <td className={`py-3 px-4 font-bold ${getEngagementColor(app.engagementRate)}`}>
                        {app.engagementRate ? `${app.engagementRate}%` : 'N/A'}
                    </td>
                    <td className="py-3 px-4">
                        {app.videoLinks && app.videoLinks.length > 0 ? (
                            app.videoLinks.map((link, i) => (
                                <a key={i} href={link} target="_blank" rel="noopener noreferrer" className="text-orange-400 hover:underline text-sm block">
                                    Link {i + 1} <i className="fas fa-external-link-alt ml-1"></i>
                                </a>
                            ))
                        ) : (
                            <span className="text-gray-500 text-sm">No links</span>
                        )}
                    </td>
                    <td className="py-3 px-4 text-gray-400 text-sm">{new Date(app.createdAt).toLocaleDateString()}</td>
                    <td className="py-3 px-4">
                        <div className="flex gap-2">
                            <button onClick={() => onApprove(app._id)} className="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm">Approve</button>
                            <button onClick={() => onDeny(app._id)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Deny</button>
                        </div>
                    </td>
                </tr>
            );
        }


        // Earnings Row Component
        function EarningsRow({ earning }) {
            return (
                <tr className="border-b border-white/5 hover:bg-white/5">
                    <td className="py-3 px-4">
                        <div className="font-medium">{earning.userId?.name || 'Unknown'}</div>
                        <div className="text-gray-500 text-sm">{earning.userId?.email}</div>
                    </td>
                    <td className="py-3 px-4">
                        <span className={`px-2 py-1 rounded-full text-xs ${
                            earning.earnerType === 'coach' ? 'bg-green-500/20 text-green-400' :
                            earning.earnerType === 'influencer' ? 'bg-purple-500/20 text-purple-400' :
                            'bg-blue-500/20 text-blue-400'
                        }`}>
                            {earning.earnerType?.toUpperCase()}
                        </span>
                    </td>
                    <td className="py-3 px-4 font-mono text-orange-400">{earning.referralCode}</td>
                    <td className="py-3 px-4 text-green-400 font-bold">${earning.balance?.toFixed(2) || '0.00'}</td>
                    <td className="py-3 px-4">${earning.lifetime?.total?.toFixed(2) || '0.00'}</td>
                    <td className="py-3 px-4">{earning.referralStats?.totalReferrals || 0}</td>
                </tr>
            );
        }

        // Coach Application Row Component
        function CoachApplicationRow({ app, onApprove, onReject }) {
            const statusColors = {
                pending: 'bg-yellow-500/20 text-yellow-400',
                approved: 'bg-green-500/20 text-green-400',
                rejected: 'bg-red-500/20 text-red-400'
            };

            return (
                <tr className="border-b border-white/5 hover:bg-white/5">
                    <td className="py-3 px-4">
                        <div className="font-medium">{app.name}</div>
                        <div className="text-gray-500 text-sm">{app.email}</div>
                    </td>
                    <td className="py-3 px-4">{app.coachApplication?.applicationData?.specialty || 'N/A'}</td>
                    <td className="py-3 px-4 text-sm">{app.coachApplication?.applicationData?.experience || 'N/A'}</td>
                    <td className="py-3 px-4">
                        <span className={`px-2 py-1 rounded-full text-xs ${statusColors[app.coachApplication?.status] || ''}`}>
                            {app.coachApplication?.status?.toUpperCase()}
                        </span>
                    </td>
                    <td className="py-3 px-4 text-gray-400 text-sm">
                        {app.coachApplication?.appliedAt ? new Date(app.coachApplication.appliedAt).toLocaleDateString() : 'N/A'}
                    </td>
                    <td className="py-3 px-4">
                        {app.coachApplication?.status === 'pending' && (
                            <div className="flex gap-2">
                                <button onClick={() => onApprove(app._id)} className="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm">
                                    <i className="fas fa-check mr-1"></i>Approve
                                </button>
                                <button onClick={() => onReject(app._id)} className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">
                                    <i className="fas fa-times mr-1"></i>Reject
                                </button>
                            </div>
                        )}
                    </td>
                </tr>
            );
        }

        // Main Dashboard Component
        function AdminDashboard({ user, onLogout }) {
            const [stats, setStats] = useState(null);
            const [users, setUsers] = useState([]);
            const [vipUsers, setVipUsers] = useState([]);
            const [influencerApps, setInfluencerApps] = useState([]);
            const [earnings, setEarnings] = useState([]);
            const [earningsSummary, setEarningsSummary] = useState(null);
            const [coachApplications, setCoachApplications] = useState([]);
            const [coachIncome, setCoachIncome] = useState([]);
            const [pagination, setPagination] = useState({ page: 1, pages: 1, total: 0 });
            const [influencerPagination, setInfluencerPagination] = useState({ page: 1, pages: 1, total: 0 });
            const [earningsPagination, setEarningsPagination] = useState({ page: 1, pages: 1, total: 0 });
            const [coachPagination, setCoachPagination] = useState({ page: 1, pages: 1, total: 0 });
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('overview');
            const [search, setSearch] = useState('');
            const [filterType, setFilterType] = useState('');
            const [filterTier, setFilterTier] = useState('');
            const [earnerTypeFilter, setEarnerTypeFilter] = useState('');
            const [newVIPEmail, setNewVIPEmail] = useState('');
            const [message, setMessage] = useState(null);
            const [showCreateUserModal, setShowCreateUserModal] = useState(false);
            const [createUserForm, setCreateUserForm] = useState({ name: '', email: '', userType: 'member' });
            const [creatingUser, setCreatingUser] = useState(false);

            const loadStats = useCallback(async () => {
                try {
                    const res = await api.fetch('/admin/stats');
                    setStats(res.data);
                } catch (err) {
                    console.error('Failed to load stats:', err);
                }
            }, []);

            const loadUsers = useCallback(async (page = 1) => {
                try {
                    const params = new URLSearchParams({ page, limit: 20 });
                    if (search) params.append('search', search);
                    if (filterType) params.append('userType', filterType);
                    if (filterTier) params.append('tier', filterTier);

                    const res = await api.fetch(`/admin/users?${params}`);
                    setUsers(res.data.users);
                    setPagination(res.data.pagination);
                } catch (err) {
                    console.error('Failed to load users:', err);
                }
            }, [search, filterType, filterTier]);

            const loadVIPUsers = useCallback(async () => {
                try {
                    const res = await api.fetch('/admin/vip');
                    setVipUsers(res.data.vipUsers);
                } catch (err) {
                    console.error('Failed to load VIP users:', err);
                }
            }, []);

            const loadInfluencerApplications = useCallback(async (page = 1) => {
                try {
                    const params = new URLSearchParams({ page, limit: 10, status: 'pending' });
                    const res = await api.fetch(`/admin/influencer-applications?${params}`);
                    setInfluencerApps(res.data.applications);
                    setInfluencerPagination(res.data.pagination);
                } catch (err) {
                    console.error('Failed to load influencer applications:', err);
                }
            }, []);

            const loadEarnings = useCallback(async (page = 1) => {
                try {
                    const params = new URLSearchParams({ page, limit: 20 });
                    if (earnerTypeFilter) params.append('earnerType', earnerTypeFilter);
                    const res = await api.fetch(`/admin/earnings?${params}`);
                    setEarnings(res.earnings || []);
                    setEarningsPagination(res.pagination || { page: 1, pages: 1, total: 0 });
                } catch (err) {
                    console.error('Failed to load earnings:', err);
                }
            }, [earnerTypeFilter]);

            const loadEarningsSummary = useCallback(async () => {
                try {
                    const res = await api.fetch('/admin/earnings/summary');
                    setEarningsSummary(res.summary);
                } catch (err) {
                    console.error('Failed to load earnings summary:', err);
                }
            }, []);

            const loadCoachApplications = useCallback(async (page = 1) => {
                try {
                    const params = new URLSearchParams({ page, limit: 20, status: 'pending' });
                    const res = await api.fetch(`/admin/coach-applications?${params}`);
                    setCoachApplications(res.applications || []);
                    setCoachPagination(res.pagination || { page: 1, pages: 1, total: 0 });
                } catch (err) {
                    console.error('Failed to load coach applications:', err);
                }
            }, []);

            const loadCoachIncome = useCallback(async () => {
                try {
                    const res = await api.fetch('/admin/coaches/income');
                    setCoachIncome(res.coaches || []);
                } catch (err) {
                    console.error('Failed to load coach income:', err);
                }
            }, []);

            useEffect(() => {
                const init = async () => {
                    setLoading(true);
                    await Promise.all([
                        loadStats(),
                        loadUsers(),
                        loadVIPUsers(),
                        loadInfluencerApplications(),
                        loadEarnings(),
                        loadEarningsSummary(),
                        loadCoachApplications(),
                        loadCoachIncome()
                    ]);
                    setLoading(false);
                };
                init();
            }, []);

            useEffect(() => {
                if (!loading) {
                    loadUsers(1);
                }
            }, [search, filterType, filterTier]);

            const showMessage = (text, type = 'success') => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 3000);
            };

            const handleAddVIP = async (email) => {
                try {
                    await api.fetch('/admin/vip', {
                        method: 'POST',
                        body: JSON.stringify({ email })
                    });
                    showMessage(`${email} upgraded to VIP!`);
                    loadUsers(pagination.page);
                    loadVIPUsers();
                    loadStats();
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleRemoveVIP = async (email) => {
                if (!confirm(`Remove VIP status from ${email}?`)) return;
                try {
                    await api.fetch(`/admin/vip/${encodeURIComponent(email)}`, {
                        method: 'DELETE'
                    });
                    showMessage(`VIP status removed from ${email}`);
                    loadUsers(pagination.page);
                    loadVIPUsers();
                    loadStats();
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleAddNewVIP = async (e) => {
                e.preventDefault();
                if (!newVIPEmail) return;
                await handleAddVIP(newVIPEmail);
                setNewVIPEmail('');
            };

            const handleUpdateUserType = async (userId, newType) => {
                try {
                    await api.fetch(`/admin/users/${userId}/type`, {
                        method: 'PUT',
                        body: JSON.stringify({ userType: newType })
                    });
                    showMessage(`User type updated to ${newType}!`);
                    loadUsers(pagination.page);
                    loadStats();
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleUpdateTier = async (userId, newTier) => {
                try {
                    await api.fetch(`/admin/users/${userId}/tier`, {
                        method: 'PUT',
                        body: JSON.stringify({ tier: newTier })
                    });
                    showMessage(`User tier updated to ${newTier.replace('_', ' ').toUpperCase()}!`);
                    loadUsers(pagination.page);
                    loadStats();
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleApproveApp = async (id) => {
                if (!confirm('Are you sure you want to approve this influencer?')) return;
                try {
                    await api.fetch(`/admin/influencer-applications/${id}/approve`, { method: 'POST' });
                    showMessage('Influencer approved successfully!');
                    loadInfluencerApplications(); // Refresh list
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleDenyApp = async (id) => {
                if (!confirm('Are you sure you want to deny this influencer?')) return;
                try {
                    await api.fetch(`/admin/influencer-applications/${id}/deny`, { method: 'POST' });
                    showMessage('Influencer denied.');
                    loadInfluencerApplications(); // Refresh list
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleApproveCoach = async (userId) => {
                if (!confirm('Are you sure you want to approve this coach application?')) return;
                try {
                    await api.fetch(`/admin/coach-applications/${userId}/approve`, { method: 'POST' });
                    showMessage('Coach application approved!');
                    loadCoachApplications();
                    loadCoachIncome();
                    loadEarnings();
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleRejectCoach = async (userId) => {
                const reason = prompt('Enter rejection reason (optional):');
                try {
                    await api.fetch(`/admin/coach-applications/${userId}/reject`, {
                        method: 'POST',
                        body: JSON.stringify({ reason })
                    });
                    showMessage('Coach application rejected.');
                    loadCoachApplications();
                } catch (err) {
                    showMessage(err.message, 'error');
                }
            };

            const handleCreateUser = async (e) => {
                e.preventDefault();
                setCreatingUser(true);
                try {
                    const res = await api.fetch('/admin/users/create', {
                        method: 'POST',
                        body: JSON.stringify(createUserForm)
                    });
                    showMessage(`User created successfully! Temporary password emailed to ${createUserForm.email}`);
                    setShowCreateUserModal(false);
                    setCreateUserForm({ name: '', email: '', userType: 'member' });
                    loadUsers(); // Reload users list
                } catch (err) {
                    showMessage(err.message, 'error');
                } finally {
                    setCreatingUser(false);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-4xl mb-4"><i className="fas fa-spinner fa-spin text-orange-500"></i></div>
                            <div className="text-gray-400">Loading dashboard...</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="glass border-b border-white/10 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <i className="fas fa-bolt text-orange-500 text-2xl"></i>
                                <h1 className="text-xl font-bold">ClockWork Admin</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-gray-400 text-sm">{user.email}</span>
                                <button
                                    onClick={onLogout}
                                    className="text-gray-400 hover:text-white"
                                >
                                    <i className="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Message Toast */}
                    {message && (
                        <div className={`fixed top-20 right-4 z-50 px-4 py-3 rounded-lg ${message.type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white shadow-lg`}>
                            {message.text}
                        </div>
                    )}

                    {/* Navigation Tabs */}
                    <div className="max-w-7xl mx-auto px-4 py-4">
                        <div className="flex gap-2 overflow-x-auto scrollbar-hide">
                            {['overview', 'users', 'vip', 'earnings', 'coaches', 'influencers'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    className={`px-4 py-2 rounded-lg whitespace-nowrap transition-colors ${
                                        activeTab === tab
                                            ? 'bg-orange-500 text-white'
                                            : 'bg-white/5 text-gray-400 hover:bg-white/10'
                                    }`}
                                >
                                    {tab === 'overview' && <><i className="fas fa-chart-line mr-2"></i>Overview</>}
                                    {tab === 'users' && <><i className="fas fa-users mr-2"></i>Users</>}
                                    {tab === 'vip' && <><i className="fas fa-crown mr-2"></i>VIP Management</>}
                                    {tab === 'earnings' && <><i className="fas fa-dollar-sign mr-2"></i>Earnings</>}
                                    {tab === 'coaches' && <><i className="fas fa-chalkboard-teacher mr-2"></i>Coaches</>}
                                    {tab === 'influencers' && <><i className="fas fa-bullhorn mr-2"></i>Influencers</>}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 pb-8">
                        {/* Overview Tab */}
                        {activeTab === 'overview' && stats && (
                            <div className="space-y-6">
                                {/* Revenue Section */}
                                <div className="glass rounded-xl p-6 border-l-4 border-green-500">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                                        <i className="fas fa-dollar-sign text-green-500"></i>
                                        Revenue Overview
                                    </h2>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                        <div className="text-center">
                                            <div className="text-3xl md:text-4xl font-bold text-green-400">
                                                ${stats.revenue?.mrr?.toLocaleString() || ((stats.overview?.totalSubscribers || 0) * 29.99).toFixed(0)}
                                            </div>
                                            <div className="text-gray-400 text-sm mt-1">Monthly Revenue (MRR)</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl md:text-4xl font-bold text-blue-400">
                                                ${stats.revenue?.total?.toLocaleString() || ((stats.overview?.totalSubscribers || 0) * 29.99 * 3).toFixed(0)}
                                            </div>
                                            <div className="text-gray-400 text-sm mt-1">Total Revenue</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl md:text-4xl font-bold text-orange-400">
                                                ${stats.revenue?.coachRevenue?.toLocaleString() || '0'}
                                            </div>
                                            <div className="text-gray-400 text-sm mt-1">Coach Revenue</div>
                                            <div className="text-gray-500 text-xs">(20% platform fee)</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl md:text-4xl font-bold text-purple-400">
                                                ${stats.revenue?.avgPerUser?.toFixed(2) || ((stats.overview?.totalSubscribers || 0) > 0 ? (29.99).toFixed(2) : '0.00')}
                                            </div>
                                            <div className="text-gray-400 text-sm mt-1">Avg Revenue/User</div>
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-white/10 flex justify-between items-center text-sm">
                                        <span className="text-gray-400">
                                            <i className="fas fa-chart-line mr-1"></i>
                                            {stats.overview?.totalSubscribers || 0} paying subscribers
                                        </span>
                                        <span className="text-green-400">
                                            <i className="fas fa-arrow-up mr-1"></i>
                                            {stats.signups?.thisMonth || 0} new this month
                                        </span>
                                    </div>
                                </div>

                                {/* Key Metrics */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <StatCard icon="users" label="Total Users" value={stats.overview.totalUsers} color="blue" />
                                    <StatCard icon="credit-card" label="Subscribers" value={stats.overview.totalSubscribers} color="green" />
                                    <StatCard icon="crown" label="VIP Users" value={stats.overview.vipUsers} color="yellow" />
                                    <StatCard icon="dumbbell" label="Workouts" value={stats.overview.totalWorkouts} color="purple" />
                                </div>

                                {/* Signups */}
                                <div className="glass rounded-xl p-6">
                                    <h2 className="text-lg font-bold mb-4"><i className="fas fa-user-plus text-orange-500 mr-2"></i>New Signups</h2>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-green-400">{stats.signups.today}</div>
                                            <div className="text-gray-400 text-sm">Today</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-blue-400">{stats.signups.thisWeek}</div>
                                            <div className="text-gray-400 text-sm">This Week</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-purple-400">{stats.signups.thisMonth}</div>
                                            <div className="text-gray-400 text-sm">This Month</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Activity */}
                                <div className="glass rounded-xl p-6">
                                    <h2 className="text-lg font-bold mb-4"><i className="fas fa-fire text-orange-500 mr-2"></i>User Activity</h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-orange-400">{stats.activity.activeToday}</div>
                                            <div className="text-gray-400 text-sm">Active Today</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-3xl font-bold text-orange-300">{stats.activity.activeThisWeek}</div>
                                            <div className="text-gray-400 text-sm">Active This Week</div>
                                        </div>
                                    </div>
                                </div>

                                {/* User Types & Tiers */}
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="glass rounded-xl p-6">
                                        <h2 className="text-lg font-bold mb-4"><i className="fas fa-user-tag text-blue-500 mr-2"></i>Users by Type</h2>
                                        <div className="space-y-2">
                                            {Object.entries(stats.usersByType).map(([type, count]) => (
                                                <div key={type} className="flex justify-between items-center">
                                                    <span className="capitalize text-gray-300">{type}</span>
                                                    <span className="font-bold">{count}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="glass rounded-xl p-6">
                                        <h2 className="text-lg font-bold mb-4"><i className="fas fa-layer-group text-green-500 mr-2"></i>Users by Tier</h2>
                                        <div className="space-y-2">
                                            {Object.entries(stats.usersByTier).map(([tier, count]) => (
                                                <div key={tier} className="flex justify-between items-center">
                                                    <span className="capitalize text-gray-300">{tier?.replace('_', ' ') || 'Unknown'}</span>
                                                    <span className="font-bold">{count}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Subscribers Breakdown */}
                                {Object.keys(stats.subscribers).length > 0 && (
                                    <div className="glass rounded-xl p-6">
                                        <h2 className="text-lg font-bold mb-4"><i className="fas fa-credit-card text-green-500 mr-2"></i>Paid Subscribers</h2>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            {Object.entries(stats.subscribers).map(([tier, count]) => (
                                                <div key={tier} className="text-center p-3 bg-white/5 rounded-lg">
                                                    <div className="text-2xl font-bold text-green-400">{count}</div>
                                                    <div className="text-gray-400 text-sm capitalize">{tier.replace('_', ' ')}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Users Tab */}
                        {activeTab === 'users' && (
                            <div className="space-y-4">
                                {/* Filters and Create Button */}
                                <div className="glass rounded-xl p-4">
                                    <div className="flex flex-wrap gap-4 items-center justify-between mb-4">
                                        <h3 className="text-lg font-bold">User Management</h3>
                                        <button
                                            onClick={() => setShowCreateUserModal(true)}
                                            className="bg-gradient-to-r from-orange-500 to-pink-500 hover:opacity-90 text-white px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2"
                                        >
                                            <i className="fas fa-user-plus"></i>
                                            Create User
                                        </button>
                                    </div>
                                    <div className="flex flex-wrap gap-4">
                                        <div className="flex-1 min-w-[200px]">
                                            <input
                                                type="text"
                                                value={search}
                                                onChange={(e) => setSearch(e.target.value)}
                                                placeholder="Search by email or name..."
                                                className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                            />
                                        </div>
                                        <select
                                            value={filterType}
                                            onChange={(e) => setFilterType(e.target.value)}
                                            className="bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                        >
                                            <option value="">All Types</option>
                                            <option value="individual">Individual</option>
                                            <option value="coach">Coach</option>
                                            <option value="client">Client</option>
                                        </select>
                                        <select
                                            value={filterTier}
                                            onChange={(e) => setFilterTier(e.target.value)}
                                            className="bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                        >
                                            <option value="">All Tiers</option>
                                            <option value="free">Free</option>
                                            <option value="pro">Pro</option>
                                            <option value="vip">VIP</option>
                                            <option value="elite">Elite</option>
                                            <option value="coach_starter">Coach Starter</option>
                                            <option value="coach_pro">Coach Pro</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Users Table */}
                                <div className="glass rounded-xl overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-white/5">
                                                <tr className="text-left text-gray-400 text-sm">
                                                    <th className="py-3 px-4">User</th>
                                                    <th className="py-3 px-4">Type</th>
                                                    <th className="py-3 px-4">Tier</th>
                                                    <th className="py-3 px-4">Joined</th>
                                                    <th className="py-3 px-4">Last Active</th>
                                                    <th className="py-3 px-4">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {users.map(u => (
                                                    <UserRow
                                                        key={u._id}
                                                        user={u}
                                                        onAddVIP={handleAddVIP}
                                                        onRemoveVIP={handleRemoveVIP}
                                                        onUpdateType={handleUpdateUserType}
                                                        onUpdateTier={handleUpdateTier}
                                                    />
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Pagination */}
                                    <div className="border-t border-white/10 px-4 py-3 flex items-center justify-between text-sm">
                                        <div className="text-gray-400">
                                            Showing {users.length} of {pagination.total} users
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => loadUsers(pagination.page - 1)}
                                                disabled={pagination.page <= 1}
                                                className="px-3 py-1 bg-white/5 rounded disabled:opacity-50"
                                            >
                                                Previous
                                            </button>
                                            <span className="px-3 py-1">
                                                Page {pagination.page} of {pagination.pages}
                                            </span>
                                            <button
                                                onClick={() => loadUsers(pagination.page + 1)}
                                                disabled={pagination.page >= pagination.pages}
                                                className="px-3 py-1 bg-white/5 rounded disabled:opacity-50"
                                            >
                                                Next
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIP Management Tab */}
                        {activeTab === 'vip' && (
                            <div className="space-y-6">
                                {/* Add VIP Form */}
                                <div className="glass rounded-xl p-6">
                                    <h2 className="text-lg font-bold mb-4"><i className="fas fa-crown text-yellow-500 mr-2"></i>Add VIP User</h2>
                                    <form onSubmit={handleAddNewVIP} className="flex gap-4">
                                        <input
                                            type="email"
                                            value={newVIPEmail}
                                            onChange={(e) => setNewVIPEmail(e.target.value)}
                                            placeholder="Enter user email..."
                                            className="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                            required
                                        />
                                        <button
                                            type="submit"
                                            className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-6 py-2 rounded-lg transition-colors"
                                        >
                                            <i className="fas fa-crown mr-2"></i>Add VIP
                                        </button>
                                    </form>
                                    <p className="text-gray-500 text-sm mt-2">
                                        User must already have an account. For permanent VIP, add email to VIP_EMAILS env var.
                                    </p>
                                </div>

                                {/* Current VIP Users */}
                                <div className="glass rounded-xl p-6">
                                    <h2 className="text-lg font-bold mb-4">
                                        <i className="fas fa-users text-yellow-500 mr-2"></i>
                                        Current VIP Users ({vipUsers.length})
                                    </h2>
                                    {vipUsers.length === 0 ? (
                                        <p className="text-gray-400 text-center py-8">No VIP users yet</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {vipUsers.map(vip => (
                                                <div key={vip._id} className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                                    <div>
                                                        <div className="font-medium">{vip.name}</div>
                                                        <div className="text-gray-500 text-sm">{vip.email}</div>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        {vip.isEnvVIP && (
                                                            <span className="text-yellow-500 text-sm">
                                                                <i className="fas fa-star mr-1"></i>ENV VIP
                                                            </span>
                                                        )}
                                                        <span className="text-gray-500 text-sm">
                                                            Joined: {new Date(vip.createdAt).toLocaleDateString()}
                                                        </span>
                                                        <button
                                                            onClick={() => handleRemoveVIP(vip.email)}
                                                            disabled={vip.isEnvVIP}
                                                            className={`text-red-400 hover:text-red-300 ${vip.isEnvVIP ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                            title={vip.isEnvVIP ? 'Remove from VIP_EMAILS env var to revoke' : 'Remove VIP'}
                                                        >
                                                            <i className="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Earnings Tab */}
                        {activeTab === 'earnings' && (
                            <div className="space-y-6">
                                {/* Earnings Summary */}
                                {earningsSummary && (
                                    <div className="glass rounded-xl p-6 border-l-4 border-green-500">
                                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                                            <i className="fas fa-chart-pie text-green-500"></i>
                                            PATF Earnings Overview
                                        </h2>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                            <div className="text-center">
                                                <div className="text-3xl font-bold text-green-400">
                                                    {earningsSummary.platform?.totalEarners || 0}
                                                </div>
                                                <div className="text-gray-400 text-sm mt-1">Total Earners</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-3xl font-bold text-blue-400">
                                                    ${earningsSummary.platform?.totalBalance?.toFixed(2) || '0.00'}
                                                </div>
                                                <div className="text-gray-400 text-sm mt-1">Pending Payouts</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-3xl font-bold text-purple-400">
                                                    ${earningsSummary.platform?.totalLifetime?.toFixed(2) || '0.00'}
                                                </div>
                                                <div className="text-gray-400 text-sm mt-1">Lifetime Paid</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-3xl font-bold text-orange-400">
                                                    {earningsSummary.platform?.totalReferrals || 0}
                                                </div>
                                                <div className="text-gray-400 text-sm mt-1">Total Referrals</div>
                                            </div>
                                        </div>

                                        {/* By Type */}
                                        <div className="mt-6 pt-4 border-t border-white/10">
                                            <h3 className="text-sm font-bold text-gray-400 mb-3">BY EARNER TYPE</h3>
                                            <div className="grid grid-cols-3 gap-4">
                                                {['coach', 'influencer', 'affiliate'].map(type => (
                                                    <div key={type} className="bg-white/5 rounded-lg p-3 text-center">
                                                        <div className="text-xl font-bold">{earningsSummary.byType?.[type]?.count || 0}</div>
                                                        <div className="text-gray-500 text-xs capitalize">{type}s</div>
                                                        <div className="text-green-400 text-sm mt-1">
                                                            ${earningsSummary.byType?.[type]?.totalLifetime?.toFixed(2) || '0.00'}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Filters */}
                                <div className="glass rounded-xl p-4">
                                    <div className="flex gap-4">
                                        <select
                                            value={earnerTypeFilter}
                                            onChange={(e) => { setEarnerTypeFilter(e.target.value); loadEarnings(1); }}
                                            className="bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                        >
                                            <option value="">All Earner Types</option>
                                            <option value="coach">Coaches</option>
                                            <option value="influencer">Influencers</option>
                                            <option value="affiliate">Affiliates</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Earnings Table */}
                                <div className="glass rounded-xl overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-white/5">
                                                <tr className="text-left text-gray-400 text-sm">
                                                    <th className="py-3 px-4">User</th>
                                                    <th className="py-3 px-4">Type</th>
                                                    <th className="py-3 px-4">Referral Code</th>
                                                    <th className="py-3 px-4">Balance</th>
                                                    <th className="py-3 px-4">Lifetime</th>
                                                    <th className="py-3 px-4">Referrals</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {earnings.map(e => (
                                                    <EarningsRow key={e._id} earning={e} />
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    {earnings.length === 0 && <p className="text-gray-400 text-center py-8">No earnings records found.</p>}
                                    {/* Pagination */}
                                    <div className="border-t border-white/10 px-4 py-3 flex items-center justify-between text-sm">
                                        <div className="text-gray-400">
                                            Showing {earnings.length} of {earningsPagination.total} earners
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => loadEarnings(earningsPagination.page - 1)}
                                                disabled={earningsPagination.page <= 1}
                                                className="px-3 py-1 bg-white/5 rounded disabled:opacity-50"
                                            >
                                                Previous
                                            </button>
                                            <span className="px-3 py-1">
                                                Page {earningsPagination.page} of {earningsPagination.pages}
                                            </span>
                                            <button
                                                onClick={() => loadEarnings(earningsPagination.page + 1)}
                                                disabled={earningsPagination.page >= earningsPagination.pages}
                                                className="px-3 py-1 bg-white/5 rounded disabled:opacity-50"
                                            >
                                                Next
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Top Earners */}
                                {earningsSummary?.topEarners?.length > 0 && (
                                    <div className="glass rounded-xl p-6">
                                        <h2 className="text-lg font-bold mb-4"><i className="fas fa-trophy text-yellow-500 mr-2"></i>Top Earners</h2>
                                        <div className="space-y-3">
                                            {earningsSummary.topEarners.slice(0, 5).map((earner, i) => (
                                                <div key={earner.userId} className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                                    <div className="flex items-center gap-3">
                                                        <span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold ${
                                                            i === 0 ? 'bg-yellow-500 text-black' :
                                                            i === 1 ? 'bg-gray-400 text-black' :
                                                            i === 2 ? 'bg-orange-700 text-white' :
                                                            'bg-white/10 text-gray-400'
                                                        }`}>{i + 1}</span>
                                                        <div>
                                                            <div className="font-medium">{earner.name}</div>
                                                            <div className="text-gray-500 text-sm">{earner.earnerType}</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-green-400">${earner.lifetime?.toFixed(2) || '0.00'}</div>
                                                        <div className="text-gray-500 text-sm">lifetime</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Coaches Tab */}
                        {activeTab === 'coaches' && (
                            <div className="space-y-6">
                                {/* Pending Applications */}
                                <div className="glass rounded-xl p-6">
                                    <h2 className="text-lg font-bold mb-4">
                                        <i className="fas fa-clipboard-list text-orange-500 mr-2"></i>
                                        Pending Coach Applications ({coachApplications.length})
                                    </h2>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-white/5">
                                                <tr className="text-left text-gray-400 text-sm">
                                                    <th className="py-3 px-4">Applicant</th>
                                                    <th className="py-3 px-4">Specialty</th>
                                                    <th className="py-3 px-4">Experience</th>
                                                    <th className="py-3 px-4">Status</th>
                                                    <th className="py-3 px-4">Applied</th>
                                                    <th className="py-3 px-4">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {coachApplications.map(app => (
                                                    <CoachApplicationRow
                                                        key={app._id}
                                                        app={app}
                                                        onApprove={handleApproveCoach}
                                                        onReject={handleRejectCoach}
                                                    />
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    {coachApplications.length === 0 && (
                                        <p className="text-gray-400 text-center py-8">No pending coach applications.</p>
                                    )}
                                </div>

                                {/* Coach Income Overview */}
                                <div className="glass rounded-xl p-6">
                                    <h2 className="text-lg font-bold mb-4">
                                        <i className="fas fa-money-bill-wave text-green-500 mr-2"></i>
                                        Active Coaches & Income ({coachIncome.length})
                                    </h2>
                                    {coachIncome.length === 0 ? (
                                        <p className="text-gray-400 text-center py-8">No active coaches yet.</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {coachIncome.map(coach => (
                                                <div key={coach._id} className="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center">
                                                            <i className="fas fa-chalkboard-teacher text-green-400"></i>
                                                        </div>
                                                        <div>
                                                            <div className="font-medium">{coach.name}</div>
                                                            <div className="text-gray-500 text-sm">{coach.email}</div>
                                                            <div className="text-gray-600 text-xs">
                                                                {coach.coachApplication?.applicationData?.specialty || 'General Fitness'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-green-400 font-bold">
                                                            ${coach.earnings?.balance?.toFixed(2) || '0.00'}
                                                        </div>
                                                        <div className="text-gray-500 text-sm">balance</div>
                                                        <div className="text-gray-600 text-xs">
                                                            ${coach.earnings?.lifetime?.fromCoaching?.toFixed(2) || '0.00'} coaching /
                                                            ${coach.earnings?.lifetime?.fromReferrals?.toFixed(2) || '0.00'} referrals
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Influencers Tab */}
                        {activeTab === 'influencers' && (
                            <div className="space-y-4">
                                <div className="glass rounded-xl p-6">
                                     <h2 className="text-lg font-bold mb-4"><i className="fas fa-bullhorn text-orange-500 mr-2"></i>Pending Influencer Applications</h2>
                                     <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-white/5">
                                                <tr className="text-left text-gray-400 text-sm">
                                                    <th className="py-3 px-4">Applicant</th>
                                                    <th className="py-3 px-4">Platform</th>
                                                    <th className="py-3 px-4">Followers</th>
                                                    <th className="py-3 px-4">Eng. Rate</th>
                                                    <th className="py-3 px-4">Links</th>
                                                    <th className="py-3 px-4">Date</th>
                                                    <th className="py-3 px-4">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {influencerApps.map(app => (
                                                    <InfluencerApplicationRow
                                                        key={app._id}
                                                        app={app}
                                                        onApprove={handleApproveApp}
                                                        onDeny={handleDenyApp}
                                                    />
                                                ))}
                                            </tbody>
                                        </table>
                                     </div>
                                     {influencerApps.length === 0 && <p className="text-gray-400 text-center py-8">No pending applications.</p>}
                                     {/* Pagination */}
                                    <div className="border-t border-white/10 px-4 py-3 flex items-center justify-between text-sm">
                                        <div className="text-gray-400">
                                            Showing {influencerApps.length} of {influencerPagination.total} applications
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => loadInfluencerApplications(influencerPagination.page - 1)}
                                                disabled={influencerPagination.page <= 1}
                                                className="px-3 py-1 bg-white/5 rounded disabled:opacity-50"
                                            >
                                                Previous
                                            </button>
                                            <span className="px-3 py-1">
                                                Page {influencerPagination.page} of {influencerPagination.pages}
                                            </span>
                                            <button
                                                onClick={() => loadInfluencerApplications(influencerPagination.page + 1)}
                                                disabled={influencerPagination.page >= influencerPagination.pages}
                                                className="px-3 py-1 bg-white/5 rounded disabled:opacity-50"
                                            >
                                                Next
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Create User Modal */}
                    {showCreateUserModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setShowCreateUserModal(false)}>
                            <div className="glass rounded-xl p-6 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Create New User</h3>
                                    <button onClick={() => setShowCreateUserModal(false)} className="text-gray-400 hover:text-white">
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>

                                <form onSubmit={handleCreateUser} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Full Name</label>
                                        <input
                                            type="text"
                                            value={createUserForm.name}
                                            onChange={(e) => setCreateUserForm({...createUserForm, name: e.target.value})}
                                            required
                                            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                            placeholder="John Doe"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-2">Email Address</label>
                                        <input
                                            type="email"
                                            value={createUserForm.email}
                                            onChange={(e) => setCreateUserForm({...createUserForm, email: e.target.value})}
                                            required
                                            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                            placeholder="john@example.com"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-2">User Tier</label>
                                        <select
                                            value={createUserForm.userType}
                                            onChange={(e) => setCreateUserForm({...createUserForm, userType: e.target.value})}
                                            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                        >
                                            <option value="member">Member (Free - Browse Only)</option>
                                            <option value="individual">Individual (Paid - AI Coach Access)</option>
                                            <option value="coach">Coach (Creator + Coaching)</option>
                                            <option value="influencer">Influencer (Creator + Referrals)</option>
                                            <option value="client">Client (Assigned to Coach)</option>
                                        </select>
                                    </div>

                                    <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
                                        <p className="text-blue-300 text-sm flex items-start gap-2">
                                            <i className="fas fa-info-circle mt-0.5"></i>
                                            <span>A temporary password will be generated and emailed to the user. They must reset it on first login.</span>
                                        </p>
                                    </div>

                                    <div className="flex gap-3 pt-2">
                                        <button
                                            type="button"
                                            onClick={() => setShowCreateUserModal(false)}
                                            className="flex-1 bg-white/5 hover:bg-white/10 text-white font-semibold py-2 rounded-lg transition-colors"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            disabled={creatingUser}
                                            className="flex-1 bg-gradient-to-r from-orange-500 to-pink-500 hover:opacity-90 text-white font-semibold py-2 rounded-lg transition-all disabled:opacity-50"
                                        >
                                            {creatingUser ? (
                                                <><i className="fas fa-spinner fa-spin mr-2"></i>Creating...</>
                                            ) : (
                                                <><i className="fas fa-user-plus mr-2"></i>Create User</>
                                            )}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // App Component
        function App() {
            const [user, setUser] = useState(null);
            const [checking, setChecking] = useState(true);

            useEffect(() => {
                const checkAuth = async () => {
                    const token = localStorage.getItem('adminToken');
                    if (token) {
                        try {
                            // Verify token and admin access
                            await api.fetch('/admin/stats');
                            // Get user info
                            const res = await api.fetch('/users/profile');
                            setUser(res.user || res);
                        } catch (err) {
                            localStorage.removeItem('adminToken');
                        }
                    }
                    setChecking(false);
                };
                checkAuth();
            }, []);

            const handleLogout = () => {
                localStorage.removeItem('adminToken');
                setUser(null);
            };

            if (checking) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-4xl"><i className="fas fa-spinner fa-spin text-orange-500"></i></div>
                    </div>
                );
            }

            if (!user) {
                return <LoginForm onLogin={setUser} />;
            }

            return <AdminDashboard user={user} onLogout={handleLogout} />;
        }

        // Render App
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
