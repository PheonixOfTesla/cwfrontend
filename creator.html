
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Profile | ClockWork</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0a0a0f', 800: '#12121a', 700: '#1a1a24', 600: '#22222e' },
                        accent: { orange: '#ff6b35', pink: '#ff2d7a', purple: '#a855f7' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #0a0a0f 0%, #12121a 50%, #0a0a0f 100%); min-height: 100vh; }
        .glass { background: rgba(26, 26, 36, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card { background: rgba(34, 34, 46, 0.5); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.06); }
        .gradient-text { background: linear-gradient(135deg, #ff6b35, #ff2d7a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .post-card.locked img, .post-card.text-post.locked .post-text { filter: blur(8px); }
        .post-card.locked .lock-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); border-radius: inherit; }
        .post-card.locked .lock-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #ff6b35, #ff2d7a); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        #authModalV2 { transition: opacity 0.3s ease; }
        #authModalV2 .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="text-white">
    <!-- Main Content (visible by default) -->
    <div id="pageContent">
        <!-- Loading, Error, and Main Content sections go here -->
    </div>

    <!-- NEW SELF-CONTAINED AUTH MODAL -->
    <div id="authModalV2" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/80 backdrop-blur-sm" onclick="AuthModal.close()">
        <div class="modal-content w-full max-w-md scale-95 transform" onclick="event.stopPropagation()">
            <div class="relative bg-[#12121a] rounded-2xl border border-white/10 shadow-2xl">
                <button onclick="AuthModal.close()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors z-10">
                    <i class="fas fa-times text-white"></i>
                </button>
                <div id="authModalV2_Header" class="p-6 text-center"></div>
                <div class="flex border-b border-white/10 mx-6">
                    <button id="authModalV2_loginTab" onclick="AuthModal.switchMode('login')" class="flex-1 py-3 text-center font-semibold transition-colors border-b-2">Log In</button>
                    <button id="authModalV2_signupTab" onclick="AuthModal.switchMode('signup')" class="flex-1 py-3 text-center font-semibold transition-colors border-b-2">Sign Up</button>
                </div>
                <div class="p-6">
                    <div id="authModalV2_Error" class="hidden mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-400 text-sm"></div>
                    <form id="authModalV2_loginForm" class="space-y-4"></form>
                    <form id="authModalV2_signupForm" class="space-y-4 hidden"></form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:5000' : '';
            let currentCreator = null;

            // --- NEW SELF-CONTAINED AUTH MODAL LOGIC ---
            const AuthModal = {
                isOpen: false,
                onSuccessCallback: null,

                init() {
                    this.loginForm = document.getElementById('authModalV2_loginForm');
                    this.signupForm = document.getElementById('authModalV2_signupForm');
                    this.errorEl = document.getElementById('authModalV2_Error');
                    this.loginForm.innerHTML = `
                        <div>
                            <input type="email" name="email" required placeholder="Email" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-orange-500">
                        </div>
                        <div>
                            <input type="password" name="password" required placeholder="Password" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-orange-500">
                        </div>
                        <button type="submit" class="w-full py-3 bg-gradient-to-r from-orange-500 to-pink-500 rounded-xl font-bold text-white hover:opacity-90">Log In</button>`;
                    this.signupForm.innerHTML = `
                        <div>
                            <input type="text" name="name" required placeholder="Your Name" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-orange-500">
                        </div>
                        <div>
                            <input type="email" name="email" required placeholder="Email" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-orange-500">
                        </div>
                        <div>
                            <input type="password" name="password" required placeholder="Create Password" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-orange-500">
                        </div>
                        <button type="submit" class="w-full py-3 bg-gradient-to-r from-orange-500 to-pink-500 rounded-xl font-bold text-white hover:opacity-90">Create Account</button>`;
                    
                    this.loginForm.addEventListener('submit', this.handleLogin.bind(this));
                    this.signupForm.addEventListener('submit', this.handleSignup.bind(this));
                },

                open(onSuccess) {
                    this.onSuccessCallback = onSuccess;
                    const modal = document.getElementById('authModalV2');
                    const header = document.getElementById('authModalV2_Header');
                    header.innerHTML = `<h2 class="text-xl font-bold">Log In or Sign Up</h2><p class="text-gray-400 text-sm">to subscribe to ${currentCreator.name}</p>`;
                    
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        modal.querySelector('.modal-content').classList.remove('scale-95');
                    }, 10);
                    this.isOpen = true;
                    this.switchMode('login');
                },

                close() {
                    const modal = document.getElementById('authModalV2');
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }, 300);
                    this.isOpen = false;
                },

                switchMode(mode) {
                    this.errorEl.classList.add('hidden');
                    const loginTab = document.getElementById('authModalV2_loginTab');
                    const signupTab = document.getElementById('authModalV2_signupTab');
                    if (mode === 'login') {
                        this.loginForm.classList.remove('hidden');
                        this.signupForm.classList.add('hidden');
                        loginTab.classList.add('text-white', 'border-orange-500');
                        signupTab.classList.remove('text-white', 'border-orange-500');
                        signupTab.classList.add('text-gray-500');
                    } else {
                        this.signupForm.classList.remove('hidden');
                        this.loginForm.classList.add('hidden');
                        signupTab.classList.add('text-white', 'border-orange-500');
                        loginTab.classList.remove('text-white', 'border-orange-500');
                        loginTab.classList.add('text-gray-500');
                    }
                },

                showError(message) {
                    this.errorEl.textContent = message;
                    this.errorEl.classList.remove('hidden');
                },

                async handleLogin(e) {
                    e.preventDefault();
                    this.showError('');
                    const email = this.loginForm.email.value;
                    const password = this.loginForm.password.value;
                    try {
                        const res = await fetch(`${API_BASE}/api/auth/login`, {
                            method: 'POST', body: JSON.stringify({ email, password }),
                            headers: { 'Content-Type': 'application/json' }, credentials: 'include'
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.message);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        if(this.onSuccessCallback) this.onSuccessCallback();
                    } catch (err) { this.showError(err.message); }
                },

                async handleSignup(e) {
                    e.preventDefault();
                    this.showError('');
                    const name = this.signupForm.name.value;
                    const email = this.signupForm.email.value;
                    const password = this.signupForm.password.value;
                    try {
                         const res = await fetch(`${API_BASE}/api/auth/register`, {
                            method: 'POST', body: JSON.stringify({ name, email, password, userType: 'individual' }),
                            headers: { 'Content-Type': 'application/json' }, credentials: 'include'
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.message);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        if(this.onSuccessCallback) this.onSuccessCallback();
                    } catch (err) { this.showError(err.message); }
                },

                isLoggedIn: () => !!localStorage.getItem('user'),
                getToken: () => null, // Using httpOnly cookies
            };

            const PageManager = {
                init() {
                    this.pageContent = document.getElementById('pageContent');
                    AuthModal.init();
                    this.loadCreatorProfile();
                },

                async loadCreatorProfile() {
                    const handle = getHandle();
                    if (!handle) { this.renderError(); return; }

                    this.pageContent.innerHTML = `<div class="text-center py-20"><div class="w-16 h-16 border-4 border-accent-orange/30 border-t-accent-orange rounded-full animate-spin mx-auto"></div></div>`;

                    try {
                        const res = await fetch(`${API_BASE}/api/coach/${handle}/public`);
                        if (!res.ok) throw new Error('Creator not found');
                        const data = await res.json();
                        currentCreator = data.coach;
                        this.renderPage(data.coach, data.posts);

                        if(AuthModal.isLoggedIn()) {
                            const subRes = await fetch(`${API_BASE}/api/subscriptions/status?creatorId=${currentCreator._id}`, { headers: { 'Authorization': `Bearer ${AuthModal.getToken()}` }, credentials: 'include' });
                            const subData = await subRes.json();
                            this.renderPage(data.coach, data.posts, subData.data);
                        }

                    } catch (err) { this.renderError(); }
                },
                
                renderPage(profile, posts, subscription = null) {
                    const isSubscribed = subscription && subscription.status === 'active';
                    const priceFormatted = `$${((profile.pricing?.subscriptionPrice || 999) / 100).toFixed(2)}`;
                    this.pageContent.innerHTML = `
                        <div class="relative h-48 sm:h-64"><img src="${profile.coverImage || DEFAULT_COVER_IMAGE}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-dark-900"></div></div>
                        <div class="max-w-lg mx-auto px-4 -mt-16 relative z-10">
                            <div class="flex justify-center mb-4"><img src="${profile.profilePicture || (DEFAULT_AVATAR_API + encodeURIComponent(profile.name))}" class="w-32 h-32 rounded-full object-cover border-4 border-dark-800"></div>
                            <div class="text-center mb-6">
                                <h1 class="text-3xl font-bold">${profile.name}</h1>
                                <p class="text-gray-400">@${profile.coachProfile.handle}</p>
                            </div>
                            <div id="subscribeBtnContainer" class="${isSubscribed ? 'hidden' : ''} mb-6">
                                <button id="subscribeBtn" class="w-full py-4 bg-gradient-to-r from-orange-500 to-pink-500 rounded-xl font-bold text-lg hover:opacity-90">Subscribe for ${priceFormatted}/mo</button>
                            </div>
                            <div id="postsContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-2">${this.renderPostsHTML(posts, isSubscribed)}</div>
                        </div>`;
                    
                    if (!isSubscribed) {
                        document.getElementById('subscribeBtn').addEventListener('click', this.handleSubscribeClick.bind(this));
                    }
                },
                
                renderPostsHTML(posts, isSubscribed) {
                    if (!posts || posts.length === 0) return '<p class="col-span-full text-center text-gray-500 py-8">No posts yet.</p>';
                    return posts.map(post => {
                        const shouldBeLocked = post.access === 'subscribers' && !isSubscribed;
                        if (post.thumbnail || post.mediaUrl) { // Media post
                            return `<div class="post-card ${shouldBeLocked ? 'locked' : ''} aspect-square rounded-xl bg-dark-800 overflow-hidden"><img src="${post.thumbnail || post.mediaUrl}" class="w-full h-full object-cover">${shouldBeLocked ? this.renderLockOverlay() : ''}</div>`;
                        } else if (post.content) { // Text post
                            return `<div class="post-card text-post ${shouldBeLocked ? 'locked' : ''} aspect-square rounded-xl bg-dark-800 p-4 flex items-center justify-center"><p class="post-text text-gray-300 text-sm line-clamp-6">${post.content}</p>${shouldBeLocked ? this.renderLockOverlay() : ''}</div>`;
                        }
                        return '';
                    }).join('');
                },

                renderLockOverlay: () => `<div class="lock-overlay"><div class="lock-icon"><i class="fas fa-lock text-white"></i></div><span class="lock-text">Subscribe</span></div>`,
                
                renderError() {
                    this.pageContent.innerHTML = `<div class="text-center py-20"><h2 class="text-2xl font-bold">Creator Not Found</h2></div>`;
                },

                handleSubscribeClick() {
                    if (AuthModal.isLoggedIn()) {
                        this.createCheckoutSession();
                    } else {
                        AuthModal.open(() => this.createCheckoutSession());
                    }
                },

                async createCheckoutSession() {
                    const btn = document.getElementById('subscribeBtn');
                    if (!currentCreator || (btn && btn.disabled)) return;
                    
                    if(btn) {
                        btn.disabled = true;
                        btn.innerHTML = 'Creating secure checkout...';
                    }

                    try {
                        const res = await fetch(`${API_BASE}/api/subscriptions/create-checkout`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${AuthModal.getToken()}` },
                            credentials: 'include',
                            body: JSON.stringify({ priceKey: 'pro_monthly', creatorId: currentCreator._id, successUrl: window.location.href, cancelUrl: window.location.href })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.message);
                        window.location.href = data.data.url;
                    } catch (err) {
                        alert('Error creating checkout: ' + err.message);
                        if(btn) {
                            btn.disabled = false;
                            btn.innerHTML = `Subscribe for ${priceFormatted}/mo`;
                        }
                    }
                }
            };

            PageManager.init();
        });
    </script>
</body>
</html>
