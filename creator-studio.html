
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Creator Studio - ClockWork">
    <meta name="theme-color" content="#f97316">
    <title>Creator Studio - ClockWork</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clockwork: { orange: '#f97316', pink: '#ec4899', dark: '#0a0a0a', darker: '#050505' }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .glow { box-shadow: 0 0 30px rgba(249, 115, 22, 0.3); }
        .glow-pink { box-shadow: 0 0 30px rgba(236, 72, 153, 0.3); }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); }
        .gradient-text { background: linear-gradient(135deg, #f97316, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .gradient-border { border-image: linear-gradient(135deg, #f97316, #ec4899) 1; }
        .gradient-bg { background: linear-gradient(135deg, #f97316, #ec4899); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
        @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 20px rgba(249, 115, 22, 0.3); } 50% { box-shadow: 0 0 40px rgba(249, 115, 22, 0.6); } }
        .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .confetti-piece { position: absolute; width: 10px; height: 10px; animation: confettiFall 3s ease-out forwards; }
        @keyframes confettiFall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .earnings-popup { animation: slideInRight 0.5s ease-out, fadeOut 0.5s ease-out 2.5s forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .tier-progress { background: linear-gradient(90deg, #f97316, #ec4899); background-size: 200% 100%; animation: shimmer 2s linear infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .streak-fire { animation: firePulse 0.5s ease-in-out infinite alternate; }
        @keyframes firePulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        .drag-over { border: 2px dashed #f97316 !important; background: rgba(249, 115, 22, 0.1) !important; }
    </style>
</head>
<body class="text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // API Configuration
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:5000/api'
            : '/api';

        // API Helper
        const api = {
            async fetch(endpoint, options = {}) {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Request failed');
                return data;
            }
        };

        // Audio Manager for chimes
        const AudioManager = {
            earningsChime: null,
            milestoneChime: null,
            init() {
                // Create audio context on user interaction
                if (!this.earningsChime) {
                    this.earningsChime = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleUw9kd3hsFMAADqP4');
                    this.milestoneChime = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleUw9kd3hsFMAADqP4');
                }
            },
            playEarnings() {
                this.init();
                try { this.earningsChime.currentTime = 0; this.earningsChime.play().catch(() => {}); } catch(e) {}
            },
            playMilestone() {
                this.init();
                try { this.milestoneChime.currentTime = 0; this.milestoneChime.play().catch(() => {}); } catch(e) {}
            }
        };

        // Confetti Component
        function Confetti({ active }) {
            if (!active) return null;
            const colors = ['#f97316', '#ec4899', '#fbbf24', '#22c55e', '#3b82f6', '#8b5cf6'];
            const pieces = Array.from({ length: 50 }, (_, i) => ({
                id: i,
                left: Math.random() * 100,
                color: colors[Math.floor(Math.random() * colors.length)],
                delay: Math.random() * 0.5,
                size: Math.random() * 8 + 5
            }));
            return (
                <div className="confetti">
                    {pieces.map(p => (
                        <div
                            key={p.id}
                            className="confetti-piece"
                            style={{
                                left: `${p.left}%`,
                                backgroundColor: p.color,
                                width: p.size,
                                height: p.size,
                                animationDelay: `${p.delay}s`,
                                borderRadius: Math.random() > 0.5 ? '50%' : '0'
                            }}
                        />
                    ))}
                </div>
            );
        }

        // Earnings Notification Popup
        function EarningsPopup({ earnings, onDismiss }) {
            useEffect(() => {
                const timer = setTimeout(onDismiss, 3000);
                return () => clearTimeout(timer);
            }, [onDismiss]);

            return (
                <div className="earnings-popup fixed top-20 right-4 z-50 glass rounded-xl p-4 border border-green-500/50 max-w-xs">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full gradient-bg flex items-center justify-center">
                            <i className="fas fa-dollar-sign text-white"></i>
                        </div>
                        <div>
                            <div className="text-green-400 font-bold">+${earnings.amount.toFixed(2)}</div>
                            <div className="text-gray-400 text-sm">{earnings.source}</div>
                        </div>
                    </div>
                </div>
            );
        }

        // Login Form
        function LoginForm({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const res = await api.fetch('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ email, password })
                    });
                    // Auth cookie set by backend
                    onLogin(res.user);
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass rounded-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="text-4xl mb-2"><i className="fas fa-video gradient-text"></i></div>
                            <h1 className="text-2xl font-bold">Creator Studio</h1>
                            <p className="text-gray-400 mt-2">Sign in to your creator account</p>
                        </div>
                        {error && <div className="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4 text-red-300 text-sm">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-gray-400 text-sm mb-2">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-orange-500" placeholder="creator@example.com" required />
                            </div>
                            <div>
                                <label className="block text-gray-400 text-sm mb-2">Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-orange-500" placeholder="********" required />
                            </div>
                            <button type="submit" disabled={loading} className="w-full gradient-bg hover:opacity-90 text-white font-bold py-3 rounded-lg transition-opacity disabled:opacity-50">
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Stat Card Component
        function StatCard({ icon, label, value, subValue, color = 'orange', pulse = false }) {
            const colors = {
                orange: 'text-orange-500',
                green: 'text-green-500',
                blue: 'text-blue-500',
                purple: 'text-purple-500',
                pink: 'text-pink-500',
                yellow: 'text-yellow-500'
            };
            return (
                <div className={`stat-card rounded-xl p-4 border border-white/10 ${pulse ? 'pulse-glow' : ''}`}>
                    <div className="flex items-center gap-3">
                        <div className={`text-2xl ${colors[color]}`}><i className={`fas fa-${icon}`}></i></div>
                        <div>
                            <div className="text-gray-400 text-sm">{label}</div>
                            <div className="text-2xl font-bold">{value}</div>
                            {subValue && <div className="text-xs text-gray-500">{subValue}</div>}
                        </div>
                    </div>
                </div>
            );
        }

        // Tier Progress Bar
        function TierProgress({ current, max, tier, nextTier }) {
            const progress = Math.min((current / max) * 100, 100);
            const remaining = max - current;
            const nearMiss = remaining <= 3 && remaining > 0;

            return (
                <div className="glass rounded-xl p-4">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-sm text-gray-400">Tier Progress</span>
                        <span className={`text-sm font-bold ${nearMiss ? 'text-yellow-400' : 'text-orange-400'}`}>
                            {tier} {nextTier && `-> ${nextTier}`}
                        </span>
                    </div>
                    <div className="h-3 bg-white/10 rounded-full overflow-hidden">
                        <div className="tier-progress h-full rounded-full transition-all duration-500" style={{ width: `${progress}%` }} />
                    </div>
                    <div className="mt-2 text-right">
                        {nearMiss ? (
                            <span className="text-yellow-400 text-sm font-bold animate-pulse">
                                Only {remaining} more to unlock {nextTier}!
                            </span>
                        ) : (
                            <span className="text-gray-500 text-sm">{current} / {max} referrals</span>
                        )}
                    </div>
                </div>
            );
        }

        // Streak Counter
        function StreakCounter({ streak, lastPostDate }) {
            const isActive = streak > 0;
            return (
                <div className="glass rounded-xl p-4">
                    <div className="flex items-center gap-3">
                        <div className={`text-3xl ${isActive ? 'streak-fire' : ''}`}>
                            {isActive ? <span className="text-orange-500">&#128293;</span> : <span className="text-gray-500">&#128293;</span>}
                        </div>
                        <div>
                            <div className="text-gray-400 text-sm">Posting Streak</div>
                            <div className="text-2xl font-bold">{streak} days</div>
                            {lastPostDate && (
                                <div className="text-xs text-gray-500">
                                    Last post: {new Date(lastPostDate).toLocaleDateString()}
                                </div>
                            )}
                        </div>
                    </div>
                    {streak >= 7 && <div className="mt-2 text-xs text-yellow-400">Streak bonus active! +10% earnings</div>}
                </div>
            );
        }

        // Live Earnings Feed
        function LiveEarningsFeed({ earnings }) {
            return (
                <div className="glass rounded-xl p-4 max-h-64 overflow-y-auto scrollbar-hide">
                    <h3 className="text-sm font-bold text-gray-400 mb-3">LIVE EARNINGS</h3>
                    {earnings.length === 0 ? (
                        <p className="text-gray-500 text-sm text-center py-4">No earnings yet</p>
                    ) : (
                        <div className="space-y-2">
                            {earnings.map((e, i) => (
                                <div key={i} className="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                                    <div className="flex items-center gap-2">
                                        <i className={`fas fa-${e.type === 'signup' ? 'user-plus' : e.type === 'sale' ? 'shopping-cart' : 'dollar-sign'} text-green-400 text-sm`}></i>
                                        <span className="text-sm text-gray-300">{e.description}</span>
                                    </div>
                                    <span className="text-green-400 font-bold">+${e.amount.toFixed(2)}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Dashboard Tab
        function DashboardTab({ profile, earnings, onEarningsUpdate }) {
            const [showConfetti, setShowConfetti] = useState(false);
            const [earningsPopup, setEarningsPopup] = useState(null);
            const stats = earnings?.summary || { totalEarnings: 0, clicks: 0, signups: 0, conversionRate: 0 };
            const tier = profile?.tier || 'BRONZE';
            const tierProgress = { BRONZE: { max: 10, next: 'SILVER' }, SILVER: { max: 25, next: 'GOLD' }, GOLD: { max: 50, next: 'PLATINUM' }, PLATINUM: { max: 100, next: 'DIAMOND' }, DIAMOND: { max: 999, next: null } };
            const currentTier = tierProgress[tier] || tierProgress.BRONZE;

            useEffect(() => {
                if (earningsPopup) {
                    setShowConfetti(true);
                    const timer = setTimeout(() => setShowConfetti(false), 3000);
                    return () => clearTimeout(timer);
                }
            }, [earningsPopup]);

            return (
                <div className="space-y-6">
                    <Confetti active={showConfetti} />
                    {earningsPopup && <EarningsPopup earnings={earningsPopup} onDismiss={() => setEarningsPopup(null)} />}

                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <StatCard icon="dollar-sign" label="Total Earnings" value={`$${(stats.totalEarnings || 0).toFixed(2)}`} color="green" pulse />
                        <StatCard icon="mouse-pointer" label="Link Clicks" value={(stats.clicks || 0).toLocaleString()} color="blue" />
                        <StatCard icon="user-plus" label="Signups" value={(stats.signups || 0).toLocaleString()} color="purple" />
                        <StatCard icon="percentage" label="Conv. Rate" value={`${(stats.conversionRate || 0).toFixed(1)}%`} color="orange" />
                    </div>

                    {/* Tier & Streak Row */}
                    <div className="grid md:grid-cols-2 gap-4">
                        <TierProgress
                            current={stats.signups || 0}
                            max={currentTier.max}
                            tier={tier}
                            nextTier={currentTier.next}
                        />
                        <StreakCounter streak={profile?.streak || 0} lastPostDate={profile?.lastPostDate} />
                    </div>

                    {/* Live Feed */}
                    <LiveEarningsFeed earnings={earnings?.liveEarnings || []} />

                    {/* Quick Actions */}
                    <div className="glass rounded-xl p-4">
                        <h3 className="text-sm font-bold text-gray-400 mb-3">QUICK ACTIONS</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button className="bg-white/5 hover:bg-white/10 rounded-lg p-3 text-center transition-colors">
                                <i className="fas fa-share text-orange-400 mb-1"></i>
                                <div className="text-sm">Share Link</div>
                            </button>
                            <button className="bg-white/5 hover:bg-white/10 rounded-lg p-3 text-center transition-colors">
                                <i className="fas fa-plus text-pink-400 mb-1"></i>
                                <div className="text-sm">New Post</div>
                            </button>
                            <button className="bg-white/5 hover:bg-white/10 rounded-lg p-3 text-center transition-colors">
                                <i className="fas fa-chart-line text-blue-400 mb-1"></i>
                                <div className="text-sm">Analytics</div>
                            </button>
                            <button className="bg-white/5 hover:bg-white/10 rounded-lg p-3 text-center transition-colors">
                                <i className="fas fa-wallet text-green-400 mb-1"></i>
                                <div className="text-sm">Withdraw</div>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Create Tab - Post Composer
        function CreateTab({ onPostCreate }) {
            const [caption, setCaption] = useState('');
            const [visibility, setVisibility] = useState('public');
            const [mediaType, setMediaType] = useState(null);
            const [mediaFiles, setMediaFiles] = useState([]);
            const [mediaPreview, setMediaPreview] = useState([]);
            const [posting, setPosting] = useState(false);
            const [message, setMessage] = useState(null);

            const captionTemplates = [
                { label: 'Workout Tip', text: 'Quick tip that changed my fitness game...' },
                { label: 'Transformation', text: 'The journey from day 1 to now...' },
                { label: 'Motivation', text: 'Remember why you started...' },
                { label: 'Product Review', text: 'Been using this for 30 days and here\'s what I found...' },
                { label: 'Q&A', text: 'You asked, I\'m answering! Today\'s question:' }
            ];

            const handleFileSelect = async (type) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = type === 'carousel';
                input.accept = type === 'video' ? 'video/*' : 'image/*';

                input.onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    if (!files.length) return;

                    setMediaType(type);
                    const previews = files.map(file => URL.createObjectURL(file));
                    setMediaPreview(previews);
                    setMediaFiles(files);
                };

                input.click();
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!caption.trim()) return;
                setPosting(true);
                setMessage(null);

                try {
                    let mediaUrl = null;
                    let mediaPublicId = null;
                    let carousel = null;

                    // Upload media if present
                    if (mediaFiles.length > 0) {
                        if (mediaType === 'carousel') {
                            // Upload multiple images
                            const formData = new FormData();
                            mediaFiles.forEach(file => formData.append('files', file));

                            const uploadRes = await fetch(`${API_BASE}/upload/carousel`, {
                                method: 'POST',
                                credentials: 'include',
                                body: formData
                            });
                            const uploadData = await uploadRes.json();
                            if (!uploadData.success) throw new Error('Upload failed');

                            carousel = uploadData.data.images;
                        } else {
                            // Upload single image or video
                            const formData = new FormData();
                            formData.append('file', mediaFiles[0]);

                            const uploadRes = await fetch(`${API_BASE}/upload/media`, {
                                method: 'POST',
                                credentials: 'include',
                                body: formData
                            });
                            const uploadData = await uploadRes.json();
                            if (!uploadData.success) throw new Error('Upload failed');

                            mediaUrl = uploadData.data.url;
                            mediaPublicId = uploadData.data.publicId;
                        }
                    }

                    // Create post
                    await api.fetch('/coach/posts', {
                        method: 'POST',
                        body: JSON.stringify({
                            content: caption,
                            visibility,
                            mediaType: mediaType || 'none',
                            mediaUrl,
                            mediaPublicId,
                            carousel
                        })
                    });

                    setMessage({ type: 'success', text: 'Post created successfully!' });
                    setCaption('');
                    setMediaType(null);
                    setMediaFiles([]);
                    setMediaPreview([]);
                    onPostCreate?.();
                } catch (err) {
                    setMessage({ type: 'error', text: err.message || 'Failed to create post' });
                }
                setPosting(false);
            };

            return (
                <div className="space-y-6">
                    {message && (
                        <div className={`p-4 rounded-lg ${message.type === 'error' ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`}>
                            {message.text}
                        </div>
                    )}

                    <div className="glass rounded-xl p-6">
                        <h2 className="text-lg font-bold mb-4"><i className="fas fa-pen gradient-text mr-2"></i>Create Post</h2>

                        {/* Caption Templates */}
                        <div className="mb-4">
                            <label className="block text-gray-400 text-sm mb-2">Quick Templates</label>
                            <div className="flex flex-wrap gap-2">
                                {captionTemplates.map((t, i) => (
                                    <button
                                        key={i}
                                        onClick={() => setCaption(t.text)}
                                        className="bg-white/5 hover:bg-white/10 px-3 py-1 rounded-full text-sm text-gray-300 transition-colors"
                                    >
                                        {t.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* Caption */}
                            <div>
                                <label className="block text-gray-400 text-sm mb-2">Caption</label>
                                <textarea
                                    value={caption}
                                    onChange={e => setCaption(e.target.value)}
                                    className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-orange-500 min-h-32 resize-none"
                                    placeholder="Write your caption..."
                                    maxLength={2200}
                                />
                                <div className="text-right text-gray-500 text-xs mt-1">{caption.length}/2200</div>
                            </div>

                            {/* Visibility */}
                            <div>
                                <label className="block text-gray-400 text-sm mb-2">Visibility</label>
                                <div className="flex gap-3">
                                    {['public', 'followers', 'subscribers'].map(v => (
                                        <button
                                            key={v}
                                            type="button"
                                            onClick={() => setVisibility(v)}
                                            className={`px-4 py-2 rounded-lg text-sm capitalize transition-colors ${
                                                visibility === v ? 'gradient-bg text-white' : 'bg-white/5 text-gray-400 hover:bg-white/10'
                                            }`}
                                        >
                                            <i className={`fas fa-${v === 'public' ? 'globe' : v === 'followers' ? 'users' : 'lock'} mr-2`}></i>
                                            {v}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Media Upload */}
                            <div>
                                <label className="block text-gray-400 text-sm mb-2">Add Media</label>

                                {/* Media Preview */}
                                {mediaPreview.length > 0 && (
                                    <div className="mb-3 p-3 bg-white/5 rounded-lg">
                                        <div className="flex gap-2 overflow-x-auto">
                                            {mediaPreview.map((url, i) => (
                                                <div key={i} className="relative flex-shrink-0">
                                                    {mediaType === 'video' ? (
                                                        <video src={url} className="h-24 rounded" />
                                                    ) : (
                                                        <img src={url} className="h-24 rounded object-cover" />
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => { setMediaFiles([]); setMediaPreview([]); setMediaType(null); }}
                                            className="text-red-400 text-sm mt-2"
                                        >
                                            <i className="fas fa-times mr-1"></i>Remove
                                        </button>
                                    </div>
                                )}

                                {/* Upload Buttons */}
                                <div className="flex gap-3">
                                    <button
                                        type="button"
                                        onClick={() => handleFileSelect('image')}
                                        className={`flex-1 p-4 rounded-lg border-2 border-dashed transition-colors ${
                                            mediaType === 'image' ? 'border-orange-500 bg-orange-500/10' : 'border-white/10 hover:border-white/30'
                                        }`}
                                    >
                                        <i className="fas fa-image text-2xl mb-2 text-orange-400"></i>
                                        <div className="text-sm text-gray-400">Image</div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => handleFileSelect('video')}
                                        className={`flex-1 p-4 rounded-lg border-2 border-dashed transition-colors ${
                                            mediaType === 'video' ? 'border-pink-500 bg-pink-500/10' : 'border-white/10 hover:border-white/30'
                                        }`}
                                    >
                                        <i className="fas fa-video text-2xl mb-2 text-pink-400"></i>
                                        <div className="text-sm text-gray-400">Video</div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => handleFileSelect('carousel')}
                                        className={`flex-1 p-4 rounded-lg border-2 border-dashed transition-colors ${
                                            mediaType === 'carousel' ? 'border-purple-500 bg-purple-500/10' : 'border-white/10 hover:border-white/30'
                                        }`}
                                    >
                                        <i className="fas fa-images text-2xl mb-2 text-purple-400"></i>
                                        <div className="text-sm text-gray-400">Carousel</div>
                                    </button>
                                </div>
                            </div>

                            <button
                                type="submit"
                                disabled={posting || !caption.trim()}
                                className="w-full gradient-bg hover:opacity-90 text-white font-bold py-3 rounded-lg transition-opacity disabled:opacity-50"
                            >
                                {posting ? 'Posting...' : 'Create Post'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Content Tab - Posts List
        function ContentTab() {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingPost, setEditingPost] = useState(null);
            const [editCaption, setEditCaption] = useState('');
            const [editVisibility, setEditVisibility] = useState('public');

            useEffect(() => {
                const loadPosts = async () => {
                    try {
                        const res = await api.fetch('/coach/posts');
                        setPosts(res.posts || []);
                    } catch (err) {
                        console.error('Failed to load posts:', err);
                    }
                    setLoading(false);
                };
                loadPosts();
            }, []);

            const handleEditPost = (post) => {
                setEditingPost(post);
                setEditCaption(post.content || post.caption || '');
                setEditVisibility(post.visibility || 'public');
            };

            const handleSaveEdit = async () => {
                try {
                    const res = await api.fetch(`/coach/posts/${editingPost._id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            content: editCaption,
                            visibility: editVisibility
                        })
                    });
                    if (res.success) {
                        // Update local state
                        setPosts(posts.map(p => p._id === editingPost._id ? { ...p, content: editCaption, caption: editCaption, visibility: editVisibility } : p));
                        setEditingPost(null);
                    }
                } catch (err) {
                    console.error('Failed to update post:', err);
                    alert('Failed to update post');
                }
            };

            const handleDeletePost = async (postId) => {
                if (!confirm('Are you sure you want to delete this post? This cannot be undone.')) {
                    return;
                }
                try {
                    const res = await api.fetch(`/coach/posts/${postId}`, {
                        method: 'DELETE'
                    });
                    if (res.success) {
                        setPosts(posts.filter(p => p._id !== postId));
                    }
                } catch (err) {
                    console.error('Failed to delete post:', err);
                    alert('Failed to delete post');
                }
            };

            if (loading) {
                return <div className="flex justify-center py-12"><i className="fas fa-spinner fa-spin text-3xl text-orange-500"></i></div>;
            }

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h2 className="text-lg font-bold">Your Content</h2>
                        <span className="text-gray-400 text-sm">{posts.length} posts</span>
                    </div>

                    {posts.length === 0 ? (
                        <div className="glass rounded-xl p-8 text-center">
                            <i className="fas fa-photo-film text-4xl text-gray-500 mb-4"></i>
                            <p className="text-gray-400">No posts yet. Create your first post!</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {posts.map((post, i) => (
                                <div key={post._id || i} className="glass rounded-xl p-4">
                                    <div className="flex gap-4">
                                        <div className="w-20 h-20 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i className={`fas fa-${post.mediaType === 'video' ? 'video' : 'image'} text-gray-500 text-2xl`}></i>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <p className="text-sm text-gray-300 line-clamp-2 mb-2">{post.caption}</p>
                                            <div className="flex gap-4 text-xs text-gray-500">
                                                <span><i className="fas fa-eye mr-1"></i>{(post.views || 0).toLocaleString()}</span>
                                                <span><i className="fas fa-heart mr-1"></i>{(post.likes || 0).toLocaleString()}</span>
                                                <span><i className="fas fa-comment mr-1"></i>{(post.comments || 0).toLocaleString()}</span>
                                                <span className="text-green-400"><i className="fas fa-dollar-sign mr-1"></i>${(post.earnings || 0).toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <div className="flex flex-col items-end justify-between">
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => handleEditPost(post)}
                                                    className="text-blue-400 hover:text-blue-300 transition-colors"
                                                    title="Edit post"
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button
                                                    onClick={() => handleDeletePost(post._id)}
                                                    className="text-red-400 hover:text-red-300 transition-colors"
                                                    title="Delete post"
                                                >
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div className="text-right">
                                                <span className={`text-xs px-2 py-1 rounded-full ${
                                                    post.visibility === 'public' ? 'bg-green-500/20 text-green-400' :
                                                    post.visibility === 'followers' ? 'bg-blue-500/20 text-blue-400' :
                                                    'bg-yellow-500/20 text-yellow-400'
                                                }`}>
                                                    {post.visibility}
                                                </span>
                                                <div className="text-xs text-gray-500 mt-2">
                                                    {post.createdAt ? new Date(post.createdAt).toLocaleDateString() : 'Draft'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Edit Post Modal */}
                    {editingPost && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setEditingPost(null)}>
                            <div className="glass rounded-xl p-6 max-w-lg w-full" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Edit Post</h3>
                                    <button onClick={() => setEditingPost(null)} className="text-gray-400 hover:text-white">
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Caption</label>
                                        <textarea
                                            value={editCaption}
                                            onChange={(e) => setEditCaption(e.target.value)}
                                            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 focus:outline-none focus:border-orange-500 resize-none"
                                            rows="4"
                                            placeholder="Write a caption..."
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-2">Visibility</label>
                                        <select
                                            value={editVisibility}
                                            onChange={(e) => setEditVisibility(e.target.value)}
                                            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 focus:outline-none focus:border-orange-500"
                                        >
                                            <option value="public">Public - Everyone can see</option>
                                            <option value="subscribers">Subscribers - Only paid subscribers</option>
                                            <option value="private">Private - Only you</option>
                                        </select>
                                    </div>

                                    <div className="flex gap-3 pt-4">
                                        <button
                                            onClick={handleSaveEdit}
                                            className="flex-1 bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity"
                                        >
                                            Save Changes
                                        </button>
                                        <button
                                            onClick={() => setEditingPost(null)}
                                            className="flex-1 bg-white/5 border border-white/10 text-white py-3 rounded-lg font-semibold hover:bg-white/10 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Links Tab - Linktree-style Manager
        function LinksTab({ profile, onUpdate }) {
            const [links, setLinks] = useState([]);
            const [editingLink, setEditingLink] = useState(null);
            const [newLink, setNewLink] = useState({ title: '', url: '', thumbnail: null });
            const [uploadingThumbnail, setUploadingThumbnail] = useState(false);
            const [draggedItem, setDraggedItem] = useState(null);
            const [referralCode, setReferralCode] = useState(null);
            const [copyMessage, setCopyMessage] = useState('');

            useEffect(() => {
                // Load initial links from the profile prop
                setLinks(profile?.coachProfile?.links || []);
            }, [profile]);

            useEffect(() => {
                const loadReferralCode = async () => {
                    try {
                        const res = await api.fetch('/earnings/referral-code');
                        if (res.success && res.data) {
                            setReferralCode(res.data.referralCode);
                        }
                    } catch (err) {
                        console.error('Failed to load referral code:', err);
                    }
                };
                loadReferralCode();
            }, []);
            
            const saveLinks = async (updatedLinks) => {
                try {
                    await api.fetch('/coach/profile', {
                        method: 'PUT',
                        body: JSON.stringify({
                            coachProfile: {
                                links: updatedLinks
                            }
                        })
                    });
                    if(onUpdate) onUpdate(); // Trigger a refresh of all profile data
                } catch (error) {
                    console.error("Failed to save links:", error);
                    alert("Could not save link changes. Please try again.");
                }
            };

            const copyToClipboard = (text, label) => {
                navigator.clipboard.writeText(text).then(() => {
                    setCopyMessage(`${label} copied!`);
                    setTimeout(() => setCopyMessage(''), 2000);
                }).catch(console.error);
            };

            const handleDragStart = (e, index) => {
                setDraggedItem(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedItem === null || draggedItem === index) return;

                const newLinks = [...links];
                const item = newLinks.splice(draggedItem, 1)[0];
                newLinks.splice(index, 0, item);
                setLinks(newLinks);
                setDraggedItem(index);
            };

            const handleDragEnd = () => {
                setDraggedItem(null);
                saveLinks(links);
            };

            const uploadThumbnail = async (file, forEditing = false) => {
                setUploadingThumbnail(true);
                try {
                    const formData = new FormData();
                    // The backend endpoint for image upload is just 'image', not 'file'
                    formData.append('image', file); 
                    const res = await fetch(`${API_BASE}/upload/image`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success && data.url) {
                        if (forEditing && editingLink) {
                            setEditingLink({ ...editingLink, thumbnail: data.url });
                        } else {
                            setNewLink({ ...newLink, thumbnail: data.url });
                        }
                    } else {
                        throw new Error(data.message || 'Image upload failed');
                    }
                } catch (err) {
                    console.error('Failed to upload thumbnail:', err);
                    alert('Thumbnail upload failed. Please try again.');
                } finally {
                    setUploadingThumbnail(false);
                }
            };

            const addLink = () => {
                if (!newLink.title || !newLink.url) return;
                // Use a temporary ID for React keys, the backend will assign a real one
                const link = { ...newLink, id: `temp-${Date.now()}`, clicks: 0, active: true };
                const updatedLinks = [...links, link];
                setLinks(updatedLinks);
                setNewLink({ title: '', url: '', thumbnail: null });
                saveLinks(updatedLinks);
            };

            const deleteLink = (id) => {
                const updatedLinks = links.filter(l => l.id !== id && l._id !== id);
                setLinks(updatedLinks);
                saveLinks(updatedLinks);
            };

            const toggleActive = (id) => {
                const updatedLinks = links.map(l => (l.id === id || l._id === id) ? { ...l, active: !l.active } : l);
                setLinks(updatedLinks);
                saveLinks(updatedLinks);
            };

            const updateLink = () => {
                if (!editingLink.title || !editingLink.url) return;
                const updatedLinks = links.map(l => (l.id === editingLink.id || l._id === editingLink._id) ? editingLink : l);
                setLinks(updatedLinks);
                setEditingLink(null);
                saveLinks(updatedLinks);
            };

            return (
                <div className="space-y-6">
                    {/* Edit Link Modal */}
                    {editingLink && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass rounded-xl p-6 max-w-md w-full">
                                <h3 className="text-xl font-bold mb-4">
                                    <i className="fas fa-edit gradient-text mr-2"></i>Edit Link
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-gray-400 text-sm mb-2">Link Title</label>
                                        <input
                                            type="text"
                                            value={editingLink.title}
                                            onChange={e => setEditingLink({ ...editingLink, title: e.target.value })}
                                            placeholder="My Fitness Program"
                                            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-400 text-sm mb-2">URL</label>
                                        <input
                                            type="url"
                                            value={editingLink.url}
                                            onChange={e => setEditingLink({ ...editingLink, url: e.target.value })}
                                            placeholder="https://..."
                                            className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-400 text-sm mb-2">Thumbnail Image</label>
                                        <div className="flex items-center gap-3">
                                            {editingLink.thumbnail ? (
                                                <img src={editingLink.thumbnail} alt="" className="w-16 h-16 rounded-lg object-cover" />
                                            ) : (
                                                <div className="w-16 h-16 rounded-lg bg-white/10 flex items-center justify-center">
                                                    <i className="fas fa-image text-gray-500 text-xl"></i>
                                                </div>
                                            )}
                                            <div className="flex-1">
                                                <label className="cursor-pointer">
                                                    <input
                                                        type="file"
                                                        accept="image/*"
                                                        className="hidden"
                                                        onChange={e => e.target.files[0] && uploadThumbnail(e.target.files[0], true)}
                                                    />
                                                    <span className="inline-flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors">
                                                        {uploadingThumbnail ? (
                                                            <><i className="fas fa-spinner animate-spin"></i> Uploading...</>
                                                        ) : (
                                                            <><i className="fas fa-upload"></i> {editingLink.thumbnail ? 'Change' : 'Upload'}</>
                                                        )}
                                                    </span>
                                                </label>
                                                {editingLink.thumbnail && (
                                                    <button
                                                        onClick={() => setEditingLink({ ...editingLink, thumbnail: null })}
                                                        className="ml-2 text-red-400 hover:text-red-300 text-sm"
                                                    >
                                                        Remove
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        <button
                                            onClick={() => setEditingLink(null)}
                                            className="flex-1 bg-white/5 hover:bg-white/10 text-white font-bold py-2 rounded-lg transition-colors"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={updateLink}
                                            disabled={!editingLink.title || !editingLink.url}
                                            className="flex-1 gradient-bg hover:opacity-90 text-white font-bold py-2 rounded-lg transition-opacity disabled:opacity-50"
                                        >
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Referral Code Section */}
                    {referralCode && (
                        <div className="glass rounded-xl p-6 border-l-4 border-orange-500">
                            {copyMessage && (
                                <div className="mb-4 p-3 bg-green-500/20 text-green-300 rounded-lg text-sm">
                                    <i className="fas fa-check mr-2"></i>{copyMessage}
                                </div>
                            )}
                            <div className="flex items-center gap-3 mb-4">
                                <i className="fas fa-gift text-3xl text-orange-400"></i>
                                <div>
                                    <h2 className="text-lg font-bold">Your Referral Code</h2>
                                    <p className="text-gray-400 text-sm">Share this code to earn commissions on signups</p>
                                </div>
                            </div>
                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="bg-white/5 rounded-lg p-4">
                                    <div className="text-gray-400 text-xs mb-2">Referral Code</div>
                                    <div className="flex items-center gap-2">
                                        <code className="text-2xl font-bold font-mono text-orange-400">{referralCode}</code>
                                        <button
                                            onClick={() => copyToClipboard(referralCode, 'Code')}
                                            className="text-gray-400 hover:text-white transition-colors"
                                            title="Copy code"
                                        >
                                            <i className="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-white/5 rounded-lg p-4">
                                    <div className="text-gray-400 text-xs mb-2">Referral Link</div>
                                    <div className="flex items-center gap-2">
                                        <div className="text-sm font-mono text-blue-400 truncate flex-1">
                                            clockwork.fit?ref={referralCode}
                                        </div>
                                        <button
                                            onClick={() => copyToClipboard(`https://clockwork.fit?ref=${referralCode}`, 'Link')}
                                            className="text-gray-400 hover:text-white transition-colors"
                                            title="Copy link"
                                        >
                                            <i className="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-4 flex gap-2">
                                <button
                                    onClick={() => copyToClipboard(`https://clockwork.fit/coach-apply?ref=${referralCode}`, 'Coach signup link')}
                                    className="flex-1 bg-white/5 hover:bg-white/10 rounded-lg p-3 text-sm transition-colors text-left"
                                >
                                    <i className="fas fa-dumbbell text-orange-400 mr-2"></i>
                                    <span>Copy Coach Signup Link</span>
                                </button>
                                <button
                                    onClick={() => copyToClipboard(`https://clockwork.fit/apply?ref=${referralCode}`, 'Influencer signup link')}
                                    className="flex-1 bg-white/5 hover:bg-white/10 rounded-lg p-3 text-sm transition-colors text-left"
                                >
                                    <i className="fas fa-video text-pink-400 mr-2"></i>
                                    <span>Copy Influencer Signup Link</span>
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="glass rounded-xl p-6">
                        <h2 className="text-lg font-bold mb-4"><i className="fas fa-link gradient-text mr-2"></i>Your Links</h2>
                        <p className="text-gray-400 text-sm mb-4">Drag to reorder. Links appear in this order on your profile.</p>

                        <div className="space-y-3">
                            {links.map((link, index) => (
                                <div
                                    key={link.id || link._id || index}
                                    draggable
                                    onDragStart={e => handleDragStart(e, index)}
                                    onDragOver={e => handleDragOver(e, index)}
                                    onDragEnd={handleDragEnd}
                                    className={`glass rounded-lg p-4 cursor-move transition-all ${
                                        draggedItem === index ? 'opacity-50 scale-95' : ''
                                    } ${!link.active ? 'opacity-60' : ''}`}
                                >
                                    <div className="flex items-center gap-4">
                                        <i className="fas fa-grip-vertical text-gray-500"></i>
                                        {link.thumbnail ? (
                                            <img src={link.thumbnail} alt="" className="w-12 h-12 rounded-lg object-cover" />
                                        ) : (
                                            <div className="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center">
                                                <i className="fas fa-link text-gray-500"></i>
                                            </div>
                                        )}
                                        <div className="flex-1 min-w-0">
                                            <div className="font-medium">{link.title}</div>
                                            <div className="text-gray-500 text-sm truncate">{link.url}</div>
                                        </div>
                                        <div className="text-sm text-gray-400">
                                            <i className="fas fa-mouse-pointer mr-1"></i>{link.clicks || 0}
                                        </div>
                                        <button
                                            onClick={() => toggleActive(link.id || link._id)}
                                            className={`w-10 h-6 rounded-full transition-colors ${link.active ? 'bg-green-500' : 'bg-gray-600'}`}
                                        >
                                            <div className={`w-4 h-4 bg-white rounded-full transition-transform ${link.active ? 'translate-x-5' : 'translate-x-1'}`}></div>
                                        </button>
                                        <button onClick={() => setEditingLink(link)} className="text-gray-400 hover:text-white">
                                            <i className="fas fa-edit"></i>
                                        </button>
                                        <button onClick={() => deleteLink(link.id || link._id)} className="text-red-400 hover:text-red-300">
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Add New Link */}
                    <div className="glass rounded-xl p-6">
                        <h3 className="text-sm font-bold text-gray-400 mb-4">ADD NEW LINK</h3>
                        <div className="space-y-4">
                            <div className="flex gap-3 items-center">
                                {/* Thumbnail Preview/Upload */}
                                <label className="cursor-pointer flex-shrink-0">
                                    <input
                                        type="file"
                                        accept="image/*"
                                        className="hidden"
                                        onChange={e => e.target.files[0] && uploadThumbnail(e.target.files[0])}
                                    />
                                    {newLink.thumbnail ? (
                                        <img src={newLink.thumbnail} alt="" className="w-14 h-14 rounded-lg object-cover hover:opacity-80 transition-opacity" />
                                    ) : (
                                        <div className="w-14 h-14 rounded-lg bg-white/10 hover:bg-white/20 flex flex-col items-center justify-center transition-colors">
                                            {uploadingThumbnail ? (
                                                <i className="fas fa-spinner animate-spin text-gray-400"></i>
                                            ) : (
                                                <>
                                                    <i className="fas fa-image text-gray-500 text-lg"></i>
                                                    <span className="text-[10px] text-gray-500 mt-1">Photo</span>
                                                </>
                                            )}
                                        </div>
                                    )}
                                </label>
                                <input
                                    type="text"
                                    value={newLink.title}
                                    onChange={e => setNewLink({ ...newLink, title: e.target.value })}
                                    placeholder="Link title"
                                    className="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                />
                                <input
                                    type="url"
                                    value={newLink.url}
                                    onChange={e => setNewLink({ ...newLink, url: e.target.value })}
                                    placeholder="https://..."
                                    className="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                                />
                                <button
                                    onClick={addLink}
                                    disabled={!newLink.title || !newLink.url}
                                    className="gradient-bg hover:opacity-90 text-white font-bold px-6 py-2 rounded-lg transition-opacity disabled:opacity-50"
                                >
                                    <i className="fas fa-plus"></i>
                                </button>
                            </div>
                            {newLink.thumbnail && (
                                <button
                                    onClick={() => setNewLink({ ...newLink, thumbnail: null })}
                                    className="text-red-400 hover:text-red-300 text-sm"
                                >
                                    <i className="fas fa-times mr-1"></i> Remove thumbnail
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
