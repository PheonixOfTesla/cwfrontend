<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClockWork - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --cw-primary: #6366f1;
            --cw-secondary: #8b5cf6;
            --cw-dark: #1e1b4b;
        }
        * { font-family: 'Inter', -apple-system, system-ui, sans-serif; }
        body { background: #000; color: #fff; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--cw-primary); color: var(--cw-primary); }
        .card { background: #16181c; border: 1px solid #2f3336; border-radius: 16px; }
        .post-card { background: #16181c; border-bottom: 1px solid #2f3336; }
        .post-card:hover { background: #1d1f23; }
        .cw-gradient { background: linear-gradient(135deg, var(--cw-primary) 0%, var(--cw-secondary) 100%); }
        .btn-primary { background: var(--cw-primary); }
        .btn-primary:hover { background: #4f46e5; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
    // ═══════════════════════════════════════════════════════════
    // CLOCKWORK PROFILE PAGE - Twitter/OF Style
    // ═══════════════════════════════════════════════════════════

    const API_BASE = 'https://clockwork-backend.up.railway.app/api';

    // State
    let state = {
        user: null,
        profile: null,
        posts: [],
        products: [],
        earnings: null,
        activeTab: 'posts',
        isOwnProfile: true,
        loading: true,
        newPostText: '',
        newPostMedia: null
    };

    // Profile Tabs
    const TABS = [
        { id: 'posts', label: 'Posts', icon: 'fa-newspaper' },
        { id: 'products', label: 'Products', icon: 'fa-shopping-bag' },
        { id: 'about', label: 'About', icon: 'fa-user' },
        { id: 'revenue', label: 'Revenue', icon: 'fa-chart-line', ownerOnly: true }
    ];

    // ═══════════════════════════════════════════════════════════
    // RENDER FUNCTIONS
    // ═══════════════════════════════════════════════════════════

    function render() {
        const app = document.getElementById('app');

        if (state.loading) {
            app.innerHTML = renderLoading();
            return;
        }

        if (!state.user) {
            window.location.href = '/login.html';
            return;
        }

        app.innerHTML = `
            <div class="min-h-screen">
                ${renderHeader()}
                ${renderProfileHeader()}
                ${renderTabs()}
                <main class="max-w-2xl mx-auto">
                    ${renderActiveTab()}
                </main>
            </div>
        `;
    }

    function renderLoading() {
        return `
            <div class="min-h-screen flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500 mb-4"></i>
                    <p class="text-gray-400">Loading profile...</p>
                </div>
            </div>
        `;
    }

    function renderHeader() {
        return `
            <header class="sticky top-0 z-50 bg-black/80 backdrop-blur-md border-b border-gray-800">
                <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <a href="/" class="text-xl font-bold flex items-center gap-2">
                            <div class="w-8 h-8 cw-gradient rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-white text-sm"></i>
                            </div>
                            <span class="hidden md:inline">ClockWork</span>
                        </a>
                    </div>
                    <div class="flex items-center gap-3">
                        ${state.user.userType === 'coach' ? `
                            <a href="/coaching-portal.html" class="text-sm text-indigo-400 hover:text-indigo-300">
                                <i class="fas fa-chalkboard-teacher mr-1"></i> Coaching Portal
                            </a>
                        ` : ''}
                        <button onclick="logout()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>
        `;
    }

    function renderProfileHeader() {
        const profile = state.profile || state.user;
        const stats = state.earnings?.stats || { clicks: 0, signups: 0, conversions: 0 };

        return `
            <!-- Cover Image -->
            <div class="h-48 md:h-64 cw-gradient relative">
                ${state.isOwnProfile ? `
                    <button onclick="changeCover()" class="absolute bottom-4 right-4 bg-black/50 text-white px-3 py-1.5 rounded-full text-sm hover:bg-black/70">
                        <i class="fas fa-camera mr-1"></i> Change Cover
                    </button>
                ` : ''}
            </div>

            <!-- Profile Info -->
            <div class="max-w-2xl mx-auto px-4">
                <div class="relative -mt-20 mb-4">
                    <!-- Avatar -->
                    <div class="relative inline-block">
                        <img src="${profile.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(profile.name) + '&size=150&background=6366f1&color=fff'}"
                             class="w-32 h-32 rounded-full border-4 border-black object-cover">
                        ${state.isOwnProfile ? `
                            <button onclick="changeAvatar()" class="absolute bottom-2 right-2 bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-indigo-700">
                                <i class="fas fa-camera text-sm"></i>
                            </button>
                        ` : ''}
                    </div>

                    <!-- Action Buttons -->
                    <div class="absolute right-0 top-24 flex gap-2">
                        ${state.isOwnProfile ? `
                            <button onclick="editProfile()" class="border border-gray-600 text-white px-4 py-2 rounded-full hover:bg-gray-900 text-sm font-bold">
                                Edit Profile
                            </button>
                        ` : `
                            <button onclick="followUser()" class="bg-white text-black px-5 py-2 rounded-full hover:bg-gray-200 text-sm font-bold">
                                Follow
                            </button>
                            <button onclick="subscribeToCoach()" class="btn-primary text-white px-5 py-2 rounded-full text-sm font-bold">
                                Subscribe
                            </button>
                        `}
                    </div>
                </div>

                <!-- Name & Bio -->
                <div class="mb-4">
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-bold">${profile.name}</h1>
                        ${profile.userType === 'coach' ? `
                            <span class="bg-indigo-600 text-white text-xs px-2 py-0.5 rounded">Coach</span>
                        ` : profile.userType === 'influencer' ? `
                            <span class="bg-purple-600 text-white text-xs px-2 py-0.5 rounded">Influencer</span>
                        ` : ''}
                        ${profile.verified ? `<i class="fas fa-check-circle text-indigo-500"></i>` : ''}
                    </div>
                    <p class="text-gray-500">@${profile.username || profile.name.toLowerCase().replace(/\s+/g, '')}</p>
                    <p class="mt-2 text-gray-300">${profile.bio || 'No bio yet'}</p>

                    <!-- Specialties/Tags -->
                    ${profile.coachProfile?.specialty ? `
                        <div class="flex flex-wrap gap-2 mt-3">
                            <span class="text-sm bg-gray-800 text-gray-300 px-3 py-1 rounded-full">
                                <i class="fas fa-dumbbell mr-1 text-indigo-400"></i> ${profile.coachProfile.specialty}
                            </span>
                            ${profile.coachProfile.experienceYears ? `
                                <span class="text-sm bg-gray-800 text-gray-300 px-3 py-1 rounded-full">
                                    <i class="fas fa-award mr-1 text-yellow-500"></i> ${profile.coachProfile.experienceYears}+ years
                                </span>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Social Links -->
                    <div class="flex gap-4 mt-3 text-gray-500 text-sm">
                        <span><i class="fas fa-calendar mr-1"></i> Joined ${formatJoinDate(profile.createdAt)}</span>
                        ${profile.location ? `<span><i class="fas fa-map-marker-alt mr-1"></i> ${profile.location}</span>` : ''}
                        ${profile.website ? `<a href="${profile.website}" class="text-indigo-400 hover:underline"><i class="fas fa-link mr-1"></i> ${profile.website.replace('https://', '')}</a>` : ''}
                    </div>
                </div>

                <!-- Stats -->
                <div class="flex gap-6 pb-4 border-b border-gray-800">
                    <div class="cursor-pointer hover:underline">
                        <span class="font-bold">${formatNumber(profile.followersCount || 0)}</span>
                        <span class="text-gray-500"> Followers</span>
                    </div>
                    <div class="cursor-pointer hover:underline">
                        <span class="font-bold">${formatNumber(profile.followingCount || 0)}</span>
                        <span class="text-gray-500"> Following</span>
                    </div>
                    ${profile.userType === 'coach' || profile.userType === 'influencer' ? `
                        <div>
                            <span class="font-bold">${formatNumber(stats.conversions || 0)}</span>
                            <span class="text-gray-500"> Referrals</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function renderTabs() {
        const visibleTabs = TABS.filter(tab => !tab.ownerOnly || state.isOwnProfile);

        return `
            <div class="max-w-2xl mx-auto border-b border-gray-800 sticky top-[57px] bg-black/80 backdrop-blur-md z-40">
                <div class="flex">
                    ${visibleTabs.map(tab => `
                        <button onclick="setTab('${tab.id}')"
                                class="tab-btn flex-1 py-4 text-center text-sm font-medium hover:bg-gray-900 transition
                                       ${state.activeTab === tab.id ? 'active text-white' : 'text-gray-500'}">
                            <i class="fas ${tab.icon} mr-2"></i>${tab.label}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderActiveTab() {
        switch(state.activeTab) {
            case 'posts': return renderPosts();
            case 'products': return renderProducts();
            case 'about': return renderAbout();
            case 'revenue': return renderRevenue();
            default: return renderPosts();
        }
    }

    // ═══════════════════════════════════════════════════════════
    // POSTS TAB
    // ═══════════════════════════════════════════════════════════

    function renderPosts() {
        return `
            <div>
                <!-- New Post Composer (if own profile) -->
                ${state.isOwnProfile ? `
                    <div class="p-4 border-b border-gray-800">
                        <div class="flex gap-3">
                            <img src="${state.user.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(state.user.name)}"
                                 class="w-12 h-12 rounded-full">
                            <div class="flex-1">
                                <textarea id="post-input"
                                          placeholder="What's happening?"
                                          class="w-full bg-transparent text-white text-lg resize-none outline-none placeholder-gray-600"
                                          rows="3"
                                          oninput="updatePostText(this.value)">${state.newPostText}</textarea>

                                <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-800">
                                    <div class="flex gap-4 text-indigo-400">
                                        <button onclick="addMedia('image')" class="hover:text-indigo-300">
                                            <i class="fas fa-image"></i>
                                        </button>
                                        <button onclick="addMedia('video')" class="hover:text-indigo-300">
                                            <i class="fas fa-video"></i>
                                        </button>
                                        <button onclick="addMedia('gif')" class="hover:text-indigo-300">
                                            <i class="fas fa-gift"></i>
                                        </button>
                                    </div>
                                    <button onclick="submitPost()" class="btn-primary text-white px-5 py-2 rounded-full font-bold text-sm disabled:opacity-50"
                                            ${state.newPostText.trim() ? '' : 'disabled'}>
                                        Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Posts Feed -->
                ${state.posts.length > 0 ? `
                    ${state.posts.map(post => renderPost(post)).join('')}
                ` : `
                    <div class="p-8 text-center">
                        <i class="fas fa-newspaper text-4xl text-gray-700 mb-4"></i>
                        <p class="text-gray-500">No posts yet</p>
                        ${state.isOwnProfile ? `<p class="text-gray-600 text-sm mt-2">Share your first post with your followers!</p>` : ''}
                    </div>
                `}
            </div>
        `;
    }

    function renderPost(post) {
        return `
            <article class="post-card p-4 cursor-pointer" onclick="viewPost('${post._id}')">
                <div class="flex gap-3">
                    <img src="${post.author?.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(post.author?.name || 'User')}"
                         class="w-12 h-12 rounded-full">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-bold hover:underline">${post.author?.name || 'User'}</span>
                            <span class="text-gray-500">@${post.author?.username || 'user'}</span>
                            <span class="text-gray-500">·</span>
                            <span class="text-gray-500">${formatTimeAgo(post.createdAt)}</span>
                        </div>
                        <p class="mt-1 text-gray-200 whitespace-pre-wrap">${post.content}</p>

                        ${post.media ? `
                            <div class="mt-3 rounded-2xl overflow-hidden border border-gray-800">
                                ${post.media.type === 'image' ? `
                                    <img src="${post.media.url}" class="w-full max-h-[500px] object-cover">
                                ` : post.media.type === 'video' ? `
                                    <video src="${post.media.url}" controls class="w-full max-h-[500px]"></video>
                                ` : ''}
                            </div>
                        ` : ''}

                        <!-- Post Actions -->
                        <div class="flex justify-between mt-3 text-gray-500 max-w-md">
                            <button onclick="event.stopPropagation(); replyToPost('${post._id}')" class="flex items-center gap-2 hover:text-indigo-400 group">
                                <div class="p-2 rounded-full group-hover:bg-indigo-400/10">
                                    <i class="far fa-comment"></i>
                                </div>
                                <span class="text-sm">${formatNumber(post.repliesCount || 0)}</span>
                            </button>
                            <button onclick="event.stopPropagation(); repostPost('${post._id}')" class="flex items-center gap-2 hover:text-green-400 group">
                                <div class="p-2 rounded-full group-hover:bg-green-400/10">
                                    <i class="fas fa-retweet"></i>
                                </div>
                                <span class="text-sm">${formatNumber(post.repostsCount || 0)}</span>
                            </button>
                            <button onclick="event.stopPropagation(); likePost('${post._id}')" class="flex items-center gap-2 hover:text-red-400 group">
                                <div class="p-2 rounded-full group-hover:bg-red-400/10">
                                    <i class="${post.liked ? 'fas' : 'far'} fa-heart ${post.liked ? 'text-red-500' : ''}"></i>
                                </div>
                                <span class="text-sm">${formatNumber(post.likesCount || 0)}</span>
                            </button>
                            <button onclick="event.stopPropagation(); sharePost('${post._id}')" class="flex items-center gap-2 hover:text-indigo-400 group">
                                <div class="p-2 rounded-full group-hover:bg-indigo-400/10">
                                    <i class="fas fa-share"></i>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </article>
        `;
    }

    // ═══════════════════════════════════════════════════════════
    // PRODUCTS TAB
    // ═══════════════════════════════════════════════════════════

    function renderProducts() {
        return `
            <div class="p-4">
                ${state.isOwnProfile ? `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold">My Products</h2>
                        <button onclick="createProduct()" class="btn-primary text-white px-4 py-2 rounded-full text-sm font-bold">
                            <i class="fas fa-plus mr-1"></i> Add Product
                        </button>
                    </div>
                ` : ''}

                ${state.products.length > 0 ? `
                    <div class="grid grid-cols-2 gap-4">
                        ${state.products.map(product => `
                            <div class="card overflow-hidden cursor-pointer hover:border-indigo-500" onclick="viewProduct('${product._id}')">
                                <div class="aspect-square bg-gray-800 relative">
                                    ${product.image ? `
                                        <img src="${product.image}" class="w-full h-full object-cover">
                                    ` : `
                                        <div class="w-full h-full flex items-center justify-center">
                                            <i class="fas fa-box text-4xl text-gray-600"></i>
                                        </div>
                                    `}
                                    ${product.type === 'program' ? `
                                        <span class="absolute top-2 left-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded">Program</span>
                                    ` : product.type === 'ebook' ? `
                                        <span class="absolute top-2 left-2 bg-green-600 text-white text-xs px-2 py-1 rounded">E-Book</span>
                                    ` : ''}
                                </div>
                                <div class="p-3">
                                    <h3 class="font-bold truncate">${product.name}</h3>
                                    <p class="text-indigo-400 font-bold mt-1">$${product.price}</p>
                                    <p class="text-gray-500 text-sm">${product.sales || 0} sales</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="text-center py-12">
                        <i class="fas fa-shopping-bag text-4xl text-gray-700 mb-4"></i>
                        <p class="text-gray-500">No products yet</p>
                        ${state.isOwnProfile ? `
                            <p class="text-gray-600 text-sm mt-2">Start selling programs, e-books, or merchandise!</p>
                            <button onclick="createProduct()" class="btn-primary text-white px-5 py-2 rounded-full text-sm font-bold mt-4">
                                Create Your First Product
                            </button>
                        ` : ''}
                    </div>
                `}
            </div>
        `;
    }

    // ═══════════════════════════════════════════════════════════
    // ABOUT TAB
    // ═══════════════════════════════════════════════════════════

    function renderAbout() {
        const profile = state.profile || state.user;

        return `
            <div class="p-4 space-y-6">
                <!-- Bio Section -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-user text-indigo-400"></i> About
                    </h3>
                    <p class="text-gray-300">${profile.bio || 'No bio provided'}</p>
                </div>

                ${profile.userType === 'coach' ? `
                    <!-- Coaching Info -->
                    <div class="card p-4">
                        <h3 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-chalkboard-teacher text-indigo-400"></i> Coaching
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Specialty</span>
                                <span>${profile.coachProfile?.specialty || 'General Fitness'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Experience</span>
                                <span>${profile.coachProfile?.experienceYears || 0}+ years</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Content Tier</span>
                                <span>$${(profile.coachProfile?.pricing?.contentTier || 999) / 100}/mo</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Coaching Tier</span>
                                <span>$${(profile.coachProfile?.pricing?.coachingTier || 2999) / 100}/mo</span>
                            </div>
                        </div>

                        ${!state.isOwnProfile ? `
                            <div class="mt-4 pt-4 border-t border-gray-700 space-y-2">
                                <button onclick="subscribeContent()" class="w-full bg-gray-700 text-white py-3 rounded-lg hover:bg-gray-600 font-bold">
                                    Subscribe to Content - $${(profile.coachProfile?.pricing?.contentTier || 999) / 100}/mo
                                </button>
                                <button onclick="applyCoaching()" class="w-full btn-primary text-white py-3 rounded-lg font-bold">
                                    Apply for Coaching - $${(profile.coachProfile?.pricing?.coachingTier || 2999) / 100}/mo
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Certifications -->
                    ${profile.coachProfile?.certifications?.length > 0 ? `
                        <div class="card p-4">
                            <h3 class="font-bold mb-3 flex items-center gap-2">
                                <i class="fas fa-certificate text-yellow-400"></i> Certifications
                            </h3>
                            <div class="space-y-2">
                                ${profile.coachProfile.certifications.map(cert => `
                                    <div class="flex items-center gap-3 p-2 bg-gray-800 rounded-lg">
                                        <i class="fas fa-award text-yellow-500"></i>
                                        <div>
                                            <p class="font-medium">${cert.name}</p>
                                            <p class="text-sm text-gray-500">${cert.issuingOrganization} · ${cert.year}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                ` : ''}

                <!-- Referral Code (for coach/influencer) -->
                ${(profile.userType === 'coach' || profile.userType === 'influencer') && state.isOwnProfile ? `
                    <div class="card p-4">
                        <h3 class="font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-share-alt text-indigo-400"></i> Your Referral Link
                        </h3>
                        <div class="flex gap-2">
                            <input type="text" value="${state.earnings?.referralLink || 'https://clockwork.fit?ref=' + (state.earnings?.referralCode || 'CODE')}"
                                   class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm" readonly>
                            <button onclick="copyReferralLink()" class="btn-primary text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Share this link to earn 10% commission on referrals!</p>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // ═══════════════════════════════════════════════════════════
    // REVENUE TAB (Owner Only)
    // ═══════════════════════════════════════════════════════════

    function renderRevenue() {
        const earnings = state.earnings || {
            balance: { available: 0, pending: 0 },
            lifetime: { total: 0, fromReferrals: 0, fromInfluencer: 0, fromCoaching: 0 },
            stats: { clicks: 0, signups: 0, conversions: 0 }
        };

        return `
            <div class="p-4 space-y-4">
                <!-- Balance Card -->
                <div class="card p-6 cw-gradient text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-white/80 text-sm">Available Balance</p>
                            <p class="text-4xl font-bold mt-1">$${(earnings.balance.available / 100).toFixed(2)}</p>
                            <p class="text-white/60 text-sm mt-2">Pending: $${(earnings.balance.pending / 100).toFixed(2)}</p>
                        </div>
                        <button onclick="requestPayout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-bold">
                            Withdraw
                        </button>
                    </div>
                </div>

                <!-- Revenue Breakdown -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="card p-4 text-center">
                        <i class="fas fa-share-alt text-blue-400 text-xl mb-2"></i>
                        <p class="text-lg font-bold">$${(earnings.lifetime.fromReferrals / 100).toFixed(0)}</p>
                        <p class="text-xs text-gray-500">Referrals</p>
                    </div>
                    <div class="card p-4 text-center">
                        <i class="fas fa-star text-purple-400 text-xl mb-2"></i>
                        <p class="text-lg font-bold">$${(earnings.lifetime.fromInfluencer / 100).toFixed(0)}</p>
                        <p class="text-xs text-gray-500">Influencer</p>
                    </div>
                    <div class="card p-4 text-center">
                        <i class="fas fa-user-graduate text-green-400 text-xl mb-2"></i>
                        <p class="text-lg font-bold">$${(earnings.lifetime.fromCoaching / 100).toFixed(0)}</p>
                        <p class="text-xs text-gray-500">Coaching</p>
                    </div>
                </div>

                <!-- Referral Stats -->
                <div class="card p-4">
                    <h3 class="font-bold mb-4">Referral Performance</h3>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-indigo-400">${formatNumber(earnings.stats.clicks)}</p>
                            <p class="text-xs text-gray-500">Link Clicks</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-400">${formatNumber(earnings.stats.signups)}</p>
                            <p class="text-xs text-gray-500">Signups</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-purple-400">${formatNumber(earnings.stats.conversions)}</p>
                            <p class="text-xs text-gray-500">Paid Conversions</p>
                        </div>
                    </div>
                </div>

                <!-- Referral Code -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3">Your Referral Code</h3>
                    <div class="bg-gray-800 rounded-lg p-4 text-center">
                        <p class="text-3xl font-mono font-bold text-indigo-400">${earnings.referralCode || 'LOADING'}</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="copyCode()" class="bg-gray-800 hover:bg-gray-700 py-2 rounded-lg text-sm">
                            <i class="fas fa-copy mr-1"></i> Copy Code
                        </button>
                        <button onclick="shareTwitter()" class="bg-blue-500 hover:bg-blue-600 py-2 rounded-lg text-sm">
                            <i class="fab fa-twitter mr-1"></i> Tweet
                        </button>
                        <button onclick="shareLink()" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded-lg text-sm">
                            <i class="fas fa-link mr-1"></i> Copy Link
                        </button>
                    </div>
                </div>

                <!-- View Full Dashboard -->
                ${state.user.userType === 'coach' ? `
                    <a href="/coaching-portal.html#revenue" class="block card p-4 text-center hover:border-indigo-500">
                        <i class="fas fa-chart-line text-indigo-400 mr-2"></i>
                        View Full Revenue Dashboard
                        <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                ` : ''}
            </div>
        `;
    }

    // ═══════════════════════════════════════════════════════════
    // UTILITY FUNCTIONS
    // ═══════════════════════════════════════════════════════════

    function setTab(tabId) {
        state.activeTab = tabId;
        render();
    }

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    function formatJoinDate(date) {
        return new Date(date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    function formatTimeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if (seconds < 60) return seconds + 's';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return minutes + 'm';
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return hours + 'h';
        const days = Math.floor(hours / 24);
        if (days < 7) return days + 'd';
        return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function updatePostText(text) {
        state.newPostText = text;
        render();
    }

    // ═══════════════════════════════════════════════════════════
    // API FUNCTIONS
    // ═══════════════════════════════════════════════════════════

    async function fetchProfile() {
        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/users/profile`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                state.user = data.data || data;
                state.profile = state.user;
                await loadProfileData();
            } else {
                localStorage.removeItem('token');
            }
        } catch (err) {
            console.error('Profile fetch error:', err);
        }
        state.loading = false;
        render();
    }

    async function loadProfileData() {
        try {
            const token = localStorage.getItem('token');
            const headers = { 'Authorization': `Bearer ${token}` };

            // Load posts, products, earnings in parallel
            const [postsRes, productsRes, earningsRes] = await Promise.all([
                fetch(`${API_BASE}/posts/user/${state.user._id}`, { headers }).catch(() => null),
                fetch(`${API_BASE}/products/user/${state.user._id}`, { headers }).catch(() => null),
                fetch(`${API_BASE}/earnings/summary`, { headers }).catch(() => null)
            ]);

            if (postsRes?.ok) {
                const data = await postsRes.json();
                state.posts = data.posts || data.data || [];
            }
            if (productsRes?.ok) {
                const data = await productsRes.json();
                state.products = data.products || data.data || [];
            }
            if (earningsRes?.ok) {
                const data = await earningsRes.json();
                state.earnings = data.data || data;
            }
        } catch (err) {
            console.error('Profile data load error:', err);
        }
    }

    async function submitPost() {
        if (!state.newPostText.trim()) return;

        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/posts`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: state.newPostText })
            });

            if (res.ok) {
                state.newPostText = '';
                await loadProfileData();
                render();
            }
        } catch (err) {
            console.error('Post error:', err);
        }
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/login.html';
    }

    // Placeholder functions
    function changeCover() { alert('Change cover - TODO'); }
    function changeAvatar() { alert('Change avatar - TODO'); }
    function editProfile() { alert('Edit profile - TODO'); }
    function followUser() { alert('Follow - TODO'); }
    function subscribeToCoach() { alert('Subscribe - TODO'); }
    function subscribeContent() { alert('Subscribe to content - TODO'); }
    function applyCoaching() { alert('Apply for coaching - TODO'); }
    function addMedia(type) { alert('Add ' + type + ' - TODO'); }
    function viewPost(id) { console.log('View post:', id); }
    function replyToPost(id) { alert('Reply - TODO'); }
    function repostPost(id) { alert('Repost - TODO'); }
    function likePost(id) { alert('Like - TODO'); }
    function sharePost(id) { alert('Share - TODO'); }
    function createProduct() { alert('Create product - TODO'); }
    function viewProduct(id) { alert('View product: ' + id); }
    function requestPayout() { alert('Request payout - TODO'); }
    function copyCode() { navigator.clipboard.writeText(state.earnings?.referralCode || ''); alert('Code copied!'); }
    function copyReferralLink() { navigator.clipboard.writeText(state.earnings?.referralLink || ''); alert('Link copied!'); }
    function shareTwitter() { window.open('https://twitter.com/intent/tweet?text=Join%20ClockWork!'); }
    function shareLink() { copyReferralLink(); }

    // ═══════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════

    fetchProfile();
    </script>
</body>
</html>
